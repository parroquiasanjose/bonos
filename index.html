<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parroquia San José Bono - Carga de Datos</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .screen { display: none; } /* Helper class to manage views */
        .active-screen { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Notification Styles */
        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateX(100%);
            animation: slideInAndOut 3s forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        @keyframes slideInAndOut {
            0% { opacity: 0; transform: translateX(100%); }
            15% { opacity: 1; transform: translateX(0); }
            85% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <div class="w-full max-w-lg relative">
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden">
            <div class="loader"></div>
        </div>

        <!-- 0. Login Screen -->
        <div id="loginScreen" class="screen p-8 space-y-4 bg-white rounded-xl shadow-lg text-center fade-in">
            <h1 class="text-3xl font-bold text-gray-800">Bienvenido</h1>
            <p class="text-gray-600">Coloque su clave para ingresar.</p>
            <form id="loginForm" class="space-y-4 pt-4">
                <input type="password" id="passwordInput" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Clave">
                <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Ingresar</button>
            </form>
        </div>

        <!-- 1. Initial Screen -->
        <div id="initialScreen" class="screen p-8 space-y-4 bg-white rounded-xl shadow-lg text-center fade-in">
            <h1 class="text-3xl font-bold text-gray-800">Parroquia San José Bono ⛪</h1>
            <p class="text-xl text-gray-600">"Sembradores de Esperanza"</p>
            <div id="authError" class="hidden p-4 my-4 text-sm text-red-700 bg-red-100 rounded-lg text-left"></div>
            <div id="mainButtons" class="space-y-4">
                <button id="goToFormButton" class="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                    Nueva Carga
                </button>
                <button id="goToHistoryButton" class="w-full px-4 py-3 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700">
                    Historial de Carga
                </button>
                <button id="goToSearchButton" class="w-full px-4 py-3 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700">
                    Buscar Bonos
                </button>
                <button id="goToWinnerButton" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">
                    Ganador
                </button>
                <button id="goToBankButton" class="w-full px-4 py-3 font-semibold text-white bg-cyan-600 rounded-lg hover:bg-cyan-700">
                    Banco
                </button>
                <button id="goToExpenseButton" class="w-full px-4 py-3 font-semibold text-white bg-red-500 rounded-lg hover:bg-red-600">
                    Egresos
                </button>
                <button id="goToBalanceButton" class="w-full px-4 py-3 font-semibold text-white bg-orange-600 rounded-lg hover:bg-orange-700">
                    Balance
                </button>
                 <button id="logoutButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cerrar Sesión</button>
            </div>
        </div>

        <!-- 2. Data Entry Form Screen -->
        <div id="formScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Cargar Datos del Bono</h2>
            <form id="dataForm" class="space-y-4">
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Números de Bonos</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-1/2">
                            <label for="bonoNro1" class="text-xs text-gray-500">Nro. 1</label>
                            <input type="number" id="bonoNro1" name="bonoNro1" required placeholder="000" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="w-1/2">
                            <label for="bonoNro2" class="text-xs text-gray-500">Nro. 2</label>
                            <input type="number" id="bonoNro2" name="bonoNro2" required placeholder="999" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre y Apellido</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Juan Pérez" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="tel" id="telefono" name="telefono" required placeholder="3772..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="tipoPago" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                    <select id="tipoPago" name="tipoPago" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div>
                    <label for="cuotas" class="block text-sm font-medium text-gray-700">Cuotas Abonadas</label>
                    <select id="cuotas" name="cuotas" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                <button type="submit" class="w-full px-4 py-3 mt-4 font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Revisar Datos</button>
                <button type="button" onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
            </form>
        </div>

        <!-- 3. Final Details Screen -->
        <div id="detailsScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 id="detailsTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center">Detalle de Carga</h2>
            <div id="detailsListContainer" class="mb-6 max-h-80 overflow-y-auto p-3 bg-gray-50 rounded-lg border"></div>
            <div id="summaryContainer" class="mb-6 p-4 bg-gray-100 rounded-lg space-y-2 text-lg"></div>
            <div id="detailsActions" class="space-y-3"></div>
        </div>
        
        <!-- 4. History Screen -->
        <div id="historyScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
             <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Historial de Cargas</h2>
             <div id="historyListContainer" class="mb-6 max-h-96 overflow-y-auto space-y-3"></div>
             <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700">Volver al Inicio</button>
        </div>

        <!-- 5. Winner Screen -->
        <div id="winnerScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Buscar Ganador</h2>
            <div class="space-y-6 mb-6">
                <!-- Prize 1 -->
                <div class="p-3 border rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">Primer Premio</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" data-prize="1er Premio" class="winner-input w-full text-center p-3 border rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                        <input type="number" data-prize="1er Premio" class="winner-input w-full text-center p-3 border rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                    </div>
                </div>
                <!-- Prize 2 -->
                <div class="p-3 border rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">2do Premio</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" data-prize="2do Premio" class="winner-input w-full text-center p-3 border rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                        <input type="number" data-prize="2do Premio" class="winner-input w-full text-center p-3 border rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                    </div>
                </div>
                <!-- Prize 3 -->
                <div class="p-3 border rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 mb-2">3er Premio</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" data-prize="3er Premio" class="winner-input w-full text-center p-3 border rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                        <input type="number" data-prize="3er Premio" class="winner-input w-full text-center p-3 border rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                    </div>
                </div>
            </div>
            <button id="findWinnerButton" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 mb-4">Buscar Ganadores</button>
            <div id="winnerResultContainer" class="p-4 bg-gray-50 rounded-lg border min-h-[100px]"></div>
            <button id="downloadWinnerPdfButton" class="hidden w-full mt-4 px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Descargar PDF de Ganadores</button>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>
        
        <!-- 6. Search Bono Screen -->
        <div id="searchScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Buscar Bono</h2>
            <div class="space-y-4 mb-6">
                <div class="flex items-center gap-4 mt-1">
                    <div class="w-1/2">
                        <label for="bonoSearchInput1" class="block text-sm font-medium text-gray-700">Desde Nro.</label>
                        <input type="number" id="bonoSearchInput1" placeholder="000" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                    </div>
                    <div class="w-1/2">
                        <label for="bonoSearchInput2" class="block text-sm font-medium text-gray-700">Hasta Nro.</label>
                        <input type="number" id="bonoSearchInput2" placeholder="999" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                    </div>
                </div>
                <p class="text-xs text-center text-gray-500">Puede buscar por un número o por el rango completo.</p>
                <button id="searchBonoButton" class="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Buscar</button>
            </div>
            <div id="searchResultContainer" class="p-4 bg-gray-50 rounded-lg border min-h-[100px] max-h-80 overflow-y-auto"></div>
            <button id="downloadSearchPdfButton" class="hidden w-full mt-4 px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Descargar PDF</button>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

        <!-- 7. Balance Screen -->
        <div id="balanceScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Balance General</h2>
            <div id="balanceListContainer" class="mb-6 max-h-80 overflow-y-auto p-3 bg-gray-50 rounded-lg border"></div>
            <div id="balanceSummaryContainer" class="mb-6 p-4 bg-gray-100 rounded-lg space-y-2 text-base"></div>
            <button id="downloadBalancePdfButton" class="w-full px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Descargar PDF</button>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>
        
        <!-- 8. Bank Screen -->
        <div id="bankScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Banco</h2>
            <form id="bankForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700" id="bankFormTitle">Nuevo Depósito</h3>
                <div>
                    <label for="bankDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="bankDate" name="bankDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" readonly>
                </div>
                <div>
                    <label for="bankAmount" class="block text-sm font-medium text-gray-700">Importe</label>
                    <input type="number" id="bankAmount" name="bankAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="bankType" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="bankType" name="bankType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="bankFormActions">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-cyan-600 rounded-lg hover:bg-cyan-700">Confirmar</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Depósitos Registrados</h3>
            <div id="bankDepositsListContainer" class="mb-6 space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

        <!-- 9. Expense Screen -->
        <div id="expenseScreen" class="screen p-8 bg-white rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Egresos</h2>
            <form id="expenseForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700" id="expenseFormTitle">Nuevo Egreso</h3>
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="expenseDate" name="expenseDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="expenseDescription" name="expenseDescription" required placeholder="Ej: Compra de insumos" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700">Importe</label>
                    <input type="number" id="expenseAmount" name="expenseAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                    <select id="expenseType" name="expenseType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="expenseFormActions">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Confirmar Egreso</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Egresos Registrados</h3>
            <div id="expenseListContainer" class="mb-6 space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

    </div>

    <!-- Modals -->
    <div id="dateConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white fade-in">
            <div class="text-center">
                <h3 id="dateConfirmTitle" class="text-2xl font-bold text-gray-900">Confirmar Fecha</h3>
                <div class="mt-4">
                    <label for="modalDateInput" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="modalDateInput" name="modalDateInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div class="mt-6 space-y-3">
                    <button id="confirmDateButton" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar</button>
                    <button id="cancelDateButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white fade-in">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900">Confirmar Información</h3>
                <div id="confirmationData" class="mt-4 text-left space-y-2 text-gray-700"></div>
                <div class="mt-6 space-y-3">
                    <button id="saveAndNewButton" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Guardar y Cargar Otro</button>
                    <button id="saveAndCloseButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar y Finalizar</button>
                    <button id="goBackButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center fade-in">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Eliminación</h3>
            <p class="text-sm text-gray-600 my-4">Esta operación no puede revertirse.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Volver</button>
                <button id="confirmDeleteButton" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, onSnapshot, query, writeBatch, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Initialization ---
        const { jsPDF } = window.jspdf;
        
        window.App = {
            // --- STATE ---
            state: {
                currentUser: null,
                currentSessionRecords: [],
                allSessions: [],
                bankDeposits: [],
                expenses: [],
                recordToEdit: null,
                depositToEditId: null,
                expenseToEditId: null,
                itemToDelete: { id: null, type: null },
                sessionToEditId: null,
                sessionToEditRawDate: null, 
                winnersData: [],
                searchResult: [], 
                db: null,
                auth: null,
                userId: null,
                unsubscribeHistory: null,
                unsubscribeBank: null,
                unsubscribeExpenses: null,
                showAllDeposits: false,
                showAllExpenses: false,
                datePromptType: null,
            },

            // --- INITIALIZATION ---
            async init() {
                this.cacheDOMElements();
                this.bindEvents();
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.login(savedUser);
                } else {
                    this.showScreen('loginScreen');
                }
                this.showLoading(true);
                await this.initializeFirebase();
            },

            cacheDOMElements() {
                this.dom = {
                    screens: document.querySelectorAll('.screen'),
                    loginForm: document.getElementById('loginForm'),
                    passwordInput: document.getElementById('passwordInput'),
                    dataForm: document.getElementById('dataForm'),
                    confirmModal: document.getElementById('confirmModal'),
                    deleteConfirmModal: document.getElementById('deleteConfirmModal'),
                    dateConfirmModal: document.getElementById('dateConfirmModal'),
                    dateConfirmTitle: document.getElementById('dateConfirmTitle'),
                    modalDateInput: document.getElementById('modalDateInput'),
                    confirmDateButton: document.getElementById('confirmDateButton'),
                    cancelDateButton: document.getElementById('cancelDateButton'),
                    formSuccessMessage: document.getElementById('formSuccessMessage'),
                    historyListContainer: document.getElementById('historyListContainer'),
                    detailsScreen: document.getElementById('detailsScreen'),
                    detailsListContainer: document.getElementById('detailsListContainer'),
                    summaryContainer: document.getElementById('summaryContainer'),
                    detailsActions: document.getElementById('detailsActions'),
                    detailsTitle: document.getElementById('detailsTitle'),
                    winnerResultContainer: document.getElementById('winnerResultContainer'),
                    downloadWinnerPdfButton: document.getElementById('downloadWinnerPdfButton'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    authError: document.getElementById('authError'),
                    mainButtons: document.getElementById('mainButtons'),
                    searchScreen: document.getElementById('searchScreen'),
                    searchBonoButton: document.getElementById('searchBonoButton'),
                    findWinnerButton: document.getElementById('findWinnerButton'),
                    searchResultContainer: document.getElementById('searchResultContainer'),
                    downloadSearchPdfButton: document.getElementById('downloadSearchPdfButton'),
                    balanceScreen: document.getElementById('balanceScreen'),
                    balanceListContainer: document.getElementById('balanceListContainer'),
                    balanceSummaryContainer: document.getElementById('balanceSummaryContainer'),
                    downloadBalancePdfButton: document.getElementById('downloadBalancePdfButton'),
                    goToBalanceButton: document.getElementById('goToBalanceButton'),
                    logoutButton: document.getElementById('logoutButton'),
                    bankScreen: document.getElementById('bankScreen'),
                    bankForm: document.getElementById('bankForm'),
                    bankFormTitle: document.getElementById('bankFormTitle'),
                    bankFormActions: document.getElementById('bankFormActions'),
                    bankDepositsListContainer: document.getElementById('bankDepositsListContainer'),
                    expenseScreen: document.getElementById('expenseScreen'),
                    expenseForm: document.getElementById('expenseForm'),
                    expenseFormTitle: document.getElementById('expenseFormTitle'),
                    expenseFormActions: document.getElementById('expenseFormActions'),
                    expenseListContainer: document.getElementById('expenseListContainer'),
                    toastContainer: document.getElementById('toastContainer'),
                    goToExpenseButton: document.getElementById('goToExpenseButton'),
                };
            },

            async initializeFirebase() {
                const firebaseConfig = {
                  apiKey: "AIzaSyAhV7Ri-DfYSQA_tgbDeSSGtpG74UNC10g",
                  authDomain: "bonosparroquia-30762.firebaseapp.com",
                  projectId: "bonosparroquia-30762",
                  storageBucket: "bonosparroquia-30762.appspot.com",
                  messagingSenderId: "24790926044",
                  appId: "1:24790926044:web:a4ee95475ba61c133baa19"
                };
                const app = initializeApp(firebaseConfig);
                this.state.db = getFirestore(app);
                this.state.auth = getAuth(app);

                try {
                    await enableIndexedDbPersistence(this.state.db);
                    console.log("Persistencia offline habilitada.");
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Múltiples pestañas abiertas, la persistencia offline solo se puede habilitar en una.");
                    } else if (err.code == 'unimplemented') {
                        console.warn("El navegador actual no soporta la persistencia offline.");
                    }
                }

                onAuthStateChanged(this.state.auth, (user) => {
                    if (user) {
                        this.state.userId = user.uid;
                        this.dom.authError.classList.add('hidden');
                        this.dom.mainButtons.classList.remove('hidden');
                        this.loadHistoryFromFirestore();
                        this.loadBankDepositsFromFirestore();
                        this.loadExpensesFromFirestore();
                    } else {
                        this.state.userId = null;
                        this.showLoading(false);
                    }
                });

                try {
                    await signInAnonymously(this.state.auth);
                } catch (error) {
                    this.showLoading(false);
                    if (error.code === 'auth/configuration-not-found') {
                        const errorMessage = `<h4 class="font-bold text-lg mb-2">Error de Configuración</h4><p>El inicio de sesión anónimo no está habilitado. Por favor, actívalo en la Consola de Firebase.</p>`;
                        this.dom.mainButtons.classList.add('hidden');
                        this.dom.authError.innerHTML = errorMessage;
                        this.dom.authError.classList.remove('hidden');
                    } else {
                        console.error("Error signing in anonymously:", error);
                        this.dom.authError.textContent = "Ocurrió un error inesperado al conectar.";
                        this.dom.authError.classList.remove('hidden');
                    }
                }
            },

            bindEvents() {
                this.dom.loginForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
                document.getElementById('goToFormButton').addEventListener('click', () => this.promptForDate('bono'));
                document.getElementById('goToHistoryButton').addEventListener('click', () => this.showHistoryScreen());
                document.getElementById('goToWinnerButton').addEventListener('click', () => this.showScreen('winnerScreen'));
                document.getElementById('goToSearchButton').addEventListener('click', () => this.showScreen('searchScreen'));
                document.getElementById('goToBankButton').addEventListener('click', () => this.promptForDate('banco'));
                this.dom.goToExpenseButton.addEventListener('click', () => this.showExpenseScreen());
                this.dom.goToBalanceButton.addEventListener('click', () => this.showBalanceScreen());
                this.dom.logoutButton.addEventListener('click', () => this.logout());
                this.dom.dataForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                document.getElementById('saveAndNewButton').addEventListener('click', () => this.handleSaveAndNew());
                document.getElementById('saveAndCloseButton').addEventListener('click', () => this.handleSaveAndFinish());
                document.getElementById('goBackButton').addEventListener('click', () => this.dom.confirmModal.classList.add('hidden'));
                document.getElementById('cancelDeleteButton').addEventListener('click', () => this.dom.deleteConfirmModal.classList.add('hidden'));
                document.getElementById('confirmDeleteButton').addEventListener('click', () => this.deleteItem());
                this.dom.findWinnerButton.addEventListener('click', () => this.findWinner());
                this.dom.downloadWinnerPdfButton.addEventListener('click', () => this.downloadWinnerPDF());
                this.dom.searchBonoButton.addEventListener('click', () => this.findBono());
                this.dom.downloadSearchPdfButton.addEventListener('click', () => this.downloadSearchPDF());
                this.dom.downloadBalancePdfButton.addEventListener('click', () => this.downloadBalancePDF());
                this.dom.bankForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleBankFormSubmit(); });
                this.dom.expenseForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleExpenseFormSubmit(); });
                this.dom.confirmDateButton.addEventListener('click', () => this.handleDateConfirm());
                this.dom.cancelDateButton.addEventListener('click', () => this.dom.dateConfirmModal.classList.add('hidden'));
            },

            handleLogin() {
                const password = this.dom.passwordInput.value.toLowerCase().trim();
                const validUsers = ['javier', 'ana', 'adan', 'jose'];
                if (validUsers.includes(password)) {
                    localStorage.setItem('currentUser', password);
                    this.login(password);
                    this.dom.passwordInput.value = '';
                } else {
                    this.showToast('Clave incorrecta.', 'error');
                }
            },

            login(userName) {
                this.state.currentUser = userName.toLowerCase();
                this.showScreen('initialScreen');
            },

            logout() {
                this.state.currentUser = null;
                localStorage.removeItem('currentUser');
                this.showScreen('loginScreen');
            },

            updateUIForUser() {
                const user = this.state.currentUser;
                const isAdmin = user === 'adan' || user === 'jose';
                this.dom.goToBalanceButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToExpenseButton.style.display = isAdmin ? 'block' : 'none';
            },

            loadHistoryFromFirestore() {
                if (this.state.unsubscribeHistory) this.state.unsubscribeHistory();
                const sessionsColRef = collection(this.state.db, "sessions");
                this.showLoading(true);
                this.state.unsubscribeHistory = onSnapshot(query(sessionsColRef), async (snapshot) => {
                    const sessionsPromises = snapshot.docs.map(async (docSnap) => {
                        const sessionDocData = docSnap.data();
                        const sessionData = { 
                            id: docSnap.id, 
                            records: [], 
                            rawDate: sessionDocData.rawDate 
                        };
                        const recordsColRef = collection(docSnap.ref, 'records');
                        const recordsSnapshot = await getDocs(recordsColRef);
                        sessionData.records = recordsSnapshot.docs.map(d => ({...d.data(), recordId: d.id}));
                        return sessionData;
                    });
                    this.state.allSessions = await Promise.all(sessionsPromises);
                    this.showLoading(false);
                    if (document.getElementById('historyScreen').classList.contains('active-screen')) {
                        this.showHistoryScreen();
                    }
                }, (error) => {
                    console.error("Error listening to history changes:", error);
                    this.showLoading(false);
                });
            },

            async saveSessionToFirestore() {
                if (this.state.currentSessionRecords.length === 0) return;
                this.showLoading(true);
                const rawDate = this.state.currentSessionRecords[0].fecha;
                const sessionId = this.formatDateForId(rawDate, true);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                const recordsColRef = collection(sessionDocRef, 'records');
                try {
                    const batch = writeBatch(this.state.db);
                    batch.set(sessionDocRef, { id: this.formatDateForId(rawDate), rawDate: rawDate, lastUpdated: new Date() }, { merge: true });
                    this.state.currentSessionRecords.forEach(record => {
                        const newRecordRef = doc(recordsColRef);
                        batch.set(newRecordRef, record);
                    });
                    await batch.commit();
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'new');
                    this.showToast('Carga finalizada y guardada con éxito.');
                } catch (error) {
                    console.error("Error saving session to Firestore: ", error);
                    this.showToast('Error al guardar la carga.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            showLoading(isLoading) {
                this.dom.loadingIndicator.classList.toggle('hidden', !isLoading);
            },

            showScreen(screenId) {
                this.dom.screens.forEach(s => s.classList.remove('active-screen'));
                document.getElementById(screenId).classList.add('active-screen');
                if (screenId === 'initialScreen') {
                    this.updateUIForUser();
                }
            },

            showHistoryScreen() {
                this.dom.historyListContainer.innerHTML = '';
                if (this.state.allSessions.length === 0) {
                    this.dom.historyListContainer.innerHTML = '<p class="text-center text-gray-500">No hay cargas guardadas.</p>';
                } else {
                    const sortedSessions = [...this.state.allSessions].sort((a, b) => (a.rawDate || this.parseIdToDate(a.id)).localeCompare(b.rawDate || this.parseIdToDate(b.id))).reverse();
                    sortedSessions.forEach(session => {
                        const displayId = session.id.replace(/-/g, '/');
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg border';
                        sessionDiv.innerHTML = `<span class="font-semibold text-gray-800">Carga del ${displayId}</span><div class="flex gap-2"><button onclick="App.editSession('${session.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${session.id}', 'session')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button><button onclick="App.downloadSessionPDF('${session.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">PDF</button></div>`;
                        this.dom.historyListContainer.appendChild(sessionDiv);
                    });
                }
                this.showScreen('historyScreen');
            },

            displayDetailsScreen(records, mode = 'new') {
                this.dom.detailsListContainer.innerHTML = '';
                this.dom.summaryContainer.innerHTML = '';
                if (!records || records.length === 0) {
                    this.dom.detailsListContainer.innerHTML = '<p class="text-center text-gray-500">No hay registros.</p>';
                    return;
                }
                let subtotal = 0, totalEfectivo = 0;
                records.forEach((data, index) => {
                    const monto = data.cuotas == 1 ? 15000 : 30000;
                    subtotal += monto;
                    if (data.tipoPago === 'Efectivo') totalEfectivo += monto;
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'p-3 mb-2 border rounded-md bg-white grid grid-cols-4 gap-2 items-center';
                    detailDiv.innerHTML = `<div class="col-span-3"><p class="font-bold text-indigo-700">${data.nombre}</p><p class="text-sm text-gray-600">Bonos: ${data.bonoNro1}-${data.bonoNro2} | ${data.tipoPago}</p></div><p class="col-span-1 text-right font-semibold text-gray-800">${this.formatCurrency(monto)}</p>${mode === 'edit' ? `<div class="col-span-4 text-right"><button onclick="App.deleteRecordFromSession(${index})" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Eliminar Registro</button></div>` : ''}`;
                    this.dom.detailsListContainer.appendChild(detailDiv);
                });
                this.dom.summaryContainer.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium text-gray-600">Subtotal:</span><span class="font-bold text-gray-900">${this.formatCurrency(subtotal)}</span></div><div class="flex justify-between items-center text-green-700"><span class="font-medium">Total (Efectivo):</span><span class="font-bold">${this.formatCurrency(totalEfectivo)}</span></div>`;
                if (mode === 'new') {
                    const rawDate = this.state.currentSessionRecords[0].fecha;
                    this.dom.detailsTitle.textContent = `Detalle de Carga - ${this.formatDateForId(rawDate)}`;
                    this.dom.detailsActions.innerHTML = `<button onclick="App.downloadSessionPDF(null)" class="w-full px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Descargar PDF</button><button onclick="App.promptForDate('bono')" class="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Nueva Carga</button><button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700">Volver al Inicio</button>`;
                } else if (mode === 'edit') {
                    this.dom.detailsTitle.textContent = `Modificando Carga del ${this.state.sessionToEditId.replace(/-/g, '/')}`;
                    this.dom.detailsActions.innerHTML = `<button onclick="App.saveModifiedSession()" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button><button onclick="App.showHistoryScreen()" class="w-full px-4 py-3 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700">Cancelar</button>`;
                }
                this.showScreen('detailsScreen');
            },

            startNewSession(fromFinish = false, date = null) {
                if (!fromFinish) this.state.currentSessionRecords = [];
                this.dom.dataForm.reset();
                const dateInput = document.getElementById('fecha');
                if (date) {
                    dateInput.value = date;
                } else {
                    dateInput.valueAsDate = new Date();
                }
                this.showScreen('formScreen');
            },
            
            handleFormSubmit(event) {
                event.preventDefault();
                const formData = new FormData(this.dom.dataForm);
                const newRecord = Object.fromEntries(formData.entries());

                const phoneRegex = /^\d{6,12}$/;
                if (!phoneRegex.test(newRecord.telefono)) {
                    this.showToast('Teléfono inválido (6-12 dígitos).', 'error');
                    return;
                }

                const newBono1 = parseInt(newRecord.bonoNro1, 10);
                const newBono2 = parseInt(newRecord.bonoNro2, 10);

                if (newBono1 > newBono2) {
                    this.showToast('El primer número del bono no puede ser mayor que el segundo.', 'error');
                    return;
                }

                let isOverlap = false;
                for (const session of this.state.allSessions) {
                    for (const record of session.records) {
                        const existingBono1 = parseInt(record.bonoNro1, 10);
                        const existingBono2 = parseInt(record.bonoNro2, 10);
                        if (Math.max(newBono1, existingBono1) <= Math.min(newBono2, existingBono2)) {
                            isOverlap = true;
                            this.showToast(`El rango de bonos se superpone con el de ${record.nombre}.`, 'error');
                            break;
                        }
                    }
                    if (isOverlap) break;
                }

                if (isOverlap) return;

                this.state.recordToEdit = newRecord;
                const monto = this.state.recordToEdit.cuotas == 1 ? 15000 : 30000;
                document.getElementById('confirmationData').innerHTML = `<p><strong>Nombre:</strong> ${this.state.recordToEdit.nombre}</p><p><strong>Bonos:</strong> Nro. ${this.state.recordToEdit.bonoNro1} - Nro. ${this.state.recordToEdit.bonoNro2}</p><p><strong>Monto:</strong> <span class="font-bold">${this.formatCurrency(monto)}</span></p>`;
                this.dom.confirmModal.classList.remove('hidden');
            },
            
            handleSaveAndNew() {
                this.state.currentSessionRecords.push(this.state.recordToEdit);
                this.dom.confirmModal.classList.add('hidden');
                this.showToast('Bono guardado.');
                const currentDate = document.getElementById('fecha').value;
                this.dom.dataForm.reset();
                document.getElementById('fecha').value = currentDate;
                document.getElementById('bonoNro1').focus();
            },

            handleSaveAndFinish() {
                this.state.currentSessionRecords.push(this.state.recordToEdit);
                this.dom.confirmModal.classList.add('hidden');
                this.saveSessionToFirestore();
            },

            editSession(sessionId) {
                this.state.sessionToEditId = sessionId;
                const session = this.state.allSessions.find(s => s.id === sessionId);
                if (session) {
                    this.state.sessionToEditRawDate = session.rawDate; 
                    this.state.currentSessionRecords = JSON.parse(JSON.stringify(session.records)); 
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                }
            },

            deleteRecordFromSession(index) {
                this.state.currentSessionRecords.splice(index, 1);
                this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
            },

            async saveModifiedSession() {
                this.showLoading(true);
                const sessionId = this.state.sessionToEditId;
                const rawDate = this.state.sessionToEditRawDate || this.parseIdToDate(sessionId);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                try {
                    const recordsColRef = collection(sessionDocRef, 'records');
                    const recordsSnapshot = await getDocs(recordsColRef);
                    const deleteBatch = writeBatch(this.state.db);
                    recordsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    if (this.state.currentSessionRecords.length > 0) {
                        const addBatch = writeBatch(this.state.db);
                        addBatch.set(sessionDocRef, { id: this.formatDateForId(rawDate), rawDate: rawDate, lastUpdated: new Date() }, { merge: true });
                        this.state.currentSessionRecords.forEach(record => {
                            const newRecordRef = doc(recordsColRef);
                            const recordData = { ...record };
                            delete recordData.recordId;
                            addBatch.set(newRecordRef, recordData);
                        });
                        await addBatch.commit();
                    } else {
                        await deleteDoc(sessionDocRef);
                    }
                    this.showToast('Cambios guardados con éxito.');
                } catch (error) {
                    console.error("Error modifying session: ", error);
                    this.showToast('Error al guardar los cambios.', 'error');
                } finally {
                    this.showLoading(false);
                    this.showHistoryScreen();
                }
            },

            promptDeleteItem(id, type) {
                this.state.itemToDelete = { id, type };
                this.dom.deleteConfirmModal.classList.remove('hidden');
            },

            async deleteItem() {
                const { id, type } = this.state.itemToDelete;
                if (!id || !type) return;

                this.showLoading(true);
                try {
                    if (type === 'session') {
                        const sessionDocRef = doc(this.state.db, "sessions", id);
                        const recordsColRef = collection(sessionDocRef, 'records');
                        const recordsSnapshot = await getDocs(recordsColRef);
                        const batch = writeBatch(this.state.db);
                        recordsSnapshot.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        await deleteDoc(sessionDocRef);
                    } else if (type === 'deposit') {
                        await deleteDoc(doc(this.state.db, "bank_deposits", id));
                    } else if (type === 'expense') {
                        await deleteDoc(doc(this.state.db, "expenses", id));
                    }
                    this.showToast('Registro eliminado correctamente.');
                } catch (error) {
                    console.error(`Error deleting ${type}:`, error);
                    this.showToast('Error al eliminar el registro.', 'error');
                } finally {
                    this.dom.deleteConfirmModal.classList.add('hidden');
                    this.showLoading(false);
                    this.state.itemToDelete = { id: null, type: null };
                }
            },

            findBono() {
                const searchInput1 = document.getElementById('bonoSearchInput1');
                const searchInput2 = document.getElementById('bonoSearchInput2');
                const number1 = parseInt(searchInput1.value, 10);
                const number2 = parseInt(searchInput2.value, 10) || number1;
                this.state.searchResult = [];
                this.dom.searchResultContainer.innerHTML = '';
                this.dom.downloadSearchPdfButton.classList.add('hidden');
                if (isNaN(number1)) {
                    this.dom.searchResultContainer.innerHTML = '<p class="text-center text-red-500">Por favor, ingrese un número en el primer campo.</p>';
                    return;
                }
                const foundRecords = [];
                for (const session of this.state.allSessions) {
                    for (const record of session.records) {
                        const recordNum1 = parseInt(record.bonoNro1, 10);
                        const recordNum2 = parseInt(record.bonoNro2, 10);
                        if (Math.max(number1, recordNum1) <= Math.min(number2, recordNum2)) {
                            foundRecords.push({ ...record, sessionDate: session.id.replace(/-/g, '/') });
                        }
                    }
                }
                this.state.searchResult = foundRecords;
                if (foundRecords.length > 0) {
                    this.dom.searchResultContainer.innerHTML = foundRecords.map(record => {
                        const monto = record.cuotas == 1 ? 15000 : 30000;
                        return `<div class="p-4 border rounded-md bg-blue-50 space-y-2 mb-2"><p><strong>Nombre:</strong> ${record.nombre}</p><p><strong>Teléfono:</strong> ${record.telefono}</p><p><strong>Bonos Comprados:</strong> ${record.bonoNro1} - ${record.bonoNro2}</p><p><strong>Fecha de Carga:</strong> ${record.sessionDate}</p><p><strong>Tipo de Pago:</strong> ${record.tipoPago}</p><p><strong>Cuotas Abonadas:</strong> ${record.cuotas}</p><p><strong>Monto:</strong> ${this.formatCurrency(monto)}</p></div>`;
                    }).join('');
                    this.dom.downloadSearchPdfButton.classList.remove('hidden');
                } else {
                    this.dom.searchResultContainer.innerHTML = '<p class="text-center text-gray-600">No se encontraron registros para los números ingresados.</p>';
                }
            },

            downloadSearchPDF() {
                if (this.state.searchResult.length === 0) return;
                const doc = new jsPDF();
                const searchInput1 = document.getElementById('bonoSearchInput1').value;
                const searchInput2 = document.getElementById('bonoSearchInput2').value;
                let title = "Detalle de Búsqueda de Bonos";
                if (searchInput1 && searchInput2) title = `Detalle de Bonos ${searchInput1} - ${searchInput2}`;
                else if (searchInput1) title = `Detalle de Bono N° ${searchInput1}`;
                const startY = this.addPdfHeader(doc, title);
                const tableColumn = ["Nombre", "Teléfono", "Bonos", "Fecha Carga", "Pago", "Cuotas", "Monto"];
                const tableRows = this.state.searchResult.map(record => {
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    return [record.nombre, record.telefono, `${record.bonoNro1} - ${record.bonoNro2}`, record.sessionDate, record.tipoPago, record.cuotas, this.formatCurrency(monto)];
                });
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: startY, theme: 'grid', headStyles: { fillColor: [67, 56, 202] } });
                const currentDate = this.getCurrentDateFormatted();
                doc.save(`busqueda_bonos_${currentDate}.pdf`);
            },

            findWinner() {
                const winnerInputs = document.querySelectorAll('.winner-input');
                this.state.winnersData = [];
                this.dom.winnerResultContainer.innerHTML = '';
                this.dom.downloadWinnerPdfButton.classList.add('hidden');
                const numbersToSearch = {};
                winnerInputs.forEach(input => {
                    const prize = input.dataset.prize;
                    const number = parseInt(input.value, 10);
                    if (!isNaN(number)) {
                        if (!numbersToSearch[prize]) numbersToSearch[prize] = [];
                        numbersToSearch[prize].push(number);
                    }
                });
                if (Object.keys(numbersToSearch).length === 0) {
                    this.dom.winnerResultContainer.innerHTML = '<p class="text-center text-red-500">Por favor, ingrese al menos un número ganador.</p>';
                    return;
                }
                const foundNumbers = new Set();
                for (const prizeLevel in numbersToSearch) {
                    for (const session of this.state.allSessions) {
                        for (const record of session.records) {
                            const from = parseInt(record.bonoNro1, 10);
                            const to = parseInt(record.bonoNro2, 10);
                            for (const num of numbersToSearch[prizeLevel]) {
                                if (num >= from && num <= to && !foundNumbers.has(num)) {
                                    this.state.winnersData.push({ ...record, winningNumber: num, sessionDate: session.id.replace(/-/g, '/'), prizeLevel });
                                    foundNumbers.add(num);
                                }
                            }
                        }
                    }
                }
                if (this.state.winnersData.length > 0) {
                    this.dom.winnerResultContainer.innerHTML = `<h3 class="text-xl font-bold text-green-600 text-center mb-4">¡Resultados del Sorteo!</h3><div class="space-y-3">${this.state.winnersData.map(winner => `<div class="p-3 border rounded-md bg-green-50"><p class="font-bold text-green-800">${winner.prizeLevel} - N° ${winner.winningNumber}</p><p><strong>Nombre:</strong> ${winner.nombre}</p><p><strong>Teléfono:</strong> ${winner.telefono}</p><p><strong>Bonos:</strong> ${winner.bonoNro1} - ${winner.bonoNro2}</p></div>`).join('')}</div>`;
                    this.dom.downloadWinnerPdfButton.classList.remove('hidden');
                } else {
                    this.dom.winnerResultContainer.innerHTML = '<p class="text-center text-gray-600">No se encontraron ganadores con los números ingresados.</p>';
                }
            },

            downloadWinnerPDF() {
                if (this.state.winnersData.length === 0) return;
                const doc = new jsPDF();
                const startY = this.addPdfHeader(doc, "Resultados del Sorteo");
                const tableColumn = ["Premio", "N° Ganador", "Nombre", "Teléfono", "Bonos Comprados"];
                const tableRows = this.state.winnersData.map(data => [data.prizeLevel, data.winningNumber, data.nombre, data.telefono, `${data.bonoNro1} - ${data.bonoNro2}`]);
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: startY, theme: 'grid', headStyles: { fillColor: [22, 163, 74] } });
                const currentDate = this.getCurrentDateFormatted();
                doc.save(`resultados_sorteo_${currentDate}.pdf`);
            },
            
            showBalanceScreen() {
                this.dom.balanceListContainer.innerHTML = '';
                this.dom.balanceSummaryContainer.innerHTML = '';
                let totalBonosEfectivo = 0, totalBonosTransferencia = 0, totalBonos = 0;
                let totalExpenses = 0;
                
                const allRecords = [];
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        allRecords.push({ ...record, sessionDate: session.id.replace(/-/g, '/') });
                    });
                });
                allRecords.sort((a, b) => (this.parseIdToDate(a.sessionDate)).localeCompare(this.parseIdToDate(b.sessionDate))).reverse();

                let balanceHTML = '<div><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-2">Ingresos por Bonos</h3>';
                if (allRecords.length === 0) {
                    balanceHTML += '<p class="text-center text-gray-500">No hay registros de bonos.</p>';
                } else {
                    allRecords.forEach(record => {
                        const monto = record.cuotas == 1 ? 15000 : 30000;
                        totalBonos += monto;
                        if (record.tipoPago === 'Efectivo') totalBonosEfectivo += monto;
                        else totalBonosTransferencia += monto;
                        balanceHTML += `<div class="p-3 mb-2 border rounded-md bg-white grid grid-cols-3 gap-2 items-center text-sm"><div><p class="font-semibold">${record.nombre}</p><p class="text-xs text-gray-500">${record.sessionDate}</p></div><p class="text-center">${record.tipoPago}</p><p class="text-right font-semibold">${this.formatCurrency(monto)}</p></div>`;
                    });
                }
                balanceHTML += '</div>';

                balanceHTML += '<div class="mt-6"><h3 class="text-lg font-semibold text-red-700 mb-2 border-b border-red-200 pb-2">Egresos</h3>';
                if (this.state.expenses.length === 0) {
                    balanceHTML += '<p class="text-center text-gray-500">No hay egresos registrados.</p>';
                } else {
                    this.state.expenses.forEach(expense => {
                        const monto = parseFloat(expense.amount);
                        totalExpenses += monto;
                        balanceHTML += `<div class="p-3 mb-2 border rounded-md bg-white grid grid-cols-3 gap-2 items-center text-sm"><div><p class="font-semibold">${expense.description}</p><p class="text-xs text-gray-500">${this.formatDateForId(expense.date)}</p></div><p class="text-center">${expense.type}</p><p class="text-right font-semibold text-red-600">-${this.formatCurrency(monto)}</p></div>`;
                    });
                }
                balanceHTML += '</div>';
                
                this.dom.balanceListContainer.innerHTML = balanceHTML;

                this.dom.balanceSummaryContainer.innerHTML = `
                    <div class="p-4 border rounded-lg bg-white mb-4">
                        <h4 class="font-bold text-lg mb-2 text-gray-800">Resumen de Ingresos (Bonos)</h4>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">Total Efectivo:</span><span class="font-bold text-green-700">${this.formatCurrency(totalBonosEfectivo)}</span></div>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">Total Transferencia:</span><span class="font-bold text-blue-700">${this.formatCurrency(totalBonosTransferencia)}</span></div>
                        <hr class="my-2 border-gray-200">
                        <div class="flex justify-between items-center text-lg"><span class="font-bold text-gray-800">Total Bonos:</span><span class="font-extrabold text-gray-900">${this.formatCurrency(totalBonos)}</span></div>
                    </div>
                     <div class="p-4 border rounded-lg bg-white mb-4">
                        <h4 class="font-bold text-lg mb-2 text-gray-800">Resumen de Egresos</h4>
                        <div class="flex justify-between items-center text-lg"><span class="font-bold text-gray-800">Total Egresos:</span><span class="font-extrabold text-red-600">-${this.formatCurrency(totalExpenses)}</span></div>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-800 text-white">
                        <h4 class="font-bold text-xl mb-2">Balance Final</h4>
                        <div class="flex justify-between items-center text-2xl"><span class="font-bold">TOTAL:</span><span class="font-extrabold">${this.formatCurrency(totalBonos - totalExpenses)}</span></div>
                    </div>
                `;
                this.showScreen('balanceScreen');
            },

            downloadBalancePDF() {
                const doc = new jsPDF();
                const startY = this.addPdfHeader(doc, "Balance General");
                
                let totalBonosEfectivo = 0, totalBonosTransferencia = 0, totalBonos = 0;
                let totalExpenses = 0;

                const bonoRecords = [];
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        bonoRecords.push({ ...record, sessionDate: session.id.replace(/-/g, '/') });
                    });
                });
                bonoRecords.sort((a, b) => (this.parseIdToDate(a.sessionDate)).localeCompare(this.parseIdToDate(b.sessionDate))).reverse();

                const bonoTableRows = bonoRecords.map(record => {
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    totalBonos += monto;
                    if (record.tipoPago === 'Efectivo') totalBonosEfectivo += monto;
                    else totalBonosTransferencia += monto;
                    return [record.sessionDate, record.nombre, `${record.bonoNro1}-${record.bonoNro2}`, record.tipoPago, this.formatCurrency(monto)];
                });
                
                doc.autoTable({
                    head: [["Fecha", "Nombre", "Bonos", "Tipo de Pago", "Monto"]],
                    body: bonoTableRows,
                    startY: startY,
                    theme: 'grid',
                    headStyles: { fillColor: [67, 56, 202] },
                    didDrawPage: (data) => {
                        doc.setFontSize(14);
                        doc.text('Ingresos por Bonos', data.settings.margin.left, data.cursor.y - 5);
                    }
                });

                const expenseTableRows = this.state.expenses.map(expense => {
                    const monto = parseFloat(expense.amount);
                    totalExpenses += monto;
                    return [this.formatDateForId(expense.date), expense.description, expense.type, `-${this.formatCurrency(monto)}`];
                });

                doc.autoTable({
                    head: [["Fecha", "Descripción", "Tipo de Pago", "Monto"]],
                    body: expenseTableRows,
                    startY: doc.autoTable.previous.finalY + 15,
                    theme: 'grid',
                    headStyles: { fillColor: [220, 38, 38] },
                     didDrawPage: (data) => {
                        doc.setFontSize(14);
                        doc.text('Egresos', data.settings.margin.left, doc.autoTable.previous.finalY + 13);
                    }
                });
                
                doc.autoTable({
                    startY: doc.autoTable.previous.finalY + 10,
                    theme: 'plain',
                    body: [
                        ['Resumen de Bonos', ''],
                        ['Total Efectivo (Bonos):', this.formatCurrency(totalBonosEfectivo)],
                        ['Total Transferencia (Bonos):', this.formatCurrency(totalBonosTransferencia)],
                        [{content: 'Total Bonos:', styles: {fontStyle: 'bold'}}, {content: this.formatCurrency(totalBonos), styles: {fontStyle: 'bold'}}],
                        ['', ''], // Spacer
                        ['Resumen de Egresos', ''],
                        [{content: 'Total Egresos:', styles: {fontStyle: 'bold'}}, {content: `-${this.formatCurrency(totalExpenses)}`, styles: {fontStyle: 'bold'}}],
                        ['', ''], // Spacer
                        [{content: 'Balance Final (Ingresos Bonos - Egresos):', styles: {fontStyle: 'bold', fontSize: 12}}, {content: this.formatCurrency(totalBonos - totalExpenses), styles: {fontStyle: 'bold', fontSize: 12}}],
                    ],
                    columnStyles: {
                        0: { halign: 'right', fontStyle: 'bold' },
                        1: { halign: 'right' }
                    }
                });

                const currentDate = this.getCurrentDateFormatted();
                doc.save(`balance_${currentDate}.pdf`);
            },

            formatCurrency(amount) {
                return amount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
            },

            getCurrentDateFormatted() {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                return `${day}-${month}-${year}`;
            },

            formatDateForId(dateString, useSafeFormat = false) {
                if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
                const [year, month, day] = dateString.split('-');
                const separator = useSafeFormat ? '-' : '/';
                return `${day}${separator}${month}${separator}${year}`;
            },

            parseIdToDate(idString) {
                if (!idString || !/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(idString)) return idString;
                const parts = idString.split(/[-\/]/);
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            },

            downloadSessionPDF(sessionId) {
                const recordsToPrint = sessionId ? this.state.allSessions.find(s => s.id === sessionId)?.records : this.state.currentSessionRecords;
                if (!recordsToPrint || recordsToPrint.length === 0) return;
                const doc = new jsPDF();
                let title, fileName;
                const currentDate = this.getCurrentDateFormatted();

                if (sessionId) {
                    const displayId = sessionId.replace(/-/g, '/');
                    title = `Detalle de Carga - ${displayId}`;
                    fileName = `cargas_de_bono_${currentDate}.pdf`;
                } else {
                    const rawDate = this.state.currentSessionRecords[0].fecha;
                    const formattedDate = this.formatDateForId(rawDate);
                    title = `Detalle de Carga - ${formattedDate}`;
                    fileName = `detalle_bonos_${this.formatDateForId(rawDate, true)}.pdf`;
                }
                
                const startY = this.addPdfHeader(doc, title);
                const tableColumn = ["Nombre", "Bonos", "Pago", "Cuotas", "Monto"];
                const tableRows = [];
                let subtotal = 0, totalEfectivo = 0;
                recordsToPrint.forEach(data => {
                    const monto = data.cuotas == 1 ? 15000 : 30000;
                    subtotal += monto;
                    if (data.tipoPago === 'Efectivo') totalEfectivo += monto;
                    tableRows.push([data.nombre, `${data.bonoNro1}-${data.bonoNro2}`, data.tipoPago, data.cuotas, this.formatCurrency(monto)]);
                });
                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: startY,
                    theme: 'grid',
                    headStyles: { fillColor: [107, 114, 128] },
                    foot: [
                        [{ content: 'Subtotal', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, { content: this.formatCurrency(subtotal), styles: { halign: 'right', fontStyle: 'bold' } }],
                        [{ content: 'Total (Efectivo)', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, { content: this.formatCurrency(totalEfectivo), styles: { halign: 'right', fontStyle: 'bold' } }],
                    ],
                    footStyles: { fontStyle: 'bold', fillColor: false }
                });
                doc.save(fileName);
            },
            
            // --- BANK & EXPENSE LOGIC ---
            showBankScreen(date = null) {
                this.state.showAllDeposits = false;
                this.dom.bankForm.reset();
                const dateInput = document.getElementById('bankDate');
                if (date) dateInput.value = date;
                else dateInput.valueAsDate = new Date();
                this.dom.bankFormTitle.textContent = 'Nuevo Depósito';
                this.dom.bankFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-cyan-600 rounded-lg hover:bg-cyan-700">Confirmar</button>`;
                this.state.depositToEditId = null;
                this.renderBankDeposits();
                this.showScreen('bankScreen');
            },

            loadBankDepositsFromFirestore() {
                if (this.state.unsubscribeBank) this.state.unsubscribeBank();
                const bankColRef = collection(this.state.db, "bank_deposits");
                this.state.unsubscribeBank = onSnapshot(query(bankColRef), (snapshot) => {
                    this.state.bankDeposits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.bankDeposits.sort((a, b) => b.date.localeCompare(a.date));
                    if (document.getElementById('bankScreen').classList.contains('active-screen')) {
                        this.renderBankDeposits();
                    }
                });
            },

            renderBankDeposits() {
                this.dom.bankDepositsListContainer.innerHTML = '';
                const deposits = this.state.bankDeposits;
                if (deposits.length === 0) {
                    this.dom.bankDepositsListContainer.innerHTML = '<p class="text-center text-gray-500">No hay depósitos registrados.</p>';
                    return;
                }
                const depositsToShow = this.state.showAllDeposits ? deposits : deposits.slice(0, 3);
                depositsToShow.forEach(deposit => {
                    const depositDiv = document.createElement('div');
                    depositDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    depositDiv.innerHTML = `<div><p class="font-semibold">Depósito - ${this.formatDateForId(deposit.date)}</p><p class="text-sm text-gray-600">${this.formatCurrency(parseFloat(deposit.amount))} (${deposit.type})</p></div><div class="flex gap-2"><button onclick="App.editBankDeposit('${deposit.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${deposit.id}', 'deposit')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button><button onclick="App.downloadDepositPDF('${deposit.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">PDF</button></div>`;
                    this.dom.bankDepositsListContainer.appendChild(depositDiv);
                }
                );
                if (!this.state.showAllDeposits && deposits.length > 3) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                    seeMoreButton.textContent = 'Ver más';
                    seeMoreButton.onclick = () => { this.state.showAllDeposits = true; this.renderBankDeposits(); };
                    this.dom.bankDepositsListContainer.appendChild(seeMoreButton);
                }
            },

            async handleBankFormSubmit() {
                const formData = new FormData(this.dom.bankForm);
                const depositData = { date: formData.get('bankDate'), amount: parseFloat(formData.get('bankAmount')), type: formData.get('bankType') };
                this.showLoading(true);
                try {
                    if (this.state.depositToEditId) {
                        await updateDoc(doc(this.state.db, "bank_deposits", this.state.depositToEditId), depositData);
                        this.showToast('Depósito modificado.');
                    } else {
                        await addDoc(collection(this.state.db, "bank_deposits"), depositData);
                        this.showToast('Depósito guardado.');
                    }
                    this.showBankScreen();
                } catch (error) {
                    console.error("Error saving bank deposit:", error);
                    this.showToast('Error al guardar depósito.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            editBankDeposit(depositId) {
                const deposit = this.state.bankDeposits.find(d => d.id === depositId);
                if (!deposit) return;
                this.state.depositToEditId = depositId;
                document.getElementById('bankDate').value = deposit.date;
                document.getElementById('bankAmount').value = deposit.amount;
                document.getElementById('bankType').value = deposit.type;
                this.dom.bankFormTitle.textContent = 'Modificar Depósito';
                this.dom.bankFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button><button type="button" onclick="App.showBankScreen()" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>`;
                window.scrollTo(0, 0);
            },

            downloadDepositPDF(depositId) {
                const deposit = this.state.bankDeposits.find(d => d.id === depositId);
                if (!deposit) return;
                const doc = new jsPDF();
                const startY = this.addPdfHeader(doc, "Detalle de Depósito");
                doc.autoTable({
                    head: [["Campo", "Valor"]],
                    body: [["Fecha", this.formatDateForId(deposit.date)], ["Importe", this.formatCurrency(parseFloat(deposit.amount))], ["Tipo", deposit.type]],
                    startY: startY, theme: 'grid', headStyles: { fillColor: [8, 145, 178] }
                });
                doc.save(`deposito_${deposit.id}.pdf`);
            },

            promptForDate(type) {
                this.state.datePromptType = type;
                this.dom.modalDateInput.valueAsDate = new Date();
                if (type === 'bono') this.dom.dateConfirmTitle.textContent = 'Confirmar Fecha de Carga';
                else if (type === 'banco') this.dom.dateConfirmTitle.textContent = 'Confirmar Fecha de Depósito';
                this.dom.dateConfirmModal.classList.remove('hidden');
            },

            handleDateConfirm() {
                const selectedDate = this.dom.modalDateInput.value;
                if (!selectedDate) {
                    this.showToast('Por favor, seleccione una fecha.', 'error');
                    return;
                }
                if (this.state.datePromptType === 'bono') this.startNewSession(false, selectedDate);
                else if (this.state.datePromptType === 'banco') this.showBankScreen(selectedDate);
                this.dom.dateConfirmModal.classList.add('hidden');
                this.state.datePromptType = null;
            },

            showExpenseScreen() {
                this.state.showAllExpenses = false;
                this.dom.expenseForm.reset();
                document.getElementById('expenseDate').valueAsDate = new Date();
                this.dom.expenseFormTitle.textContent = 'Nuevo Egreso';
                this.dom.expenseFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Confirmar Egreso</button>`;
                this.state.expenseToEditId = null;
                this.renderExpenses();
                this.showScreen('expenseScreen');
            },

            loadExpensesFromFirestore() {
                if (this.state.unsubscribeExpenses) this.state.unsubscribeExpenses();
                const expensesColRef = collection(this.state.db, "expenses");
                this.state.unsubscribeExpenses = onSnapshot(query(expensesColRef), (snapshot) => {
                    this.state.expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.expenses.sort((a, b) => b.date.localeCompare(a.date));
                    if (document.getElementById('expenseScreen').classList.contains('active-screen')) {
                        this.renderExpenses();
                    }
                });
            },

            renderExpenses() {
                this.dom.expenseListContainer.innerHTML = '';
                const expenses = this.state.expenses;
                if (expenses.length === 0) {
                    this.dom.expenseListContainer.innerHTML = '<p class="text-center text-gray-500">No hay egresos registrados.</p>';
                    return;
                }
                const expensesToShow = this.state.showAllExpenses ? expenses : expenses.slice(0, 3);
                expensesToShow.forEach(expense => {
                    const expenseDiv = document.createElement('div');
                    expenseDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    expenseDiv.innerHTML = `<div><p class="font-semibold">${expense.description}</p><p class="text-sm text-gray-600">${this.formatDateForId(expense.date)} - ${this.formatCurrency(parseFloat(expense.amount))} (${expense.type})</p></div><div class="flex gap-2"><button onclick="App.editExpense('${expense.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${expense.id}', 'expense')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button></div>`;
                    this.dom.expenseListContainer.appendChild(expenseDiv);
                });
                if (!this.state.showAllExpenses && expenses.length > 3) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                    seeMoreButton.textContent = 'Ver más';
                    seeMoreButton.onclick = () => { this.state.showAllExpenses = true; this.renderExpenses(); };
                    this.dom.expenseListContainer.appendChild(seeMoreButton);
                }
            },
            
            async handleExpenseFormSubmit() {
                const formData = new FormData(this.dom.expenseForm);
                const expenseData = {
                    date: formData.get('expenseDate'),
                    description: formData.get('expenseDescription'),
                    amount: parseFloat(formData.get('expenseAmount')),
                    type: formData.get('expenseType'),
                };
                this.showLoading(true);
                try {
                    if (this.state.expenseToEditId) {
                        await updateDoc(doc(this.state.db, "expenses", this.state.expenseToEditId), expenseData);
                        this.showToast('Egreso modificado.');
                    } else {
                        await addDoc(collection(this.state.db, "expenses"), expenseData);
                        this.showToast('Egreso guardado.');
                    }
                    this.showExpenseScreen();
                } catch (error) {
                    console.error("Error saving expense:", error);
                    this.showToast('Error al guardar el egreso.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            editExpense(expenseId) {
                const expense = this.state.expenses.find(e => e.id === expenseId);
                if (!expense) return;
                this.state.expenseToEditId = expenseId;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseType').value = expense.type;
                this.dom.expenseFormTitle.textContent = 'Modificar Egreso';
                this.dom.expenseFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button><button type="button" onclick="App.showExpenseScreen()" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>`;
                window.scrollTo(0, 0);
            },
            
            showToast(message, type = 'success') {
                const toastContainer = this.dom.toastContainer;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                // Play sound
                try {
                    const synth = new Tone.Synth().toDestination();
                    if (type === 'success') {
                        synth.triggerAttackRelease("C5", "8n", Tone.now());
                    } else if (type === 'error') {
                        synth.triggerAttackRelease("A3", "8n", Tone.now());
                    }
                } catch (e) {
                    console.warn("Could not play sound, user interaction might be required first.");
                }

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            addPdfHeader(doc, title) {
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text("Parroquia San José Bono", 15, 20);

                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(title, 15, 30);

                doc.setFontSize(10);
                doc.text(this.getCurrentDateFormatted(), doc.internal.pageSize.getWidth() - 15, 20, { align: 'right' });

                doc.setDrawColor(180, 180, 180);
                doc.line(15, 35, doc.internal.pageSize.getWidth() - 15, 35);

                return 45; // Return the start Y position for the table
            },
        };

        // Start the application
        window.App.init();

    </script>
</body>
</html>
