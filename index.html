<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parroquia San José Bono - Carga de Datos</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .screen { display: none; } /* Helper class to manage views */
        .active-screen { display: block; }
        .loader-container {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateX(100%);
            animation: slideInAndOut 3s forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        .toast-info { background-color: #2563eb; }
        @keyframes slideInAndOut {
            0% { opacity: 0; transform: translateX(100%); }
            15% { opacity: 1; transform: translateX(0); }
            85% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div id="toastContainer" class="toast-container"></div>

    <div class="w-full max-w-lg relative">
        <datalist id="vendedoresList"></datalist>
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loader-container hidden">
            <div class="loader"></div>
        </div>

        <!-- 0. Login Screen -->
        <div id="loginScreen" class="screen p-8 space-y-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg text-center fade-in">
            <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300">Bono "Sembradores de Esperanza"</h2>
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Bienvenido</h1>
            <p class="text-gray-600 dark:text-gray-400">Coloque su clave para ingresar.</p>
            <div class="pt-4 max-w-xs mx-auto">
                <form id="loginForm" class="space-y-4">
                    <input type="password" id="passwordInput" class="w-full text-center px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Clave">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Ingresar</button>
                </form>
            </div>
        </div>

        <!-- 1. Initial Screen -->
        <div id="initialScreen" class="screen p-8 space-y-4 bg-white dark:bg-gray-800 rounded-xl shadow-lg text-center fade-in">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">Parroquia San José Bono ⛪</h1>
            <p class="text-xl text-gray-600 dark:text-gray-400">"Sembradores de Esperanza"</p>
            
            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden my-4 p-4 border dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-900 text-left space-y-3">
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 text-center mb-2">Panel de Administrador</h3>
                <div>
                    <div class="flex justify-between items-center text-green-600">
                        <span class="font-semibold">Ingresos del Mes:</span>
                        <span id="monthlyIncome" class="font-bold text-lg"></span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center text-red-600">
                        <span class="font-semibold">Egresos del Mes:</span>
                        <span id="monthlyExpenses" class="font-bold text-lg"></span>
                    </div>
                </div>
                 <hr class="dark:border-gray-700">
                <div>
                    <div class="flex justify-between items-center text-gray-800 dark:text-gray-200">
                        <span class="font-semibold text-lg">Balance General:</span>
                        <span id="totalBalance" class="font-extrabold text-xl"></span>
                    </div>
                </div>
            </div>

            <div id="mainButtons" class="space-y-4">
                <button id="goToFormButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">
                    Nueva Carga
                </button>
                <button id="goToHistoryButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">
                    Historial de Carga
                </button>
                <button id="goToSearchButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-purple-500 to-purple-700 hover:from-purple-600 hover:to-purple-800 rounded-lg">
                    Buscar Bonos
                </button>
                <button id="goToWinnerButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">
                    Ganador
                </button>
                <button id="goToBankButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-cyan-500 to-cyan-700 hover:from-cyan-600 hover:to-cyan-800 rounded-lg">
                    Banco
                </button>
                <button id="goToExpenseButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">
                    Egresos
                </button>
                <button id="goToBalanceButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-orange-500 to-orange-700 hover:from-orange-600 hover:to-orange-800 rounded-lg">
                    Balance
                </button>
                 <button id="logoutButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cerrar Sesión</button>
            </div>
        </div>

        <!-- 2. Data Entry Form Screen -->
        <div id="formScreen" class="screen p-6 sm:p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
            <h2 id="formTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 text-center">Cargar Datos del Bono</h2>
            
            <form id="dataForm" class="space-y-4">
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" readonly>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vendedor</label>
                    <input type="text" id="vendedor" name="vendedor" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Nombre del Vendedor" list="vendedoresList">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Números de Bonos</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-1/2">
                            <label for="bonoNro1" class="text-xs text-gray-500 dark:text-gray-400">Nro. 1</label>
                            <input type="number" id="bonoNro1" name="bonoNro1" required placeholder="000" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="w-1/2">
                            <label for="bonoNro2" class="text-xs text-gray-500 dark:text-gray-400">Nro. 2</label>
                            <input type="number" id="bonoNro2" name="bonoNro2" required placeholder="999" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="nombre" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre y Apellido</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Juan Pérez" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Teléfono</label>
                    <input type="tel" id="telefono" name="telefono" required placeholder="3772..." class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="tipoPago" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Pago</label>
                    <select id="tipoPago" name="tipoPago" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div>
                    <label for="cuotas" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Cuotas Abonadas</label>
                    <select id="cuotas" name="cuotas" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>

                <div id="formActions" class="pt-4 grid grid-cols-2 gap-4"></div>
            </form>

            <hr class="my-6 border-gray-200 dark:border-gray-700">

            <div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">Resumen de Carga Actual</h3>
                <div id="liveSummaryContainer" class="space-y-3 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg border dark:border-gray-700 min-h-[210px]"></div>
                <div id="liveSummaryPagination" class="mt-4 flex justify-center items-center gap-4"></div>
                <div id="liveSummaryTotals" class="mt-4 text-right font-semibold text-gray-800 dark:text-gray-200"></div>
            </div>

            <hr class="my-6 border-gray-200 dark:border-gray-700">

            <div id="sessionActions" class="space-y-3">
                <button id="confirmAllButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Confirmar Carga de Bonos</button>
                <button id="clearAllButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Borrar Todo</button>
                <button id="goBackToInitialScreenButton" class="w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Volver</button>
            </div>
        </div>
        
        <!-- 4. History Screen -->
        <div id="historyScreen" class="screen p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
             <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">Historial de Cargas</h2>
             <div id="historyListContainer" class="mb-6 max-h-96 overflow-y-auto space-y-3"></div>
             <div id="historyLoadMoreContainer" class="mt-4"></div>
             <button id="historyGoBackButton" class="w-full mt-4 px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>
        </div>

        <!-- 5. Winner Screen -->
        <div id="winnerScreen" class="screen p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 text-center">Buscar Ganador</h2>
            <div class="space-y-6 mb-6">
                <div class="p-3 border dark:border-gray-700 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 dark:text-gray-300 mb-2">Primer Premio</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" data-prize="1er Premio" class="winner-input w-full text-center p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                        <input type="number" data-prize="1er Premio" class="winner-input w-full text-center p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                    </div>
                </div>
                <div class="p-3 border dark:border-gray-700 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 dark:text-gray-300 mb-2">2do Premio</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" data-prize="2do Premio" class="winner-input w-full text-center p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                        <input type="number" data-prize="2do Premio" class="winner-input w-full text-center p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                    </div>
                </div>
                <div class="p-3 border dark:border-gray-700 rounded-lg">
                    <h3 class="font-bold text-lg text-gray-700 dark:text-gray-300 mb-2">3er Premio</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" data-prize="3er Premio" class="winner-input w-full text-center p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                        <input type="number" data-prize="3er Premio" class="winner-input w-full text-center p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md" placeholder="000" oninput="this.value = this.value.slice(0, 3);">
                    </div>
                </div>
            </div>
            <button id="findWinnerButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg mb-4">Buscar Ganadores</button>
            <div id="winnerResultContainer" class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border dark:border-gray-700 min-h-[100px]"></div>
            <button id="downloadWinnerPdfButton" class="hidden w-full mt-4 px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Descargar PDF de Ganadores</button>
            <button id="winnerGoBackButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Volver al Inicio</button>
        </div>
        
        <!-- 6. Search Bono Screen -->
        <div id="searchScreen" class="screen p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 text-center">Buscar Bono</h2>
            <div class="space-y-4 mb-6">
                <div class="flex items-center gap-4 mt-1">
                    <div class="w-1/2">
                        <label for="bonoSearchInput1" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Desde Nro.</label>
                        <input type="number" id="bonoSearchInput1" placeholder="000" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                    </div>
                    <div class="w-1/2">
                        <label for="bonoSearchInput2" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Hasta Nro.</label>
                        <input type="number" id="bonoSearchInput2" placeholder="999" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                    </div>
                </div>
                <p class="text-xs text-center text-gray-500 dark:text-gray-400">Puede buscar por un número o por el rango completo.</p>
                <button id="searchBonoButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">Buscar</button>
            </div>
            <div id="searchResultContainer" class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border dark:border-gray-700 min-h-[100px] max-h-80 overflow-y-auto"></div>
            <button id="downloadSearchPdfButton" class="hidden w-full mt-4 px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Descargar PDF</button>
            <button id="searchGoBackButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Volver al Inicio</button>
        </div>

        <!-- 7. Balance Screen -->
        <div id="balanceScreen" class="screen p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">Balance General</h2>
            <div id="balanceListContainer" class="mb-6 max-h-80 overflow-y-auto p-3 bg-gray-50 dark:bg-gray-900 rounded-lg border dark:border-gray-700"></div>
            <div id="balanceSummaryContainer" class="mb-6 p-4 bg-gray-100 dark:bg-gray-900 rounded-lg space-y-2 text-base"></div>
            <button id="downloadBalancePdfButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Descargar PDF</button>
            <button id="balanceGoBackButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Volver al Inicio</button>
        </div>
        
        <!-- 8. Bank Screen -->
        <div id="bankScreen" class="screen p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 text-center">Gestión de Banco</h2>
            <form id="bankForm" class="space-y-4 mb-6 p-4 border dark:border-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300" id="bankFormTitle">Nuevo Depósito</h3>
                <div>
                    <label for="bankDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fecha</label>
                    <input type="date" id="bankDate" name="bankDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="bankAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Importe</label>
                    <input type="number" id="bankAmount" name="bankAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="bankType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo</label>
                    <select id="bankType" name="bankType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="bankFormActions" class="grid grid-cols-2 gap-4">
                     <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-cyan-500 to-cyan-700 hover:from-cyan-600 hover:to-cyan-800 rounded-lg">Confirmar</button>
                     <button type="button" id="cancelBankEditButton" class="hidden w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">Depósitos Registrados</h3>
            <div id="bankDepositsListContainer" class="mb-6 space-y-3 max-h-60 overflow-y-auto"></div>
            <button id="bankGoBackButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Volver al Inicio</button>
        </div>

        <!-- 9. Expense Screen -->
        <div id="expenseScreen" class="screen p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 text-center">Gestión de Egresos</h2>
            <form id="expenseForm" class="space-y-4 mb-6 p-4 border dark:border-gray-700 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300" id="expenseFormTitle">Nuevo Egreso</h3>
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fecha</label>
                    <input type="date" id="expenseDate" name="expenseDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripción</label>
                    <input type="text" id="expenseDescription" name="expenseDescription" required placeholder="Ej: Compra de insumos" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Importe</label>
                    <input type="number" id="expenseAmount" name="expenseAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo de Pago</label>
                    <select id="expenseType" name="expenseType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="expenseFormActions" class="grid grid-cols-2 gap-4">
                     <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Confirmar Egreso</button>
                     <button type="button" id="cancelExpenseEditButton" class="hidden w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 text-center">Egresos Registrados</h3>
            <div id="expenseListContainer" class="mb-6 space-y-3 max-h-60 overflow-y-auto"></div>
            <button id="expenseGoBackButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Volver al Inicio</button>
        </div>

    </div>

    <!-- Modals -->
    <div id="dateConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white dark:bg-gray-800 fade-in">
            <div class="text-center">
                <h3 id="dateConfirmTitle" class="text-2xl font-bold text-gray-900 dark:text-gray-200">Confirmar Fecha</h3>
                <div class="mt-4">
                    <label for="modalDateInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Fecha</label>
                    <input type="date" id="modalDateInput" name="modalDateInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div class="mt-6 space-y-3">
                    <button id="confirmDateButton" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar</button>
                    <button id="cancelDateButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmAllModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-white dark:bg-gray-800 fade-in">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-200">Confirmar Carga Final</h3>
                <div id="finalConfirmationData" class="mt-4 text-center space-y-2 text-gray-700 dark:text-gray-300"></div>
                <div class="mt-6 space-y-3">
                    <button id="saveAndFinishButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar y Guardar</button>
                    <button id="goBackToFormButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center fade-in">
            <h3 class="text-lg font-bold text-gray-900 dark:text-gray-200">Confirmar Eliminación</h3>
            <p id="deleteConfirmMessage" class="text-sm text-gray-600 dark:text-gray-400 my-4">Esta operación no puede revertirse.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Volver</button>
                <button id="confirmDeleteButton" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, deleteDoc, onSnapshot, query, writeBatch, updateDoc, enableIndexedDbPersistence, orderBy, limit, startAfter, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS & UTILS ---
        const { jsPDF } = window.jspdf;
        const Utils = {
            formatCurrency(amount) {
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount || 0);
            },
            getCurrentDateFormattedForInput() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            },
            formatDateForDisplay(dateString) {
                if (!dateString) return 'N/A';
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            },
        };

        // --- MODULE: UI ---
        const UI = {
            dom: {},
            init(app) {
                this.app = app;
                this.dom = app.dom;
            },
            showScreen(screenId) {
                this.dom.screens.forEach(s => s.classList.remove('active-screen'));
                document.getElementById(screenId)?.classList.add('active-screen');
            },
            showLoading(isLoading) {
                this.dom.loadingIndicator.classList.toggle('hidden', !isLoading);
            },
            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                this.dom.toastContainer.appendChild(toast);
                try {
                    const synth = new Tone.Synth().toDestination();
                    const note = type === 'success' ? "C5" : (type === 'error' ? "A3" : "E4");
                    synth.triggerAttackRelease(note, "8n", Tone.now());
                } catch (e) { console.warn("Could not play sound."); }
                setTimeout(() => toast.remove(), 3000);
            },
        };

        // --- MAIN APP OBJECT ---
        const App = {
            state: {
                currentUser: null,
                currentSessionRecords: [],
                allSessions: [],
                bankDeposits: [],
                expenses: [],
                recordToEditIndex: null,
                depositToEditId: null,
                expenseToEditId: null,
                itemToDelete: { id: null, type: null, index: null, subId: null },
                sessionToEditId: null,
                winnersData: [],
                searchResult: [], 
                db: null,
                auth: null,
                userId: null,
                appId: null, // <-- Added for correct paths
                unsubscribeBank: null,
                unsubscribeExpenses: null,
                unsubscribeSessions: null,
                liveSummaryPage: 1,
                recordsPerPage: 3,
                historyLastVisible: null,
                historyAllLoaded: false,
            },

            async init() {
                this.cacheDOMElements();
                UI.init(this);
                UI.showLoading(true);
                await this.initializeFirebase();
                this.bindEvents();
                
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.login(savedUser, true);
                } else {
                    this.showScreen('loginScreen');
                    UI.showLoading(false);
                }
            },
            
            showScreen(screenId) {
                UI.showScreen(screenId);
            },

            cacheDOMElements() {
                const ids = [
                    'loginScreen', 'passwordInput', 'loginForm', 'initialScreen', 'adminDashboard', 'monthlyIncome', 
                    'monthlyExpenses', 'totalBalance', 'mainButtons', 'goToFormButton', 'goToHistoryButton', 
                    'goToSearchButton', 'goToWinnerButton', 'goToBankButton', 'goToExpenseButton', 'goToBalanceButton', 
                    'logoutButton', 'formScreen', 'formTitle', 'dataForm', 'fecha', 'vendedor', 'bonoNro1', 'bonoNro2', 
                    'nombre', 'telefono', 'tipoPago', 'cuotas', 'formActions', 'liveSummaryContainer', 
                    'liveSummaryPagination', 'liveSummaryTotals', 'sessionActions', 'confirmAllButton', 'clearAllButton', 
                    'goBackToInitialScreenButton', 'historyScreen', 'historyListContainer', 
                    'historyLoadMoreContainer', 'winnerScreen', 'findWinnerButton', 'winnerResultContainer', 
                    'downloadWinnerPdfButton', 'searchScreen', 'bonoSearchInput1', 'bonoSearchInput2', 'searchBonoButton', 
                    'searchResultContainer', 'downloadSearchPdfButton', 'balanceScreen', 'balanceListContainer', 
                    'balanceSummaryContainer', 'downloadBalancePdfButton', 'bankScreen', 'bankForm', 'bankFormTitle', 
                    'bankDate', 'bankAmount', 'bankType', 'bankFormActions', 'bankDepositsListContainer', 'expenseScreen', 
                    'expenseForm', 'expenseFormTitle', 'expenseDate', 'expenseDescription', 'expenseAmount', 
                    'expenseType', 'expenseFormActions', 'expenseListContainer', 'toastContainer', 'loadingIndicator', 
                    'vendedoresList', 'dateConfirmModal', 'dateConfirmTitle', 'modalDateInput', 'confirmDateButton', 
                    'cancelDateButton', 'confirmAllModal', 'finalConfirmationData', 'saveAndFinishButton', 
                    'goBackToFormButton', 'deleteConfirmModal', 'deleteConfirmMessage', 'cancelDeleteButton', 
                    'confirmDeleteButton', 'historyGoBackButton', 'winnerGoBackButton', 'searchGoBackButton',
                    'balanceGoBackButton', 'bankGoBackButton', 'expenseGoBackButton', 'cancelBankEditButton', 'cancelExpenseEditButton'
                ];
                this.dom = {};
                ids.forEach(id => this.dom[id] = document.getElementById(id));
                this.dom.screens = document.querySelectorAll('.screen');
                this.dom.winnerInputs = document.querySelectorAll('.winner-input');
            },

            async initializeFirebase() {
                // These global variables are expected to be injected by the environment.
                this.state.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = typeof __firebase_config !== 'undefined' 
                    ? JSON.parse(__firebase_config)
                    : { // Fallback for local testing
                        apiKey: "AIzaSyAhV7Ri-DfYSQA_tgbDeSSGtpG74UNC10g",
                        authDomain: "bonosparroquia-30762.firebaseapp.com",
                        projectId: "bonosparroquia-30762",
                        storageBucket: "bonosparroquia-30762.appspot.com",
                        messagingSenderId: "24790926044",
                        appId: "1:24790926044:web:a4ee95475ba61c133baa19"
                    };

                const app = initializeApp(firebaseConfig);
                this.state.db = getFirestore(app);
                this.state.auth = getAuth(app);

                try {
                    await enableIndexedDbPersistence(this.state.db);
                } catch (err) {
                    console.warn("Firebase offline persistence error:", err.code);
                }

                onAuthStateChanged(this.state.auth, user => {
                    UI.showLoading(false);
                    if (user) {
                        this.state.userId = user.uid;
                        this.attachDataListeners();
                    } else {
                        this.detachDataListeners();
                        this.logout();
                    }
                });

                try {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                         await signInWithCustomToken(this.state.auth, token);
                    } else {
                         await signInAnonymously(this.state.auth);
                    }
                } catch (error) {
                    console.error("Firebase sign-in error:", error);
                    UI.showLoading(false);
                    UI.showToast('Error de autenticación con Firebase.', 'error');
                }
            },

            bindEvents() {
                // --- Navigation ---
                this.dom.loginForm.addEventListener('submit', (e) => { e.preventDefault(); this.login(this.dom.passwordInput.value); });
                this.dom.logoutButton.addEventListener('click', () => this.logout());
                this.dom.goToFormButton.addEventListener('click', () => this.promptForDate('bono'));
                this.dom.goToHistoryButton.addEventListener('click', () => this.showHistoryScreen());
                this.dom.goToSearchButton.addEventListener('click', () => this.showScreen('searchScreen'));
                this.dom.goToWinnerButton.addEventListener('click', () => this.showScreen('winnerScreen'));
                this.dom.goToBankButton.addEventListener('click', () => this.showBankScreen());
                this.dom.goToExpenseButton.addEventListener('click', () => this.showExpenseScreen());
                this.dom.goToBalanceButton.addEventListener('click', () => this.showBalanceScreen());
                
                // --- "Go Back" Buttons ---
                const backButtons = ['historyGoBackButton', 'winnerGoBackButton', 'searchGoBackButton', 'balanceGoBackButton', 'bankGoBackButton', 'expenseGoBackButton', 'goBackToInitialScreenButton'];
                backButtons.forEach(id => this.dom[id].addEventListener('click', () => this.showScreen('initialScreen')));

                // --- Form Screen ---
                this.dom.dataForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleAddOrUpdateRecord(); });
                this.dom.confirmAllButton.addEventListener('click', () => this.handleConfirmAll());
                this.dom.clearAllButton.addEventListener('click', () => this.handleClearAll());
                
                // --- Modals ---
                this.dom.confirmDateButton.addEventListener('click', () => this.handleDateConfirm());
                this.dom.cancelDateButton.addEventListener('click', () => this.dom.dateConfirmModal.classList.add('hidden'));
                this.dom.saveAndFinishButton.addEventListener('click', () => this.handleSaveAndFinish());
                this.dom.goBackToFormButton.addEventListener('click', () => this.dom.confirmAllModal.classList.add('hidden'));
                this.dom.confirmDeleteButton.addEventListener('click', () => this.deleteItem());
                this.dom.cancelDeleteButton.addEventListener('click', () => this.dom.deleteConfirmModal.classList.add('hidden'));

                // --- Feature Screens ---
                this.dom.findWinnerButton.addEventListener('click', () => this.findWinners());
                this.dom.searchBonoButton.addEventListener('click', () => this.searchBonos());
                this.dom.bankForm.addEventListener('submit', e => { e.preventDefault(); this.handleBankSubmit(); });
                this.dom.expenseForm.addEventListener('submit', e => { e.preventDefault(); this.handleExpenseSubmit(); });
                this.dom.cancelBankEditButton.addEventListener('click', () => this.cancelBankEdit());
                this.dom.cancelExpenseEditButton.addEventListener('click', () => this.cancelExpenseEdit());

                // --- PDF Downloads ---
                this.dom.downloadWinnerPdfButton.addEventListener('click', () => this.downloadWinnerPDF());
                this.dom.downloadSearchPdfButton.addEventListener('click', () => this.downloadSearchPDF());
                this.dom.downloadBalancePdfButton.addEventListener('click', () => this.downloadBalancePDF());
            },
            
            // AUTH & DATA LISTENERS
            login(password, isAutoLogin = false) {
                const key = password.toLowerCase().trim();
                const validUsers = {
                    'javier': 'user', 'ana': 'user', 
                    'adan': 'admin', 'jose': 'admin'
                };
                if (validUsers[key]) {
                    localStorage.setItem('currentUser', key);
                    this.state.currentUser = key;
                    this.dom.passwordInput.value = '';
                    this.showScreen('initialScreen');
                    this.updateUIForUser();
                    if (!isAutoLogin) UI.showToast(`Bienvenido ${key}!`, 'success');
                } else if (!isAutoLogin) {
                    UI.showToast('Clave incorrecta.', 'error');
                }
            },

            logout() {
                this.state.currentUser = null;
                localStorage.removeItem('currentUser');
                this.showScreen('loginScreen');
                this.detachDataListeners();
            },

            updateUIForUser() {
                const user = this.state.currentUser;
                const isAdmin = user === 'adan' || user === 'jose';
                const adminElements = ['goToBalanceButton', 'goToExpenseButton', 'adminDashboard', 'goToBankButton'];
                adminElements.forEach(id => this.dom[id].style.display = isAdmin ? 'block' : 'none');
                if (isAdmin) {
                    this.updateAdminDashboard();
                }
            },

            attachDataListeners() {
                if (!this.state.db || !this.state.appId) return;
                this.detachDataListeners(); // Prevent duplicates

                const basePath = `artifacts/${this.state.appId}/public/data`;

                const sessionsQuery = query(collection(this.state.db, `${basePath}/sessions`), orderBy("createdAt", "desc"));
                this.state.unsubscribeSessions = onSnapshot(sessionsQuery, (snapshot) => {
                    const sessionsPromises = snapshot.docs.map(async (docSnap) => {
                        const sessionData = { id: docSnap.id, ...docSnap.data(), records: [] };
                        const recordsSnapshot = await getDocs(collection(docSnap.ref, 'records'));
                        sessionData.records = recordsSnapshot.docs.map(d => ({ recordId: d.id, ...d.data() }));
                        return sessionData;
                    });
                    Promise.all(sessionsPromises).then(sessions => {
                        this.state.allSessions = sessions;
                        this.updateAdminDashboard();
                        this.populateVendedoresList();
                    });
                }, error => console.error("Session listener error:", error));

                const bankQuery = query(collection(this.state.db, `${basePath}/bank`), orderBy("date", "desc"));
                this.state.unsubscribeBank = onSnapshot(bankQuery, (snapshot) => {
                    this.state.bankDeposits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderBankList();
                    this.updateAdminDashboard();
                }, error => console.error("Bank listener error:", error));

                const expensesQuery = query(collection(this.state.db, `${basePath}/expenses`), orderBy("date", "desc"));
                this.state.unsubscribeExpenses = onSnapshot(expensesQuery, (snapshot) => {
                    this.state.expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.renderExpenseList();
                    this.updateAdminDashboard();
                }, error => console.error("Expense listener error:", error));
            },

            detachDataListeners() {
                if (this.state.unsubscribeSessions) this.state.unsubscribeSessions();
                if (this.state.unsubscribeBank) this.state.unsubscribeBank();
                if (this.state.unsubscribeExpenses) this.state.unsubscribeExpenses();
            },

            updateAdminDashboard() {
                if (!this.state.currentUser || (this.state.currentUser !== 'adan' && this.state.currentUser !== 'jose')) return;
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let monthlyIncome = 0;
                this.state.allSessions.forEach(session => {
                    const sessionDate = new Date(session.rawDate + 'T00:00:00');
                    if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
                        monthlyIncome += session.totalAmount;
                    }
                });

                const monthlyExpenses = this.state.expenses
                    .filter(exp => {
                        const expDate = new Date(exp.date + 'T00:00:00');
                        return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
                    })
                    .reduce((acc, exp) => acc + Number(exp.amount), 0);

                const totalIncome = this.state.allSessions.reduce((acc, s) => acc + s.totalAmount, 0);
                const totalExpenses = this.state.expenses.reduce((acc, e) => acc + Number(e.amount), 0);
                const totalBalance = totalIncome - totalExpenses;

                this.dom.monthlyIncome.textContent = Utils.formatCurrency(monthlyIncome);
                this.dom.monthlyExpenses.textContent = Utils.formatCurrency(monthlyExpenses);
                this.dom.totalBalance.textContent = Utils.formatCurrency(totalBalance);
                this.dom.totalBalance.style.color = totalBalance >= 0 ? '#16a34a' : '#dc2626';
            },
            
            populateVendedoresList() {
                const vendedores = new Set(this.state.allSessions.flatMap(s => s.records.map(r => r.vendedor)));
                this.dom.vendedoresList.innerHTML = '';
                vendedores.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v;
                    this.dom.vendedoresList.appendChild(option);
                });
            },

            // --- FORM WORKFLOW ---
            promptForDate(type) { 
                this.state.datePromptType = type;
                this.dom.modalDateInput.value = Utils.getCurrentDateFormattedForInput();
                this.dom.dateConfirmTitle.textContent = type === 'bono' ? 'Confirmar Fecha de Carga' : 'Confirmar Fecha';
                this.dom.dateConfirmModal.classList.remove('hidden');
            },

            handleDateConfirm() {
                const selectedDate = this.dom.modalDateInput.value;
                if (!selectedDate) {
                    UI.showToast('Por favor, seleccione una fecha.', 'error');
                    return;
                }
                if (this.state.datePromptType === 'bono') {
                    this.startNewSession(selectedDate);
                }
                this.dom.dateConfirmModal.classList.add('hidden');
                this.state.datePromptType = null;
            },

            startNewSession(date) {
                this.state.currentSessionRecords = [];
                this.state.recordToEditIndex = null;
                this.state.sessionToEditId = null;
                this.state.liveSummaryPage = 1;
                this.dom.dataForm.reset();
                this.dom.fecha.value = date;
                this.renderLiveSummary();
                this.setFormMode('add');
                this.showScreen('formScreen');
            },

            setFormMode(mode, clearVendedor = true) {
                const formActions = this.dom.formActions;
                if (mode === 'add') {
                    this.dom.formTitle.textContent = 'Cargar Datos del Bono';
                    formActions.innerHTML = `
                        <button type="submit" class="px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Cargar Otro</button>
                        <button type="button" id="clearFormFieldsButton" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Borrar</button>
                    `;
                    document.getElementById('clearFormFieldsButton').addEventListener('click', () => this.clearForm(true));
                    this.clearForm(clearVendedor);
                } else { // edit mode
                    this.dom.formTitle.textContent = 'Modificando Registro';
                    formActions.innerHTML = `
                        <button type="submit" class="px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Guardar Cambios</button>
                        <button type="button" id="cancelEditButton" class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                    `;
                    document.getElementById('cancelEditButton').addEventListener('click', () => this.cancelEdit());
                }
            },

            handleAddOrUpdateRecord() {
                const formData = new FormData(this.dom.dataForm);
                const record = Object.fromEntries(formData.entries());
                if (!record.bonoNro1 || !record.bonoNro2 || !record.nombre || !record.telefono) {
                    UI.showToast('Por favor, complete todos los campos requeridos.', 'error');
                    return;
                }
                if (!/^\d{6,14}$/.test(record.telefono.replace(/\s+/g, ''))) {
                    UI.showToast('Teléfono inválido (debe contener entre 6 y 14 dígitos).', 'error');
                    return;
                }
                
                if (this.state.recordToEditIndex !== null) {
                    this.state.currentSessionRecords[this.state.recordToEditIndex] = record;
                    UI.showToast('Registro modificado en el resumen.', 'info');
                    this.state.recordToEditIndex = null;
                    this.setFormMode('add', false);
                } else {
                    this.state.currentSessionRecords.push(record);
                    this.state.liveSummaryPage = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                    UI.showToast('Bono añadido al resumen.', 'success');
                    this.setFormMode('add', false);
                }
                this.renderLiveSummary();
            },
            
            clearForm(clearVendedor = true) {
                const currentDate = this.dom.fecha.value;
                const currentVendedor = this.dom.vendedor.value;
                this.dom.dataForm.reset();
                this.dom.fecha.value = currentDate;
                if (!clearVendedor) {
                    this.dom.vendedor.value = currentVendedor;
                }
                this.dom.bonoNro1.focus();
            },

            renderLiveSummary() {
                const container = this.dom.liveSummaryContainer;
                container.innerHTML = '';
                this.dom.liveSummaryPagination.innerHTML = '';
                let subtotal = 0, totalEfectivo = 0;

                if (this.state.currentSessionRecords.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Aún no hay bonos en esta carga.</p>';
                    this.dom.liveSummaryTotals.innerHTML = '';
                    return;
                }

                const page = this.state.liveSummaryPage;
                const recordsPerPage = this.state.recordsPerPage;
                const startIndex = (page - 1) * recordsPerPage;
                const paginatedRecords = this.state.currentSessionRecords.slice(startIndex, startIndex + recordsPerPage);

                paginatedRecords.forEach((record, index) => {
                    const originalIndex = startIndex + index;
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'p-3 border dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 grid grid-cols-[1fr_auto] gap-2 items-center';
                    recordDiv.innerHTML = `
                        <div>
                            <p class="font-bold text-indigo-700 dark:text-indigo-400">${record.nombre}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Bonos: ${record.bonoNro1}-${record.bonoNro2} | ${Utils.formatCurrency(monto)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-index="${originalIndex}" class="edit-summary-btn text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button>
                            <button data-index="${originalIndex}" class="delete-summary-btn text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Eliminar</button>
                        </div>`;
                    container.appendChild(recordDiv);
                });

                container.querySelectorAll('.edit-summary-btn').forEach(btn => btn.addEventListener('click', (e) => this.editRecordFromSummary(parseInt(e.target.dataset.index))));
                container.querySelectorAll('.delete-summary-btn').forEach(btn => btn.addEventListener('click', (e) => this.promptDeleteItem(null, 'summaryRecord', parseInt(e.target.dataset.index))));

                this.state.currentSessionRecords.forEach(record => {
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    subtotal += monto;
                    if (record.tipoPago === 'Efectivo') totalEfectivo += monto;
                });
                this.dom.liveSummaryTotals.innerHTML = `<p>Subtotal: <span class="font-bold">${Utils.formatCurrency(subtotal)}</span></p><p class="text-green-700 dark:text-green-400">Total Efectivo: <span class="font-bold">${Utils.formatCurrency(totalEfectivo)}</span></p>`;

                const totalPages = Math.ceil(this.state.currentSessionRecords.length / recordsPerPage);
                if (totalPages > 1) {
                    this.dom.liveSummaryPagination.innerHTML = `<button id="prevPageBtn" class="px-3 py-1 rounded-md bg-gray-200 dark:bg-gray-600" ${page === 1 ? 'disabled' : ''}>&lt;</button><span class="font-semibold text-gray-700 dark:text-gray-300">Página ${page} de ${totalPages}</span><button id="nextPageBtn" class="px-3 py-1 rounded-md bg-gray-200 dark:bg-gray-600" ${page === totalPages ? 'disabled' : ''}>&gt;</button>`;
                    document.getElementById('prevPageBtn').addEventListener('click', () => this.prevPage());
                    document.getElementById('nextPageBtn').addEventListener('click', () => this.nextPage());
                }
            },
            
            nextPage() {
                const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                if (this.state.liveSummaryPage < totalPages) {
                    this.state.liveSummaryPage++;
                    this.renderLiveSummary();
                }
            },

            prevPage() {
                if (this.state.liveSummaryPage > 1) {
                    this.state.liveSummaryPage--;
                    this.renderLiveSummary();
                }
            },

            editRecordFromSummary(index) {
                const record = this.state.currentSessionRecords[index];
                if (!record) return;
                this.state.recordToEditIndex = index;
                Object.keys(record).forEach(key => {
                    if(this.dom.dataForm.elements[key]) this.dom.dataForm.elements[key].value = record[key];
                });
                this.setFormMode('edit');
                window.scrollTo(0, 0);
            },

            cancelEdit() {
                this.state.recordToEditIndex = null;
                this.setFormMode('add', false);
            },

            handleConfirmAll() {
                if (this.state.currentSessionRecords.length === 0) {
                    UI.showToast('No hay bonos en el resumen para guardar.', 'error');
                    return;
                }
                let subtotal = this.state.currentSessionRecords.reduce((acc, r) => acc + (r.cuotas == 1 ? 15000 : 30000), 0);
                this.dom.finalConfirmationData.innerHTML = `<p>Vas a guardar una sesión con <strong>${this.state.currentSessionRecords.length} registros</strong>.</p><p>El monto total es de <strong>${Utils.formatCurrency(subtotal)}</strong>.</p><p class="mt-4">¿Estás seguro?</p>`;
                this.dom.confirmAllModal.classList.remove('hidden');
            },

            handleClearAll() {
                if (this.state.currentSessionRecords.length > 0) {
                    this.promptDeleteItem(null, 'clearAllSummary');
                } else {
                    UI.showToast('El resumen ya está vacío.', 'info');
                }
            },

            handleSaveAndFinish() {
                this.dom.confirmAllModal.classList.add('hidden');
                this.saveSessionToFirestore();
            },
            
            // --- HISTORY SCREEN ---
            async showHistoryScreen() {
                this.state.historyLastVisible = null;
                this.state.historyAllLoaded = false;
                this.dom.historyListContainer.innerHTML = '';
                this.dom.historyLoadMoreContainer.innerHTML = '';
                this.showScreen('historyScreen');
                await this.loadMoreHistory();
            },

            async loadMoreHistory() {
                if (this.state.historyAllLoaded) return;
                UI.showLoading(true);

                const basePath = `artifacts/${this.state.appId}/public/data`;
                const sessionsColRef = collection(this.state.db, `${basePath}/sessions`);
                const constraints = [orderBy("createdAt", "desc"), limit(10)];
                if (this.state.historyLastVisible) {
                    constraints.push(startAfter(this.state.historyLastVisible));
                }
                const q = query(sessionsColRef, ...constraints);
                
                try {
                    const snapshot = await getDocs(q);
                    UI.showLoading(false);

                    const newSessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    if (newSessions.length > 0) {
                        this.renderHistoryList(newSessions, true); // Append new sessions
                        this.state.historyLastVisible = snapshot.docs[snapshot.docs.length - 1];
                    }
                    
                    if (snapshot.empty || newSessions.length < 10) {
                        this.state.historyAllLoaded = true;
                        this.dom.historyLoadMoreContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Fin de los registros.</p>';
                    } else {
                        this.dom.historyLoadMoreContainer.innerHTML = '<button id="loadMoreHistoryBtn" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">Cargar Más</button>';
                        document.getElementById('loadMoreHistoryBtn').addEventListener('click', () => this.loadMoreHistory());
                    }
                } catch (error) {
                    console.error("Error loading history:", error);
                    UI.showToast('Error al cargar el historial.', 'error');
                    UI.showLoading(false);
                }
            },
            
            renderHistoryList(sessionsToRender, append = false) {
                if (!append) {
                    this.dom.historyListContainer.innerHTML = '';
                }
                if (this.dom.historyListContainer.innerHTML === '' && sessionsToRender.length === 0) {
                    this.dom.historyListContainer.innerHTML = '<p class="text-center text-gray-500">No hay cargas guardadas.</p>';
                    return;
                }
                
                sessionsToRender.forEach(session => {
                    const displayDate = Utils.formatDateForDisplay(session.rawDate);
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = 'flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600';
                    sessionDiv.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800 dark:text-gray-200">Carga del ${displayDate}</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400 block">${session.recordCount} bonos - ${Utils.formatCurrency(session.totalAmount)}</span>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${session.id}" class="edit-session-btn text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button>
                            <button data-id="${session.id}" class="delete-session-btn text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
                            <button data-id="${session.id}" class="pdf-session-btn text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">PDF</button>
                        </div>`;
                    this.dom.historyListContainer.appendChild(sessionDiv);
                });

                this.dom.historyListContainer.querySelectorAll('.edit-session-btn').forEach(btn => btn.addEventListener('click', (e) => this.editSession(e.target.dataset.id)));
                this.dom.historyListContainer.querySelectorAll('.delete-session-btn').forEach(btn => btn.addEventListener('click', (e) => this.promptDeleteItem(e.target.dataset.id, 'session')));
                this.dom.historyListContainer.querySelectorAll('.pdf-session-btn').forEach(btn => btn.addEventListener('click', (e) => this.downloadSessionPDF(e.target.dataset.id)));
            },

            editSession(sessionId) {
                const session = this.state.allSessions.find(s => s.id === sessionId);
                if (!session) {
                    UI.showToast('No se encontró la sesión para editar.', 'error');
                    return;
                }
                this.state.sessionToEditId = sessionId;
                this.state.currentSessionRecords = JSON.parse(JSON.stringify(session.records)); // Deep copy
                this.state.recordToEditIndex = null;
                this.state.liveSummaryPage = 1;
                this.dom.dataForm.reset();
                this.dom.fecha.value = session.rawDate;
                this.renderLiveSummary();
                this.setFormMode('add');
                this.showScreen('formScreen');
            },

            // --- BANK & EXPENSE SCREENS ---
            showBankScreen() {
                this.cancelBankEdit();
                this.dom.bankDate.value = Utils.getCurrentDateFormattedForInput();
                this.showScreen('bankScreen');
            },

            renderBankList() {
                const container = this.dom.bankDepositsListContainer;
                container.innerHTML = '';
                if(this.state.bankDeposits.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay depósitos registrados.</p>';
                    return;
                }
                this.state.bankDeposits.forEach(dep => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600';
                    itemDiv.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800 dark:text-gray-200">${Utils.formatCurrency(dep.amount)}</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400 block">${Utils.formatDateForDisplay(dep.date)} - ${dep.type}</span>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${dep.id}" class="edit-bank-btn text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Editar</button>
                            <button data-id="${dep.id}" class="delete-bank-btn text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Borrar</button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
                container.querySelectorAll('.edit-bank-btn').forEach(btn => btn.addEventListener('click', e => this.editBankDeposit(e.target.dataset.id)));
                container.querySelectorAll('.delete-bank-btn').forEach(btn => btn.addEventListener('click', e => this.promptDeleteItem(e.target.dataset.id, 'bank')));
            },
            
            async handleBankSubmit() {
                const formData = new FormData(this.dom.bankForm);
                const deposit = {
                    date: formData.get('bankDate'),
                    amount: Number(formData.get('bankAmount')),
                    type: formData.get('bankType'),
                };
                if (!deposit.date || !deposit.amount || deposit.amount <= 0) {
                    UI.showToast('Por favor, complete todos los campos del depósito.', 'error');
                    return;
                }
                UI.showLoading(true);
                const basePath = `artifacts/${this.state.appId}/public/data`;
                try {
                    if (this.state.depositToEditId) {
                        await updateDoc(doc(this.state.db, `${basePath}/bank`, this.state.depositToEditId), deposit);
                        UI.showToast('Depósito actualizado.', 'success');
                    } else {
                        await addDoc(collection(this.state.db, `${basePath}/bank`), deposit);
                        UI.showToast('Depósito guardado.', 'success');
                    }
                    this.cancelBankEdit();
                } catch (error) {
                    console.error("Error saving bank deposit:", error);
                    UI.showToast('Error al guardar el depósito.', 'error');
                } finally {
                    UI.showLoading(false);
                }
            },

            editBankDeposit(id) {
                const deposit = this.state.bankDeposits.find(d => d.id === id);
                if (!deposit) return;
                this.state.depositToEditId = id;
                this.dom.bankFormTitle.textContent = 'Modificar Depósito';
                this.dom.bankDate.value = deposit.date;
                this.dom.bankAmount.value = deposit.amount;
                this.dom.bankType.value = deposit.type;
                this.dom.cancelBankEditButton.classList.remove('hidden');
                this.dom.bankForm.querySelector('button[type="submit"]').textContent = 'Guardar Cambios';
            },

            cancelBankEdit() {
                this.state.depositToEditId = null;
                this.dom.bankForm.reset();
                this.dom.bankDate.value = Utils.getCurrentDateFormattedForInput();
                this.dom.bankFormTitle.textContent = 'Nuevo Depósito';
                this.dom.cancelBankEditButton.classList.add('hidden');
                this.dom.bankForm.querySelector('button[type="submit"]').textContent = 'Confirmar';
            },


            showExpenseScreen() {
                this.cancelExpenseEdit();
                this.dom.expenseDate.value = Utils.getCurrentDateFormattedForInput();
                this.showScreen('expenseScreen');
            },

            renderExpenseList() {
                const container = this.dom.expenseListContainer;
                container.innerHTML = '';
                if (this.state.expenses.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay egresos registrados.</p>';
                    return;
                }
                this.state.expenses.forEach(exp => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border dark:border-gray-600';
                    itemDiv.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800 dark:text-gray-200">${exp.description} - ${Utils.formatCurrency(exp.amount)}</span>
                            <span class="text-sm text-gray-500 dark:text-gray-400 block">${Utils.formatDateForDisplay(exp.date)} - ${exp.type}</span>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${exp.id}" class="edit-expense-btn text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Editar</button>
                            <button data-id="${exp.id}" class="delete-expense-btn text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Borrar</button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
                container.querySelectorAll('.edit-expense-btn').forEach(btn => btn.addEventListener('click', e => this.editExpense(e.target.dataset.id)));
                container.querySelectorAll('.delete-expense-btn').forEach(btn => btn.addEventListener('click', e => this.promptDeleteItem(e.target.dataset.id, 'expense')));
            },

            async handleExpenseSubmit() {
                const formData = new FormData(this.dom.expenseForm);
                const expense = {
                    date: formData.get('expenseDate'),
                    description: formData.get('expenseDescription'),
                    amount: Number(formData.get('expenseAmount')),
                    type: formData.get('expenseType'),
                };
                if (!expense.date || !expense.description || !expense.amount || expense.amount <= 0) {
                    UI.showToast('Por favor, complete todos los campos del egreso.', 'error');
                    return;
                }
                UI.showLoading(true);
                const basePath = `artifacts/${this.state.appId}/public/data`;
                try {
                    if (this.state.expenseToEditId) {
                        await updateDoc(doc(this.state.db, `${basePath}/expenses`, this.state.expenseToEditId), expense);
                        UI.showToast('Egreso actualizado.', 'success');
                    } else {
                        await addDoc(collection(this.state.db, `${basePath}/expenses`), expense);
                        UI.showToast('Egreso guardado.', 'success');
                    }
                    this.cancelExpenseEdit();
                } catch (error) {
                    console.error("Error saving expense:", error);
                    UI.showToast('Error al guardar el egreso.', 'error');
                } finally {
                    UI.showLoading(false);
                }
            },

            editExpense(id) {
                const expense = this.state.expenses.find(e => e.id === id);
                if (!expense) return;
                this.state.expenseToEditId = id;
                this.dom.expenseFormTitle.textContent = 'Modificar Egreso';
                this.dom.expenseDate.value = expense.date;
                this.dom.expenseDescription.value = expense.description;
                this.dom.expenseAmount.value = expense.amount;
                this.dom.expenseType.value = expense.type;
                this.dom.cancelExpenseEditButton.classList.remove('hidden');
                this.dom.expenseForm.querySelector('button[type="submit"]').textContent = 'Guardar Cambios';
            },

            cancelExpenseEdit() {
                this.state.expenseToEditId = null;
                this.dom.expenseForm.reset();
                this.dom.expenseDate.value = Utils.getCurrentDateFormattedForInput();
                this.dom.expenseFormTitle.textContent = 'Nuevo Egreso';
                this.dom.cancelExpenseEditButton.classList.add('hidden');
                this.dom.expenseForm.querySelector('button[type="submit"]').textContent = 'Confirmar Egreso';
            },


            // --- BALANCE SCREEN ---
            showBalanceScreen() {
                const container = this.dom.balanceListContainer;
                const summaryContainer = this.dom.balanceSummaryContainer;
                container.innerHTML = '';
                summaryContainer.innerHTML = '';

                let totalIngresos = 0;
                let totalEgresos = 0;
                const allTransactions = [];

                this.state.allSessions.forEach(session => {
                    const amount = session.totalAmount;
                    totalIngresos += amount;
                    allTransactions.push({ date: session.rawDate, description: `Carga de Bonos`, amount: amount, type: 'ingreso' });
                });

                this.state.expenses.forEach(expense => {
                    const amount = Number(expense.amount);
                    totalEgresos += amount;
                    allTransactions.push({ date: expense.date, description: expense.description, amount: -amount, type: 'egreso' });
                });
                
                // Sort transactions by date
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (allTransactions.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No hay transacciones para mostrar.</p>';
                } else {
                    allTransactions.forEach(t => {
                        const itemDiv = document.createElement('div');
                        const amountColor = t.type === 'ingreso' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                        itemDiv.className = 'flex justify-between items-center p-2 border-b dark:border-gray-700';
                        itemDiv.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800 dark:text-gray-200">${t.description}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${Utils.formatDateForDisplay(t.date)}</p>
                            </div>
                            <span class="font-bold ${amountColor}">${Utils.formatCurrency(t.amount)}</span>
                        `;
                        container.appendChild(itemDiv);
                    });
                }

                const balance = totalIngresos - totalEgresos;
                const balanceColor = balance >= 0 ? 'text-blue-600 dark:text-blue-400' : 'text-red-600 dark:text-red-400';
                summaryContainer.innerHTML = `
                    <div class="flex justify-between font-semibold text-green-600 dark:text-green-400"><span>Total Ingresos:</span><span>${Utils.formatCurrency(totalIngresos)}</span></div>
                    <div class="flex justify-between font-semibold text-red-600 dark:text-red-400"><span>Total Egresos:</span><span>${Utils.formatCurrency(totalEgresos)}</span></div>
                    <hr class="my-2 border-gray-300 dark:border-gray-600">
                    <div class="flex justify-between font-bold text-xl ${balanceColor}"><span>Balance Final:</span><span>${Utils.formatCurrency(balance)}</span></div>
                `;
                
                this.showScreen('balanceScreen');
            },


            // --- SEARCH & WINNER ---
            async findWinners() {
                UI.showLoading(true);
                const prizeInputs = Array.from(this.dom.winnerInputs);
                const numbersToFind = new Set();
                prizeInputs.forEach(input => {
                    if (input.value) numbersToFind.add(input.value.padStart(3, '0'));
                });

                if (numbersToFind.size === 0) {
                    UI.showToast('Ingrese al menos un número para buscar.', 'error');
                    UI.showLoading(false);
                    return;
                }

                this.state.winnersData = [];
                for (const session of this.state.allSessions) {
                    for (const record of session.records) {
                        if (numbersToFind.has(record.bonoNro1) || numbersToFind.has(record.bonoNro2)) {
                             this.state.winnersData.push({ ...record, sessionDate: session.rawDate });
                        }
                    }
                }
                
                UI.showLoading(false);
                this.renderWinnerResults();
            },

            renderWinnerResults() {
                const container = this.dom.winnerResultContainer;
                container.innerHTML = '';
                this.state.winnersData.sort((a,b) => a.bonoNro1 - b.bonoNro1);

                if (this.state.winnersData.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No se encontraron ganadores para los números ingresados.</p>';
                    this.dom.downloadWinnerPdfButton.classList.add('hidden');
                    return;
                }
                
                this.state.winnersData.forEach(record => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-3 border-b dark:border-gray-700';
                    resultDiv.innerHTML = `
                        <p class="font-bold text-lg text-indigo-700 dark:text-indigo-400">${record.nombre}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Tel: ${record.telefono}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Bonos: <span class="font-semibold">${record.bonoNro1} - ${record.bonoNro2}</span></p>
                        <p class="text-xs text-gray-500 dark:text-gray-500">Vendedor: ${record.vendedor} | Fecha: ${Utils.formatDateForDisplay(record.sessionDate)}</p>
                    `;
                    container.appendChild(resultDiv);
                });
                this.dom.downloadWinnerPdfButton.classList.remove('hidden');
            },

            async searchBonos() {
                UI.showLoading(true);
                const num1 = this.dom.bonoSearchInput1.value;
                const num2 = this.dom.bonoSearchInput2.value;

                if (!num1 && !num2) {
                    UI.showToast('Ingrese al menos un número para buscar.', 'error');
                    UI.showLoading(false);
                    return;
                }

                const startNum = parseInt(num1 || num2);
                const endNum = parseInt(num2 || num1);
                
                this.state.searchResult = [];
                for (const session of this.state.allSessions) {
                    for (const record of session.records) {
                        const bono1 = parseInt(record.bonoNro1);
                        const bono2 = parseInt(record.bonoNro2);
                        if ((bono1 >= startNum && bono1 <= endNum) || (bono2 >= startNum && bono2 <= endNum)) {
                             this.state.searchResult.push({ ...record, sessionDate: session.rawDate });
                        }
                    }
                }
                UI.showLoading(false);
                this.renderSearchResults();
            },

            renderSearchResults() {
                const container = this.dom.searchResultContainer;
                container.innerHTML = '';
                this.state.searchResult.sort((a,b) => a.bonoNro1 - b.bonoNro1);

                if (this.state.searchResult.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No se encontraron bonos en ese rango.</p>';
                    this.dom.downloadSearchPdfButton.classList.add('hidden');
                    return;
                }

                this.state.searchResult.forEach(record => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-3 border-b dark:border-gray-700';
                    resultDiv.innerHTML = `
                        <p class="font-bold text-indigo-700 dark:text-indigo-400">${record.nombre}</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Bonos: <span class="font-semibold">${record.bonoNro1} - ${record.bonoNro2}</span> | Tel: ${record.telefono}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-500">Vendedor: ${record.vendedor} | Fecha: ${Utils.formatDateForDisplay(record.sessionDate)}</p>
                    `;
                    container.appendChild(resultDiv);
                });
                this.dom.downloadSearchPdfButton.classList.remove('hidden');
            },

            // --- DELETION ---
            promptDeleteItem(id, type, index = null, subId = null) {
                this.state.itemToDelete = { id, type, index, subId };
                let message = '¿Seguro que quieres eliminar esto? Esta operación no puede revertirse.';
                if (type === 'summaryRecord') message = '¿Seguro que quieres eliminar este registro del resumen?';
                if (type === 'clearAllSummary') message = '¿Seguro que quieres borrar todos los registros del resumen actual?';
                if (type === 'session') message = '¿Seguro que quieres eliminar toda la carga de esta fecha? Se borrarán todos sus registros.';
                if (type === 'bank') message = '¿Seguro que quieres eliminar este depósito?';
                if (type === 'expense') message = '¿Seguro que quieres eliminar este egreso?';
                
                this.dom.deleteConfirmMessage.textContent = message;
                this.dom.deleteConfirmModal.classList.remove('hidden');
            },

            async deleteItem() {
                const { id, type, index } = this.state.itemToDelete;
                this.dom.deleteConfirmModal.classList.add('hidden');
                UI.showLoading(true);
                const basePath = `artifacts/${this.state.appId}/public/data`;

                try {
                    switch (type) {
                        case 'summaryRecord':
                            this.state.currentSessionRecords.splice(index, 1);
                            const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                            if (this.state.liveSummaryPage > totalPages) {
                                this.state.liveSummaryPage = totalPages > 0 ? totalPages : 1;
                            }
                            this.renderLiveSummary();
                            UI.showToast('Registro eliminado del resumen.', 'info');
                            break;
                        case 'clearAllSummary':
                            this.state.currentSessionRecords = [];
                            this.state.liveSummaryPage = 1;
                            this.renderLiveSummary();
                            UI.showToast('Resumen de carga borrado.', 'info');
                            break;
                        case 'session':
                            const sessionRef = doc(this.state.db, `${basePath}/sessions`, id);
                            const recordsSnapshot = await getDocs(collection(sessionRef, 'records'));
                            const batch = writeBatch(this.state.db);
                            recordsSnapshot.forEach(recordDoc => batch.delete(recordDoc.ref));
                            batch.delete(sessionRef);
                            await batch.commit();
                            this.showHistoryScreen(); // Refresh history
                            UI.showToast('Sesión eliminada correctamente.', 'success');
                            break;
                        case 'bank':
                            await deleteDoc(doc(this.state.db, `${basePath}/bank`, id));
                            UI.showToast('Depósito eliminado.', 'success');
                            break;
                        case 'expense':
                            await deleteDoc(doc(this.state.db, `${basePath}/expenses`, id));
                            UI.showToast('Egreso eliminado.', 'success');
                            break;
                    }
                } catch (error) {
                    console.error(`Error deleting ${type}:`, error);
                    UI.showToast(`Error al eliminar.`, 'error');
                } finally {
                    this.state.itemToDelete = { id: null, type: null, index: null, subId: null };
                    UI.showLoading(false);
                }
            },
            
            // --- FIRESTORE SAVING ---
            async saveSessionToFirestore() {
                UI.showLoading(true);
                const recordsToSave = this.state.currentSessionRecords;
                const rawDate = this.dom.fecha.value;
                const totalAmount = recordsToSave.reduce((acc, r) => acc + (r.cuotas == 1 ? 15000 : 30000), 0);
                const totalCash = recordsToSave.filter(r => r.tipoPago === 'Efectivo').reduce((acc, r) => acc + (r.cuotas == 1 ? 15000 : 30000), 0);

                const sessionData = {
                    rawDate: rawDate,
                    totalAmount: totalAmount,
                    totalCash: totalCash,
                    recordCount: recordsToSave.length,
                    user: this.state.currentUser,
                    createdAt: serverTimestamp()
                };
                
                const basePath = `artifacts/${this.state.appId}/public/data`;

                try {
                    const batch = writeBatch(this.state.db);
                    let sessionRef;

                    if (this.state.sessionToEditId) {
                        // UPDATE existing session
                        sessionRef = doc(this.state.db, `${basePath}/sessions`, this.state.sessionToEditId);
                        batch.update(sessionRef, sessionData);

                        // Delete old records first
                        const oldRecordsSnapshot = await getDocs(collection(sessionRef, 'records'));
                        oldRecordsSnapshot.forEach(recordDoc => batch.delete(recordDoc.ref));
                    } else {
                        // ADD new session
                        sessionRef = doc(collection(this.state.db, `${basePath}/sessions`));
                        batch.set(sessionRef, sessionData);
                    }
                    
                    // Add new/updated records
                    recordsToSave.forEach(record => {
                        const recordRef = doc(collection(sessionRef, 'records'));
                        batch.set(recordRef, record);
                    });

                    await batch.commit();
                    UI.showToast('Carga guardada con éxito!', 'success');
                    this.showScreen('initialScreen');
                    this.state.currentSessionRecords = [];
                    this.state.sessionToEditId = null;

                } catch (error) {
                    console.error("Error saving session:", error);
                    UI.showToast('Error al guardar la carga.', 'error');
                } finally {
                    UI.showLoading(false);
                }
            },

            // --- PDF GENERATION ---
            generatePdf(title, head, body, filename) {
                try {
                    const doc = new jsPDF();
                    doc.text(title, 14, 16);
                    doc.setFontSize(10);
                    doc.text(`Generado: ${new Date().toLocaleString('es-AR')}`, 14, 22);
                    
                    doc.autoTable({
                        head: head,
                        body: body,
                        startY: 28,
                        theme: 'grid',
                        headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                        styles: { fontSize: 8 },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                    });
                    doc.save(`${filename}_${Utils.getCurrentDateFormattedForInput()}.pdf`);
                    UI.showToast('PDF generado.', 'success');
                } catch (error) {
                    console.error("PDF Generation Error:", error);
                    UI.showToast('Error al generar el PDF.', 'error');
                }
            },

            downloadSessionPDF(sessionId) {
                const session = this.state.allSessions.find(s => s.id === sessionId);
                if (!session) return;
                
                const title = `Detalle de Carga - ${Utils.formatDateForDisplay(session.rawDate)}`;
                const head = [['Nro Bono 1', 'Nro Bono 2', 'Nombre', 'Teléfono', 'Vendedor', 'Cuotas', 'Tipo Pago', 'Monto']];
                const body = session.records.map(r => [
                    r.bonoNro1, r.bonoNro2, r.nombre, r.telefono, r.vendedor, r.cuotas, r.tipoPago,
                    Utils.formatCurrency(r.cuotas == 1 ? 15000 : 30000)
                ]);
                body.push(['', '', '', '', '', '', 'TOTAL:', Utils.formatCurrency(session.totalAmount)]);

                this.generatePdf(title, head, body, 'carga_bonos');
            },

            downloadWinnerPDF() {
                const title = 'Lista de Ganadores';
                const head = [['Nro Bono 1', 'Nro Bono 2', 'Nombre', 'Teléfono', 'Vendedor']];
                const body = this.state.winnersData.map(r => [r.bonoNro1, r.bonoNro2, r.nombre, r.telefono, r.vendedor]);
                this.generatePdf(title, head, body, 'ganadores');
            },

            downloadSearchPDF() {
                const title = `Resultados de Búsqueda de Bonos`;
                const head = [['Nro Bono 1', 'Nro Bono 2', 'Nombre', 'Teléfono', 'Vendedor']];
                const body = this.state.searchResult.map(r => [r.bonoNro1, r.bonoNro2, r.nombre, r.telefono, r.vendedor]);
                this.generatePdf(title, head, body, 'busqueda_bonos');
            },

            downloadBalancePDF() {
                const totalIngresos = this.state.allSessions.reduce((acc, s) => acc + s.totalAmount, 0);
                const totalEgresos = this.state.expenses.reduce((acc, e) => acc + Number(e.amount), 0);
                const balance = totalIngresos - totalEgresos;

                const title = 'Balance General';
                const head = [['Fecha', 'Descripción', 'Ingreso', 'Egreso']];
                const allTransactions = [];
                this.state.allSessions.forEach(session => allTransactions.push({ date: session.rawDate, description: `Carga de Bonos`, amount: session.totalAmount, type: 'ingreso' }));
                this.state.expenses.forEach(expense => allTransactions.push({ date: expense.date, description: expense.description, amount: Number(expense.amount), type: 'egreso' }));
                allTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

                const body = allTransactions.map(t => [
                    Utils.formatDateForDisplay(t.date),
                    t.description,
                    t.type === 'ingreso' ? Utils.formatCurrency(t.amount) : '',
                    t.type === 'egreso' ? Utils.formatCurrency(t.amount) : ''
                ]);

                // Add summary rows
                body.push(['', 'TOTAL INGRESOS', Utils.formatCurrency(totalIngresos), '']);
                body.push(['', 'TOTAL EGRESOS', '', Utils.formatCurrency(totalEgresos)]);
                body.push(['', 'BALANCE FINAL', Utils.formatCurrency(balance), '']);

                this.generatePdf(title, head, body, 'balance_general');
            }
        };

        // Start the application
        window.App = App;
        window.App.init();

    </script>
</body>
</html>
