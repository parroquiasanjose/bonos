<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parroquia San José Bono - Carga de Datos</title>
    <!-- Favicon con el logo de la parroquia -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/vTQjffhK/NUEVO-LOGO.png">
    <!-- Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF para la generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Tone.js para efectos de sonido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Ocultar flechas en inputs numéricos */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .screen { display: none; } /* Clase de ayuda para gestionar las vistas */
        #loginScreen.active-screen { display: flex; } /* Regla específica para usar flexbox en la pantalla de inicio de sesión */
        .active-screen { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para notificaciones "Toast" */
        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateX(100%);
            animation: slideInAndOut 3s forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        @keyframes slideInAndOut {
            0% { opacity: 0; transform: translateX(100%); }
            15% { opacity: 1; transform: translateX(0); }
            85% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <div class="w-full max-w-lg relative">
        <datalist id="vendedoresList"></datalist>
        <!-- Indicador de Carga -->
        <div id="loadingIndicator" class="hidden">
            <div class="loader"></div>
        </div>

        <!-- 0. Pantalla de Inicio de Sesión -->
        <div id="loginScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in flex-col items-center justify-center active-screen">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Bono "Sembradores de Esperanza"</h2>
            <h1 class="text-3xl font-bold text-gray-800 mb-1 text-center">Bienvenido</h1>
            <p class="text-gray-600 mb-6 text-center">Ingrese sus credenciales para continuar.</p>
            <div class="w-full max-w-xs">
                <form id="loginForm" class="space-y-4">
                    <input type="email" id="emailInput" class="w-full text-center px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Correo Electrónico" required>
                    <div class="relative">
                        <input type="password" id="passwordInput" class="w-full text-center px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Contraseña" required>
                        <button type="button" id="passwordToggle" aria-label="Toggle password visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                            <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.673.126 2.463.362m-7.916 5.242a3 3 0 014.242-4.242m-4.242 4.242L6 18m12-6h.008M18 6l-6 6" />
                            </svg>
                        </button>
                    </div>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Ingresar</button>
                </form>
            </div>
        </div>


        <!-- 1. Pantalla Inicial -->
        <div id="initialScreen" class="screen p-8 space-y-4 bg-gray-50 rounded-xl shadow-lg text-center fade-in">
            <!-- Título actualizado con el logo -->
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-3">
                <img src="https://i.postimg.cc/vTQjffhK/NUEVO-LOGO.png" alt="Logo Parroquia" class="h-10">
                <span>Parroquia San José Bono</span>
            </h1>
            <p class="text-xl text-gray-600">"Sembradores de Esperanza"</p>
            <p id="welcomeMessage" class="text-lg text-gray-700"></p>
            

            <div id="authError" class="hidden p-4 my-4 text-sm text-red-700 bg-red-100 rounded-lg text-left"></div>
            <div id="mainButtons" class="space-y-4">
                <button id="goToFormButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">
                    Nueva Carga
                </button>
                <button id="goToHistoryButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">
                    Historial de Carga
                </button>
                <button id="goToExpenseButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">
                    Egresos
                </button>
                <button id="goToSimpleBalanceButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-orange-500 to-orange-700 hover:from-orange-600 hover:to-orange-800 rounded-lg">
                    Balance
                </button>
                <button id="goToRecycleBinButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-yellow-500 to-yellow-700 hover:from-yellow-600 hover:to-yellow-800 rounded-lg">
                    Papelera
                </button>
                <button id="downloadReportFromMainButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Descargar Reporte</button>
                <button id="logoutButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cerrar Sesión</button>
            </div>
        </div>

        <!-- 2. Pantalla de Formulario de Entrada de Datos -->
        <div id="formScreen" class="screen p-6 sm:p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-6 text-center">Cargar Datos del Bono</h2>
            
            <!-- Formulario de Carga -->
            <form id="dataForm" class="space-y-4">
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" readonly>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" name="vendedor" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Nombre del Vendedor" list="vendedoresList">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Números de Bonos</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-1/2">
                            <label for="bonoNro1" class="text-xs text-gray-500">Nro. 1</label>
                            <input type="number" id="bonoNro1" name="bonoNro1" required placeholder="000" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="w-1/2">
                            <label for="bonoNro2" class="text-xs text-gray-500">Nro. 2</label>
                            <input type="number" id="bonoNro2" name="bonoNro2" required placeholder="999" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre y Apellido</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Juan Pérez" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="tel" id="telefono" name="telefono" required placeholder="3772..." class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="tipoPago" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                    <select id="tipoPago" name="tipoPago" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div>
                    <label for="cuotas" class="block text-sm font-medium text-gray-700">Cuotas Abonadas</label>
                    <select id="cuotas" name="cuotas" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>

                <!-- Botones de Acción del Formulario -->
                <div id="formActions" class="pt-4 grid grid-cols-2 gap-4">
                    <!-- Estos botones se actualizarán dinámicamente con JS -->
                </div>
            </form>

            <!-- Línea divisoria -->
            <hr class="my-6 border-gray-200">

            <!-- Sección de Resumen en Vivo -->
            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Resumen de Carga Actual</h3>
                <div id="liveSummaryContainer" class="space-y-3 p-3 bg-white rounded-lg border min-h-[210px]">
                    <!-- Los bonos cargados aparecerán aquí -->
                </div>
                <div id="liveSummaryPagination" class="mt-4 flex justify-center items-center gap-4">
                    <!-- La paginación se renderizará aquí -->
                </div>
                <div id="liveSummaryTotals" class="mt-4 text-right font-semibold text-gray-800">
                    <!-- Los totales se mostrarán aquí -->
                </div>
            </div>

            <!-- Línea divisoria -->
            <hr class="my-6 border-gray-200">

            <!-- Acciones Finales de la Sesión -->
            <div id="sessionActions" class="space-y-3">
                <button id="confirmAllButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Confirmar carga de bonos</button>
                <button id="clearAllButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Borrar Todo</button>
                <button id="goBackToInitialScreenButton" class="w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver</button>
            </div>
        </div>


        <!-- 3. Pantalla de Detalles Finales -->
        <div id="detailsScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 id="detailsTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center">Detalle de Carga</h2>
            <div id="detailsListContainer" class="mb-6 max-h-80 overflow-y-auto p-3 bg-white rounded-lg border"></div>
            <div id="summaryContainer" class="mb-6 p-4 bg-gray-100 rounded-lg space-y-2 text-lg"></div>
            <div id="detailsActions" class="space-y-3"></div>
        </div>
        
        <!-- 4. Pantalla de Historial -->
        <div id="historyScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Historial de Cargas</h2>
            <!-- NEW: Search bar for history -->
            <div class="mb-4">
                <input type="text" id="historySearchInput" placeholder="Buscar por fecha (dd/mm/yyyy)..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
            </div>
            <div id="historyListContainer" class="mb-6 max-h-96 overflow-y-auto space-y-3"></div>
            <button id="downloadAllLoadsPdfButton" class="w-full mb-2 px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Descargar reporte completo</button>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>
        </div>
        
        <!-- 9. Pantalla de Egresos -->
        <div id="expenseScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Egresos</h2>
            <form id="expenseForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700" id="expenseFormTitle">Nuevo Egreso</h3>
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="expenseDate" name="expenseDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="expenseDescription" name="expenseDescription" required placeholder="Ej: Compra de insumos" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700">Importe</label>
                    <input type="text" inputmode="numeric" id="expenseAmount" name="expenseAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                    <select id="expenseType" name="expenseType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="expenseFormActions">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Confirmar Egreso</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Egresos Registrados</h3>
            <div id="expenseListContainer" class="mb-6 space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

        <!-- 11. Pantalla de Papelera de Reciclaje -->
        <div id="recycleBinScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-1 text-center">Papelera de Reciclaje</h2>
            <p id="recycleBinCount" class="text-center text-gray-600 mb-4"></p>
            <div id="recycleBinListContainer" class="mb-6 max-h-96 overflow-y-auto space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>
        </div>
        
        <!-- NEW: 13. Pantalla de Balance (repurposed) -->
        <div id="simpleBalanceScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Balance</h2>
            
            <div class="mb-6 p-4 bg-gray-100 rounded-lg border space-y-2 text-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-2 text-center border-b pb-2">Resumen de Ventas</h3>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-700">Bonos Vendidos:</span>
                    <span id="balanceBonosVendidos" class="font-extrabold text-gray-900"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-gray-700">Bonos Faltantes:</span>
                    <span id="balanceBonosFaltantes" class="font-extrabold text-gray-900"></span>
                </div>
            </div>

            <div class="space-y-4 text-lg p-4 bg-white rounded-lg border">
                <div class="flex justify-between items-center text-xl">
                    <span class="font-semibold text-green-700">Total Ingresos (Bonos):</span>
                    <span id="totalIngresosBonos" class="font-extrabold text-green-700"></span>
                </div>
                <div class="flex justify-between items-center text-xl">
                    <span class="font-semibold text-red-700">Total Egresos:</span>
                    <span id="totalEgresosGeneral" class="font-extrabold text-red-700"></span>
                </div>
                
                <hr class="border-t-2 border-gray-300 my-2">

                <div class="flex items-center gap-2 pt-2">
                    <label for="depositoBancoInput" class="font-semibold text-gray-700 shrink-0">Deposito del Banco:</label>
                    <input type="text" inputmode="numeric" id="depositoBancoInput" class="w-full px-2 py-1 border border-gray-300 rounded-md shadow-sm text-right font-bold text-gray-900">
                </div>
                 <p class="text-xs text-gray-500 -mt-2 text-right">Presiona el botón de abajo para guardar el monto.</p>


                <hr class="border-t-2 border-gray-300 my-2">

                <div class="flex justify-between items-center text-2xl">
                    <span class="font-bold text-blue-800">Depositos por Transferencia:</span>
                    <span id="depositosPorTransferencia" class="font-extrabold text-blue-800"></span>
                </div>
            </div>
            <div class="mt-8 space-y-3">
                <button id="downloadDetailedBalancePdfButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">Descargar Balance Detallado (PDF)</button>
                <button id="saveBalanceConfigButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Guardar Monto del Depósito</button>
                <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>
            </div>
        </div>


    </div>

    <!-- Modales de la aplicación -->
    <div id="dateConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-gray-50 fade-in">
            <div class="text-center">
                <h3 id="dateConfirmTitle" class="text-2xl font-bold text-gray-900">Confirmar Fecha</h3>
                <div class="mt-4">
                    <label for="modalDateInput" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="modalDateInput" name="modalDateInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div class="mt-6 space-y-3">
                    <button id="confirmDateButton" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar</button>
                    <button id="cancelDateButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmAllModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-gray-50 fade-in">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900">Confirmar Carga Final</h3>
                <div id="finalConfirmationData" class="mt-4 text-center space-y-2 text-gray-700"></div>
                <div class="mt-6 space-y-3">
                    <button id="saveAndFinishButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar y Guardar</button>
                    <button id="goBackToFormButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-xl text-center fade-in">
            <h3 id="deleteConfirmTitle" class="text-lg font-bold text-gray-900">Confirmar Acción</h3>
            <p id="deleteConfirmMessage" class="text-sm text-gray-600 my-4">Esta operación no puede revertirse.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Volver</button>
                <button id="confirmDeleteButton" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="secondInstallmentConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-xl text-center fade-in w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Segunda Cuota</h3>
            <p class="text-sm text-gray-600 my-4">Este número de bono ya tiene una cuota pagada. ¿Desea registrar el pago de la segunda cuota?</p>
            <div id="secondInstallmentDetails" class="p-4 bg-white border rounded-lg text-left mb-4 space-y-1">
                <!-- Los detalles del bono existente se insertarán aquí -->
            </div>
            <div class="flex justify-center gap-4">
                <button id="cancelSecondInstallmentButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
                <button id="confirmSecondInstallmentButton" class="px-5 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar Pago</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Importar módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, onSnapshot, query, writeBatch, updateDoc, enableIndexedDbPersistence, serverTimestamp, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Inicialización de la Aplicación ---
        const { jsPDF } = window.jspdf;
        
        window.App = {
            // --- ESTADO GLOBAL ---
            state: {
                // NEW: Configuration object for constants
                config: {
                    BONO_PRICE_ONE_INSTALLMENT: 15000,
                    BONO_PRICE_TWO_INSTALLMENTS: 30000,
                    totalPrinted: 500,       // Default value, will be overwritten from DB
                    bancoDepositado: 2375739 // Default value, will be overwritten from DB
                },
                currentUser: null,
                isAdmin: false,
                currentSessionRecords: [],
                allSessions: [],
                expenses: [],
                deletedItems: [], // Para la papelera
                balanceData: null,
                recordToEditIndex: null,
                expenseToEditId: null,
                editOrigin: null,
                itemToDelete: { id: null, type: null, index: null, permanent: false },
                sessionToEditId: null,
                sessionToEditRawDate: null, 
                db: null,
                auth: null,
                userId: null,
                unsubscribeHistory: null,
                unsubscribeExpenses: null,
                unsubscribeDeleted: null,
                showAllExpenses: false,
                datePromptType: null,
                liveSummaryPage: 1,
                recordsPerPage: 3,
                pendingSecondInstallmentRecord: null, // Para guardar temporalmente el registro
                simpleBalanceCache: {
                    totalIngresos: 0,
                    totalEgresos: 0
                },
            },

            // --- INICIALIZACIÓN ---
            async init() {
                this.cacheDOMElements();
                this.bindEvents();
                this.showLoading(true);
                await this.initializeFirebase();
            },

            cacheDOMElements() {
                this.dom = {
                    html: document.documentElement,
                    screens: document.querySelectorAll('.screen'),
                    loginScreen: document.getElementById('loginScreen'),
                    loginForm: document.getElementById('loginForm'),
                    emailInput: document.getElementById('emailInput'),
                    passwordInput: document.getElementById('passwordInput'),
                    passwordToggle: document.getElementById('passwordToggle'),
                    eyeIcon: document.getElementById('eyeIcon'),
                    eyeOffIcon: document.getElementById('eyeOffIcon'),
                    dataForm: document.getElementById('dataForm'),
                    formTitle: document.getElementById('formTitle'),
                    formActions: document.getElementById('formActions'),
                    confirmAllModal: document.getElementById('confirmAllModal'),
                    finalConfirmationData: document.getElementById('finalConfirmationData'),
                    saveAndFinishButton: document.getElementById('saveAndFinishButton'),
                    goBackToFormButton: document.getElementById('goBackToFormButton'),
                    deleteConfirmModal: document.getElementById('deleteConfirmModal'),
                    deleteConfirmTitle: document.getElementById('deleteConfirmTitle'),
                    deleteConfirmMessage: document.getElementById('deleteConfirmMessage'),
                    secondInstallmentConfirmModal: document.getElementById('secondInstallmentConfirmModal'),
                    secondInstallmentDetails: document.getElementById('secondInstallmentDetails'),
                    confirmSecondInstallmentButton: document.getElementById('confirmSecondInstallmentButton'),
                    cancelSecondInstallmentButton: document.getElementById('cancelSecondInstallmentButton'),
                    dateConfirmModal: document.getElementById('dateConfirmModal'),
                    dateConfirmTitle: document.getElementById('dateConfirmTitle'),
                    modalDateInput: document.getElementById('modalDateInput'),
                    confirmDateButton: document.getElementById('confirmDateButton'),
                    cancelDateButton: document.getElementById('cancelDateButton'),
                    historyListContainer: document.getElementById('historyListContainer'),
                    detailsScreen: document.getElementById('detailsScreen'),
                    detailsListContainer: document.getElementById('detailsListContainer'),
                    summaryContainer: document.getElementById('summaryContainer'),
                    detailsActions: document.getElementById('detailsActions'),
                    detailsTitle: document.getElementById('detailsTitle'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    authError: document.getElementById('authError'),
                    mainButtons: document.getElementById('mainButtons'),
                    welcomeMessage: document.getElementById('welcomeMessage'),
                    logoutButton: document.getElementById('logoutButton'),
                    expenseScreen: document.getElementById('expenseScreen'),
                    expenseForm: document.getElementById('expenseForm'),
                    expenseFormTitle: document.getElementById('expenseFormTitle'),
                    expenseFormActions: document.getElementById('expenseFormActions'),
                    expenseListContainer: document.getElementById('expenseListContainer'),
                    toastContainer: document.getElementById('toastContainer'),
                    goToExpenseButton: document.getElementById('goToExpenseButton'),
                    vendedoresList: document.getElementById('vendedoresList'),
                    liveSummaryContainer: document.getElementById('liveSummaryContainer'),
                    liveSummaryPagination: document.getElementById('liveSummaryPagination'),
                    liveSummaryTotals: document.getElementById('liveSummaryTotals'),
                    confirmAllButton: document.getElementById('confirmAllButton'),
                    clearAllButton: document.getElementById('clearAllButton'),
                    goBackToInitialScreenButton: document.getElementById('goBackToInitialScreenButton'),
                    expenseAmountInput: document.getElementById('expenseAmount'),
                    recycleBinScreen: document.getElementById('recycleBinScreen'),
                    bonoNro1Input: document.getElementById('bonoNro1'),
                    bonoNro2Input: document.getElementById('bonoNro2'),
                    recycleBinListContainer: document.getElementById('recycleBinListContainer'),
                    goToRecycleBinButton: document.getElementById('goToRecycleBinButton'),
                    downloadAllLoadsPdfButton: document.getElementById('downloadAllLoadsPdfButton'),
                    downloadReportFromMainButton: document.getElementById('downloadReportFromMainButton'),
                    historySearchInput: document.getElementById('historySearchInput'),
                    recycleBinCount: document.getElementById('recycleBinCount'),
                    // New simple balance screen elements
                    simpleBalanceScreen: document.getElementById('simpleBalanceScreen'),
                    goToSimpleBalanceButton: document.getElementById('goToSimpleBalanceButton'),
                    totalIngresosBonos: document.getElementById('totalIngresosBonos'),
                    totalEgresosGeneral: document.getElementById('totalEgresosGeneral'),
                    depositoBancoInput: document.getElementById('depositoBancoInput'),
                    depositosPorTransferencia: document.getElementById('depositosPorTransferencia'),
                    saveBalanceConfigButton: document.getElementById('saveBalanceConfigButton'),
                    balanceBonosVendidos: document.getElementById('balanceBonosVendidos'),
                    balanceBonosFaltantes: document.getElementById('balanceBonosFaltantes'),
                    downloadDetailedBalancePdfButton: document.getElementById('downloadDetailedBalancePdfButton'),
                };
            },

            async initializeFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyAhV7Ri-DfYSQA_tgbDeSSGtpG74UNC10g",
                    authDomain: "bonosparroquia-30762.firebaseapp.com",
                    projectId: "bonosparroquia-30762",
                    storageBucket: "bonosparroquia-30762.appspot.com",
                    messagingSenderId: "24790926044",
                    appId: "1:24790926044:web:a4ee95475ba61c133baa19"
                };
                const app = initializeApp(firebaseConfig);
                this.state.db = getFirestore(app);
                this.state.auth = getAuth(app);

                try {
                    await enableIndexedDbPersistence(this.state.db);
                    console.log("Persistencia offline habilitada.");
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Múltiples pestañas abiertas, la persistencia offline solo se puede habilitar en una.");
                    } else if (err.code == 'unimplemented') {
                        console.warn("El navegador actual no soporta la persistencia offline.");
                    }
                }

                onAuthStateChanged(this.state.auth, (user) => {
                    this.showLoading(false);
                    if (user) {
                        this.login(user);
                        this.loadAllDataFromFirestore();
                    } else {
                        this.logoutCleanup();
                    }
                });
            },

            bindEvents() {
                this.dom.loginForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
                this.dom.passwordToggle.addEventListener('click', () => this.togglePasswordVisibility());
                document.getElementById('goToFormButton').addEventListener('click', () => this.promptForDate());
                document.getElementById('goToHistoryButton').addEventListener('click', () => this.showHistoryScreen());
                this.dom.goToExpenseButton.addEventListener('click', () => this.showExpenseScreen());
                this.dom.goToSimpleBalanceButton.addEventListener('click', () => this.showSimpleBalanceScreen());
                this.dom.goToRecycleBinButton.addEventListener('click', () => this.showRecycleBinScreen());
                this.dom.logoutButton.addEventListener('click', () => this.logout());
                this.dom.dataForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleAddOrUpdateRecord(); });
                this.dom.saveAndFinishButton.addEventListener('click', () => this.handleSaveAndFinish());
                this.dom.goBackToFormButton.addEventListener('click', () => this.dom.confirmAllModal.classList.add('hidden'));
                document.getElementById('cancelDeleteButton').addEventListener('click', () => this.dom.deleteConfirmModal.classList.add('hidden'));
                document.getElementById('confirmDeleteButton').addEventListener('click', () => this.handleConfirmDelete());
                this.dom.confirmSecondInstallmentButton.addEventListener('click', () => this.handleConfirmSecondInstallment());
                this.dom.cancelSecondInstallmentButton.addEventListener('click', () => this.handleCancelSecondInstallment());
                this.dom.bonoNro1Input.addEventListener('input', () => {
                    if (this.dom.bonoNro1Input.value.length === 3) {
                        this.dom.bonoNro2Input.focus();
                    }
                });
                this.dom.bonoNro2Input.addEventListener('input', () => this.checkBonoExistence());
                this.dom.expenseForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleExpenseFormSubmit(); });
                this.dom.confirmDateButton.addEventListener('click', () => this.handleDateConfirm());
                this.dom.cancelDateButton.addEventListener('click', () => this.dom.dateConfirmModal.classList.add('hidden'));
                this.dom.confirmAllButton.addEventListener('click', () => this.handleConfirmAll());
                this.dom.clearAllButton.addEventListener('click', () => this.handleClearAll());
                this.dom.goBackToInitialScreenButton.addEventListener('click', () => this.showScreen('initialScreen'));
                this.dom.expenseAmountInput.addEventListener('input', (e) => this.formatCurrencyInput(e));
                this.dom.downloadAllLoadsPdfButton.addEventListener('click', () => this.downloadAllLoadsPDF());
                this.dom.downloadReportFromMainButton.addEventListener('click', () => this.downloadAllLoadsPDF());
                this.dom.historySearchInput.addEventListener('input', () => this.showHistoryScreen());
                this.dom.depositoBancoInput.addEventListener('input', (e) => {
                    this.formatCurrencyInput(e);
                    this.recalculateSimpleBalance();
                });
                this.dom.saveBalanceConfigButton.addEventListener('click', () => this.saveBalanceConfig());
                this.dom.downloadDetailedBalancePdfButton.addEventListener('click', () => this.downloadDetailedBalancePDF());
            },

            // --- AUTENTICACIÓN Y NAVEGÁCIÓn ---
            async handleLogin() {
                const email = this.dom.emailInput.value;
                const password = this.dom.passwordInput.value;
                this.showLoading(true);
                try {
                    await signInWithEmailAndPassword(this.state.auth, email, password);
                } catch (error) {
                    this.showLoading(false);
                    console.error("Error de inicio de sesión:", error.code);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        this.showToast('Correo o contraseña incorrectos.', 'error');
                    } else {
                        this.showToast('Error al intentar ingresar.', 'error');
                    }
                }
            },

            login(user) {
                this.state.currentUser = user;
                const adminEmails = ['adanrdmato@gmail.com', 'jose@example.com']; 
                this.state.isAdmin = adminEmails.includes(user.email);

                if (user.email === 'daianavirginiafroy@gmail.com') {
                    this.dom.welcomeMessage.textContent = 'Bienvenido Javier';
                } else {
                    const displayName = user.email.split('@')[0];
                    this.dom.welcomeMessage.textContent = `Bienvenido ${displayName}`;
                }

                this.showScreen('initialScreen');
            },

            async logout() {
                try {
                    await signOut(this.state.auth);
                    this.showToast('Sesión cerrada.');
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    this.showToast('Error al cerrar sesión.', 'error');
                }
            },
            
            logoutCleanup() {
                this.state.currentUser = null;
                this.state.isAdmin = false;
                
                if (this.state.unsubscribeHistory) this.state.unsubscribeHistory();
                if (this.state.unsubscribeExpenses) this.state.unsubscribeExpenses();
                if (this.state.unsubscribeDeleted) this.state.unsubscribeDeleted();

                this.state.allSessions = [];
                this.state.expenses = [];
                this.state.deletedItems = [];

                this.showScreen('loginScreen');
            },

            showScreen(screenId) {
                this.dom.screens.forEach(s => {
                    s.classList.remove('active-screen');
                    s.style.display = 'none';
                });
                const screenToShow = document.getElementById(screenId);
                screenToShow.classList.add('active-screen');
                screenToShow.style.display = screenId === 'loginScreen' ? 'flex' : 'block';

                if (screenId === 'initialScreen') {
                    this.updateUIForUser();
                }
                 if(screenId === 'recycleBinScreen'){
                      this.renderRecycleBin();
                 }
            },

            updateUIForUser() {
                const isAdmin = this.state.isAdmin;
                this.dom.goToExpenseButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToSimpleBalanceButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToRecycleBinButton.style.display = isAdmin ? 'block' : 'none';
            },

            togglePasswordVisibility() {
                const input = this.dom.passwordInput;
                if (input.type === 'password') {
                    input.type = 'text';
                    this.dom.eyeIcon.classList.add('hidden');
                    this.dom.eyeOffIcon.classList.remove('hidden');
                } else {
                    input.type = 'password';
                    this.dom.eyeIcon.classList.remove('hidden');
                    this.dom.eyeOffIcon.classList.add('hidden');
                }
            },
            
            async checkBonoExistence() {
                const bonoNro1 = this.dom.bonoNro1Input.value;
                const bonoNro2 = this.dom.bonoNro2Input.value;

                if (bonoNro1.length < 3 || bonoNro2.length < 3) {
                    return;
                }
                
                if (!this.dom.secondInstallmentConfirmModal.classList.contains('hidden')) {
                    return;
                }

                const allHistoricalRecordsRaw = this.state.allSessions.flatMap(s => s.records);
                const allCurrentRecordsRaw = this.state.currentSessionRecords;
                const allRecordsForCheck = [...allHistoricalRecordsRaw, ...allCurrentRecordsRaw];
                const consolidatedRecords = this._consolidateBonoRecords(allRecordsForCheck);
                const recordState = consolidatedRecords.find(r => r.bonoNro1 === bonoNro1 && r.bonoNro2 === bonoNro2);


                if (recordState) {
                    if (recordState.cuotas === '2') {
                        this.showToast(`El bono ${bonoNro1}-${bonoNro2} ya pagó todas las cuotas.`, 'error');
                    } else {
                        this.promptForSecondInstallment(recordState);
                    }
                }
            },
            
            promptForDate() {
                this.dom.modalDateInput.valueAsDate = new Date();
                this.dom.dateConfirmTitle.textContent = 'Confirmar Fecha de Carga';
                this.dom.dateConfirmModal.classList.remove('hidden');
            },

            handleDateConfirm() {
                const selectedDate = this.dom.modalDateInput.value;
                if (!selectedDate) {
                    this.showToast('Por favor, seleccione una fecha.', 'error');
                    return;
                }
                this.startNewSession(selectedDate);
                this.dom.dateConfirmModal.classList.add('hidden');
            },

            promptForSecondInstallment(existingRecord) {
                this.state.pendingSecondInstallmentRecord = existingRecord;
                this.dom.secondInstallmentDetails.innerHTML = `
                    <p><span class="font-semibold">Nro Bono:</span> ${existingRecord.bonoNro1}-${existingRecord.bonoNro2}</p>
                    <p><span class="font-semibold">Comprador:</span> ${existingRecord.nombre}</p>
                    <p><span class="font-semibold">Teléfono:</span> ${existingRecord.telefono}</p>
                    <p><span class="font-semibold">Vendedor:</span> ${existingRecord.vendedor}</p>
                `;
                this.dom.secondInstallmentConfirmModal.classList.remove('hidden');
            },

            async saveSecondInstallmentToFirestore(record) {
                this.showLoading(true);
                const rawDate = record.fecha;
                const sessionId = this.formatDateForId(rawDate, true);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                const recordsColRef = collection(sessionDocRef, 'records');
                
                try {
                    const batch = writeBatch(this.state.db);
                    
                    batch.set(sessionDocRef, { 
                        id: this.formatDateForId(rawDate), 
                        rawDate: rawDate, 
                        lastUpdated: serverTimestamp(), 
                        deleted: false 
                    }, { merge: true });

                    const newRecordRef = doc(recordsColRef);
                    batch.set(newRecordRef, { ...record, deleted: false });

                    await batch.commit();
                    this.showToast(`Segunda cuota del bono ${record.bonoNro1}-${record.bonoNro2} guardada exitosamente.`);

                } catch (error) {
                    console.error("Error al guardar la segunda cuota directamente:", error);
                    this.showToast('Error al guardar la segunda cuota.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            handleConfirmSecondInstallment() {
                const existingRecord = this.state.pendingSecondInstallmentRecord;
                if (!existingRecord) return;

                const vendedorActual = document.getElementById('vendedor').value.trim();
                const vendedor = vendedorActual || existingRecord.vendedor;

                const newRecordForSession = {
                    fecha: document.getElementById('fecha').value,
                    vendedor: vendedor,
                    bonoNro1: existingRecord.bonoNro1,
                    bonoNro2: existingRecord.bonoNro2,
                    nombre: existingRecord.nombre,
                    telefono: existingRecord.telefono,
                    tipoPago: document.getElementById('tipoPago').value,
                    cuotas: '1',
                    isSecondInstallment: true,
                };
                
                if (!newRecordForSession.vendedor) {
                     this.showToast('No se pudo determinar el vendedor. Por favor, ingréselo en el formulario.', 'error');
                     document.getElementById('vendedor').focus();
                     return;
                }
                
                this.saveSecondInstallmentToFirestore(newRecordForSession);

                this.dom.bonoNro1Input.value = '';
                this.dom.bonoNro2Input.value = '';
                document.getElementById('nombre').value = '';
                document.getElementById('telefono').value = '';
                this.dom.bonoNro1Input.focus();
                
                this.handleCancelSecondInstallment(); 
            },


            handleCancelSecondInstallment() {
                this.dom.secondInstallmentConfirmModal.classList.add('hidden');
                this.state.pendingSecondInstallmentRecord = null;
            },


            // --- FLUJO DE ENTRADA DE NUEVOS DATOS ---

            startNewSession(date) {
                this.state.currentSessionRecords = [];
                this.state.recordToEditIndex = null;
                this.state.liveSummaryPage = 1;
                this.dom.dataForm.reset();
                document.getElementById('fecha').value = date;
                this.renderLiveSummary();
                this.setFormMode('add');
                this.showScreen('formScreen');
            },

            setFormMode(mode) {
                if (mode === 'add') {
                    this.dom.formTitle.textContent = 'Cargar Datos del Bono';
                    this.dom.formActions.innerHTML = `
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Cargar Otro</button>
                        <button type="button" onclick="App.clearForm()" class="w-full px-4 py-3 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Borrar Campos</button>
                    `;
                } else if (mode === 'edit') {
                    this.dom.formTitle.textContent = 'Modificando Registro';
                    this.dom.formActions.innerHTML = `
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Guardar Cambios</button>
                        <button type="button" onclick="App.cancelEdit()" class="w-full px-4 py-3 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                    `;
                }
            },
            
            handleAddOrUpdateRecord() {
                const formData = new FormData(this.dom.dataForm);
                const record = Object.fromEntries(formData.entries());

                if (!record.bonoNro1 || !record.bonoNro2 || !record.nombre || !record.telefono) {
                    this.showToast('Por favor, complete todos los campos requeridos.', 'error');
                    return;
                }
                const phoneRegex = /^\d{6,12}$/;
                if (!phoneRegex.test(record.telefono)) {
                    this.showToast('Teléfono inválido (6-12 dígitos).', 'error');
                    return;
                }
                
                if (this.state.recordToEditIndex !== null) {
                    this.state.currentSessionRecords[this.state.recordToEditIndex] = record;
                    this.showToast('Registro modificado con éxito.');
                    
                    const origin = this.state.editOrigin;
                    this.state.recordToEditIndex = null;
                    this.state.editOrigin = null;
                    this.dom.dataForm.reset();
                    this.setFormMode('add');

                    if (origin === 'detailsScreen') {
                        this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                    } else {
                        this.renderLiveSummary();
                        this.clearForm(false);
                    }
                } else {
                    const allHistoricalRecordsRaw = this.state.allSessions.flatMap(s => s.records);
                    const allCurrentRecordsRaw = this.state.currentSessionRecords;
                    const allRecordsForCheck = [...allHistoricalRecordsRaw, ...allCurrentRecordsRaw];
                    const consolidatedRecords = this._consolidateBonoRecords(allRecordsForCheck);
                    const existingRecordState = consolidatedRecords.find(r => r.bonoNro1 === record.bonoNro1 && r.bonoNro2 === record.bonoNro2);

                    if (existingRecordState) {
                        if (existingRecordState.cuotas === '2') {
                            this.showToast(`El bono ${record.bonoNro1}-${record.bonoNro2} ya pagó todas las cuotas.`, 'error');
                            return;
                        } else { 
                            this.promptForSecondInstallment(existingRecordState);
                            return;
                        }
                    }
                    
                    this.state.currentSessionRecords.push(record);
                    this.showToast('Bono añadido al resumen.');
                    
                    this.state.liveSummaryPage = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                    this.renderLiveSummary();
                    this.clearForm(false);
                }
            },

            clearForm(clearAll = true) {
                const currentDate = document.getElementById('fecha').value;
                const currentVendedor = document.getElementById('vendedor').value;
                this.dom.dataForm.reset();
                document.getElementById('fecha').value = currentDate;
                if (!clearAll) {
                    document.getElementById('vendedor').value = currentVendedor;
                }
                document.getElementById('bonoNro1').focus();
            },

            renderLiveSummary() {
                this.dom.liveSummaryContainer.innerHTML = '';
                this.dom.liveSummaryPagination.innerHTML = '';

                if (this.state.currentSessionRecords.length === 0) {
                    this.dom.liveSummaryContainer.innerHTML = '<p class="text-center text-gray-500">Aún no hay bonos en esta carga.</p>';
                    this.dom.liveSummaryTotals.innerHTML = '';
                    return;
                }

                const page = this.state.liveSummaryPage;
                const recordsPerPage = this.state.recordsPerPage;
                const startIndex = (page - 1) * recordsPerPage;
                const endIndex = startIndex + recordsPerPage;
                const paginatedRecords = this.state.currentSessionRecords.slice(startIndex, endIndex);

                paginatedRecords.forEach((record, index) => {
                    const originalIndex = startIndex + index;
                    const monto = this._getRecordMonto(record);
                    
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'p-3 border rounded-md bg-white grid grid-cols-[1fr_auto] gap-2 items-center';
                    recordDiv.innerHTML = `
                        <div>
                            <p class="font-bold text-indigo-700">${record.nombre}</p>
                            <p class="text-sm text-gray-600">Bonos: ${record.bonoNro1}-${record.bonoNro2} | ${this.formatCurrency(monto)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.editRecordFromSummary(${originalIndex})" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button>
                            <button onclick="App.promptDeleteItem(null, 'summaryRecord', ${originalIndex})" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Eliminar</button>
                        </div>
                    `;
                    this.dom.liveSummaryContainer.appendChild(recordDiv);
                });

                let subtotal = 0;
                let totalEfectivo = 0;
                this.state.currentSessionRecords.forEach(record => {
                    const monto = this._getRecordMonto(record);
                    subtotal += monto;
                    if (record.tipoPago === 'Efectivo') totalEfectivo += monto;
                });

                this.dom.liveSummaryTotals.innerHTML = `
                    <p>Subtotal: <span class="font-bold">${this.formatCurrency(subtotal)}</span></p>
                    <p class="text-green-700">Total Efectivo: <span class="font-bold">${this.formatCurrency(totalEfectivo)}</span></p>
                `;

                const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                if (totalPages > 1) {
                    this.dom.liveSummaryPagination.innerHTML = `
                        <button onclick="App.prevPage()" class="px-3 py-1 rounded-md bg-gray-200" ${page === 1 ? 'disabled' : ''}>&lt;</button>
                        <span class="font-semibold text-gray-700">Página ${page} de ${totalPages}</span>
                        <button onclick="App.nextPage()" class="px-3 py-1 rounded-md bg-gray-200" ${page === totalPages ? 'disabled' : ''}>&gt;</button>
                    `;
                }
            },
            
            nextPage() {
                const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                if (this.state.liveSummaryPage < totalPages) {
                    this.state.liveSummaryPage++;
                    this.renderLiveSummary();
                }
            },

            prevPage() {
                if (this.state.liveSummaryPage > 1) {
                    this.state.liveSummaryPage--;
                    this.renderLiveSummary();
                }
            },

            editRecordFromSummary(index) {
                this.state.editOrigin = 'formScreen';
                const record = this.state.currentSessionRecords[index];
                if (!record) return;

                this.state.recordToEditIndex = index;
                
                document.getElementById('vendedor').value = record.vendedor;
                document.getElementById('bonoNro1').value = record.bonoNro1;
                document.getElementById('bonoNro2').value = record.bonoNro2;
                document.getElementById('nombre').value = record.nombre;
                document.getElementById('telefono').value = record.telefono;
                document.getElementById('tipoPago').value = record.tipoPago;
                document.getElementById('cuotas').value = record.cuotas;

                this.setFormMode('edit');
                window.scrollTo(0, 0);
            },

            editRecordFromSession(index) {
                const record = this.state.currentSessionRecords[index];
                if (!record) return;

                this.state.recordToEditIndex = index;
                this.state.editOrigin = 'detailsScreen';

                document.getElementById('fecha').value = record.fecha;
                document.getElementById('vendedor').value = record.vendedor;
                document.getElementById('bonoNro1').value = record.bonoNro1;
                document.getElementById('bonoNro2').value = record.bonoNro2;
                document.getElementById('nombre').value = record.nombre;
                document.getElementById('telefono').value = record.telefono;
                document.getElementById('tipoPago').value = record.tipoPago;
                document.getElementById('cuotas').value = record.cuotas;

                this.setFormMode('edit');
                this.showScreen('formScreen');
            },

            cancelEdit() {
                const origin = this.state.editOrigin;
                this.state.recordToEditIndex = null;
                this.state.editOrigin = null;
                this.clearForm();
                this.setFormMode('add');

                if (origin === 'detailsScreen') {
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                }
            },

            handleConfirmAll() {
                if (this.state.currentSessionRecords.length === 0) {
                    this.showToast('No hay bonos en el resumen para guardar.', 'error');
                    return;
                }
                
                let subtotal = 0;
                this.state.currentSessionRecords.forEach(r => subtotal += this._getRecordMonto(r));

                this.dom.finalConfirmationData.innerHTML = `
                    <p>Vas a guardar una sesión con <strong>${this.state.currentSessionRecords.length} registros</strong>.</p>
                    <p>El monto total es de <strong>${this.formatCurrency(subtotal)}</strong>.</p>
                    <p class="mt-4">¿Estás seguro de que quieres continuar?</p>
                `;
                this.dom.confirmAllModal.classList.remove('hidden');
            },

            handleClearAll() {
                if (this.state.currentSessionRecords.length > 0) {
                    this.promptDeleteItem(null, 'clearAllSummary');
                } else {
                    this.showToast('El resumen ya está vacío.', 'error');
                }
            },

            handleSaveAndFinish() {
                this.dom.confirmAllModal.classList.add('hidden');
                this.saveSessionToFirestore();
            },

            // --- GESTIÓN DE DATOS EN FIRESTORE ---
            loadAllDataFromFirestore() {
                 this.loadHistoryFromFirestore();
                 this.loadExpensesFromFirestore();
                 this.loadDeletedItemsFromFirestore();
                 this.loadAppConfig();
            },

            loadHistoryFromFirestore() {
                if (this.state.unsubscribeHistory) this.state.unsubscribeHistory();
                const sessionsColRef = collection(this.state.db, "sessions");
                this.showLoading(true);
                this.state.unsubscribeHistory = onSnapshot(query(sessionsColRef), async (snapshot) => {
                    const activeDocs = snapshot.docs.filter(doc => doc.data().deleted !== true);
                    const sessionsPromises = activeDocs.map(async (docSnap) => {
                        const sessionDocData = docSnap.data();
                        const sessionData = { 
                            id: docSnap.id, 
                            records: [], 
                            rawDate: sessionDocData.rawDate 
                        };
                        const recordsColRef = collection(docSnap.ref, 'records');
                        const recordsSnapshot = await getDocs(query(recordsColRef)); // Query all
                        const activeRecords = recordsSnapshot.docs.filter(doc => doc.data().deleted !== true); // Filter in JS
                        sessionData.records = activeRecords.map(d => Object.assign({recordId: d.id}, d.data()));
                        return sessionData;
                    });
                    this.state.allSessions = await Promise.all(sessionsPromises);
                    this.updateVendedoresList();
                    this.showLoading(false);
                    if (document.getElementById('historyScreen').classList.contains('active-screen')) {
                        this.showHistoryScreen();
                    }
                }, (error) => {
                    console.error("Error al escuchar los cambios del historial:", error);
                    this.showLoading(false);
                });
            },

            async saveSessionToFirestore() {
                if (this.state.currentSessionRecords.length === 0) return;
                this.showLoading(true);
                const rawDate = this.state.currentSessionRecords[0].fecha;
                const sessionId = this.formatDateForId(rawDate, true);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                const recordsColRef = collection(sessionDocRef, 'records');
                try {
                    const batch = writeBatch(this.state.db);
                    batch.set(sessionDocRef, { id: this.formatDateForId(rawDate), rawDate: rawDate, lastUpdated: serverTimestamp(), deleted: false }, { merge: true });
                    this.state.currentSessionRecords.forEach(record => {
                        const newRecordRef = doc(recordsColRef);
                         batch.set(newRecordRef, { ...record, deleted: false });
                    });
                    await batch.commit();
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'new');
                    this.showToast('Carga finalizada y guardada con éxito.');
                } catch (error) {
                    console.error("Error al guardar la sesión en Firestore: ", error);
                    this.showToast('Error al guardar la carga.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            showLoading(isLoading) {
                this.dom.loadingIndicator.classList.toggle('hidden', !isLoading);
            },
            
            showHistoryScreen() {
                this.dom.historyListContainer.innerHTML = '';
                const searchTerm = this.dom.historySearchInput.value.toLowerCase();

                let sessionsToDisplay = [...this.state.allSessions];
                
                if (searchTerm) {
                    sessionsToDisplay = sessionsToDisplay.filter(session => {
                        const displayId = session.id.replace(/-/g, '/');
                        return displayId.includes(searchTerm);
                    });
                }
                
                if (sessionsToDisplay.length === 0) {
                    this.dom.historyListContainer.innerHTML = '<p class="text-center text-gray-500">No se encontraron cargas.</p>';
                } else {
                    const sortedSessions = sessionsToDisplay.sort((a, b) => (a.rawDate || this.parseIdToDate(a.id)).localeCompare(b.rawDate || this.parseIdToDate(b.id))).reverse();
                    sortedSessions.forEach(session => {
                        const displayId = session.id.replace(/-/g, '/');
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg border';
                        sessionDiv.innerHTML = `<span class="font-semibold text-gray-800">Carga del ${displayId}</span><div class="flex gap-2"><button onclick="App.editSession('${session.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${session.id}', 'session')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button><button onclick="App.downloadSessionPDF('${session.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">PDF</button></div>`;
                        this.dom.historyListContainer.appendChild(sessionDiv);
                    });
                }
                this.showScreen('historyScreen');
            },

            displayDetailsScreen(records, mode = 'new') {
                this.dom.detailsListContainer.innerHTML = '';
                this.dom.summaryContainer.innerHTML = '';
                if (!records || records.length === 0) {
                    this.dom.detailsListContainer.innerHTML = '<p class="text-center text-gray-500">No hay registros.</p>';
                    return;
                }
                let subtotal = 0, totalEfectivo = 0;
                records.forEach((data, index) => {
                    const monto = this._getRecordMonto(data);
                    subtotal += monto;
                    if (data.tipoPago === 'Efectivo') totalEfectivo += monto;
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'p-3 mb-2 border rounded-md bg-white grid grid-cols-1 gap-2 items-center';
                    detailDiv.innerHTML = `<div><p class="font-bold text-indigo-700">${data.nombre}</p><p class="text-sm text-gray-600">Bonos: ${data.bonoNro1}-${data.bonoNro2} | ${data.tipoPago}</p></div><p class="text-right font-semibold text-gray-800">${this.formatCurrency(monto)}</p>${mode === 'edit' ? `<div class="text-right flex gap-2 justify-end"><button onclick="App.editRecordFromSession(${index})" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.deleteRecordFromSession(${index})" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Eliminar</button></div>` : ''}`;
                    this.dom.detailsListContainer.appendChild(detailDiv);
                });
                this.dom.summaryContainer.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium text-gray-600">Subtotal:</span><span class="font-bold text-gray-900">${this.formatCurrency(subtotal)}</span></div><div class="flex justify-between items-center text-green-700"><span class="font-medium">Total (Efectivo):</span><span class="font-bold">${this.formatCurrency(totalEfectivo)}</span></div>`;
                if (mode === 'new') {
                    const rawDate = this.state.currentSessionRecords[0].fecha;
                    this.dom.detailsTitle.textContent = `Detalle de Carga - ${this.formatDateForId(rawDate)}`;
                    this.dom.detailsActions.innerHTML = `<button onclick="App.downloadSessionPDF(null)" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Descargar PDF</button><button onclick="App.promptForDate()" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">Nueva Carga</button><button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>`;
                } else if (mode === 'edit') {
                    this.dom.detailsTitle.textContent = `Modificando Carga del ${this.state.sessionToEditId.replace(/-/g, '/')}`;
                    this.dom.detailsActions.innerHTML = `<button onclick="App.saveModifiedSession()" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Guardar Cambios</button><button onclick="App.showHistoryScreen()" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Cancelar</button>`;
                }
                this.showScreen('detailsScreen');
            },
            
            editSession(sessionId) {
                this.state.sessionToEditId = sessionId;
                const session = this.state.allSessions.find(s => s.id === sessionId);
                if (session) {
                    this.state.sessionToEditRawDate = session.rawDate; 
                    this.state.currentSessionRecords = JSON.parse(JSON.stringify(session.records)); 
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                }
            },

            deleteRecordFromSession(index) {
                this.state.currentSessionRecords.splice(index, 1);
                this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
            },

            async saveModifiedSession() {
                this.showLoading(true);
                const sessionId = this.state.sessionToEditId;
                const rawDate = this.state.sessionToEditRawDate || this.parseIdToDate(sessionId);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                try {
                    const recordsColRef = collection(sessionDocRef, 'records');
                    const recordsSnapshot = await getDocs(recordsColRef);
                    const deleteBatch = writeBatch(this.state.db);
                    recordsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    if (this.state.currentSessionRecords.length > 0) {
                        const addBatch = writeBatch(this.state.db);
                        addBatch.set(sessionDocRef, { id: this.formatDateForId(rawDate), rawDate: rawDate, lastUpdated: serverTimestamp(), deleted: false }, { merge: true });
                        this.state.currentSessionRecords.forEach(record => {
                            const newRecordRef = doc(recordsColRef);
                            const recordData = Object.assign({}, record);
                            delete recordData.recordId;
                             addBatch.set(newRecordRef, { ...recordData, deleted: false });
                        });
                        await addBatch.commit();
                    } else {
                        await updateDoc(sessionDocRef, { deleted: true, deletedAt: serverTimestamp() });
                    }
                    this.showToast('Cambios guardados con éxito.');
                } catch (error) {
                    console.error("Error al modificar la sesión: ", error);
                    this.showToast('Error al guardar los cambios.', 'error');
                } finally {
                    this.showLoading(false);
                    this.showHistoryScreen();
                }
            },

            promptDeleteItem(id, type, index = null, permanent = false) {
                this.state.itemToDelete = { id, type, index, permanent };
                let message, title;

                if (permanent) {
                    title = 'Eliminar Permanentemente';
                    message = '¿Estás seguro? Esta acción no se puede deshacer.';
                } else {
                    title = 'Confirmar Eliminación';
                    message = `¿Seguro que quieres mover este elemento a la papelera?`;
                     if (type === 'summaryRecord') {
                        message = '¿Seguro que quieres eliminar este registro del resumen?';
                    } else if (type === 'clearAllSummary') {
                        message = '¿Seguro que quieres borrar todos los registros del resumen actual? Esta acción no se puede deshacer.';
                    }
                }
                
                this.dom.deleteConfirmTitle.textContent = title;
                this.dom.deleteConfirmMessage.textContent = message;
                this.dom.deleteConfirmModal.classList.remove('hidden');
            },
            
            async handleConfirmDelete() {
                const { id, type, index, permanent } = this.state.itemToDelete;
                this.dom.deleteConfirmModal.classList.add('hidden');

                if (type === 'summaryRecord' && index !== null) {
                    this.state.currentSessionRecords.splice(index, 1);
                    const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                    if (this.state.liveSummaryPage > totalPages) {
                        this.state.liveSummaryPage = totalPages > 0 ? totalPages : 1;
                    }
                    this.renderLiveSummary();
                    this.showToast('Registro eliminado del resumen.');
                } else if (type === 'clearAllSummary') {
                    this.state.currentSessionRecords = [];
                    this.state.liveSummaryPage = 1;
                    this.renderLiveSummary();
                    this.showToast('Resumen de carga borrado.');
                } else if (id && type) {
                    await this.moveItemToRecycleBin(id, type, permanent);
                }
                
                this.state.itemToDelete = { id: null, type: null, index: null, permanent: false };
            },

            async moveItemToRecycleBin(id, type, permanent) {
                this.showLoading(true);
                let docRef;
                const collectionName = {
                    'session': 'sessions',
                    'expense': 'expenses',
                }[type];

                if (!collectionName) {
                    this.showLoading(false);
                    return;
                }

                docRef = doc(this.state.db, collectionName, id);

                try {
                    if (permanent) {
                        await deleteDoc(docRef);
                         if (type === 'session') {
                            const recordsSnapshot = await getDocs(collection(docRef, 'records'));
                            const batch = writeBatch(this.state.db);
                            recordsSnapshot.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();
                          }
                        this.showToast('Elemento eliminado permanentemente.');
                    } else {
                        await updateDoc(docRef, {
                            deleted: true,
                            deletedAt: serverTimestamp()
                        });
                        this.showToast('Elemento movido a la papelera.');
                    }
                } catch (error) {
                    console.error(`Error al procesar el elemento:`, error);
                    this.showToast('Error al procesar el elemento.', 'error');
                } finally {
                    this.showLoading(false);
                    if(this.dom.recycleBinScreen.classList.contains('active-screen')){
                          this.renderRecycleBin(); // Refresh recycle bin view
                    }
                }
            },
            
            // --- LÓGICA DE EGRESOS ---
            showExpenseScreen() {
                this.state.showAllExpenses = false;
                this.dom.expenseForm.reset();
                document.getElementById('expenseDate').valueAsDate = new Date();
                this.dom.expenseFormTitle.textContent = 'Nuevo Egreso';
                this.dom.expenseFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Confirmar Egreso</button>`;
                this.state.expenseToEditId = null;
                this.renderExpenses();
                this.showScreen('expenseScreen');
            },

            loadExpensesFromFirestore() {
                if (this.state.unsubscribeExpenses) this.state.unsubscribeExpenses();
                const expensesColRef = collection(this.state.db, "expenses");
                this.state.unsubscribeExpenses = onSnapshot(query(expensesColRef), (snapshot) => {
                    const allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.expenses = allExpenses.filter(expense => expense.deleted !== true);
                    this.state.expenses.sort((a, b) => b.date.localeCompare(a.date));
                    if (document.getElementById('expenseScreen').classList.contains('active-screen')) {
                        this.renderExpenses();
                    }
                });
            },

            renderExpenses() {
                this.dom.expenseListContainer.innerHTML = '';
                const expenses = this.state.expenses;
                if (expenses.length === 0) {
                    this.dom.expenseListContainer.innerHTML = '<p class="text-center text-gray-500">No hay egresos registrados.</p>';
                    return;
                }
                const expensesToShow = this.state.showAllExpenses ? expenses : expenses.slice(0, 3);
                expensesToShow.forEach(expense => {
                    const expenseDiv = document.createElement('div');
                    expenseDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    expenseDiv.innerHTML = `<div><p class="font-semibold text-gray-800">${expense.description}</p><p class="text-sm text-gray-600">${this.formatDateForId(expense.date)} - ${this.formatCurrency(parseFloat(expense.amount))} (${expense.type})</p></div><div class="flex gap-2"><button onclick="App.editExpense('${expense.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${expense.id}', 'expense')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button></div>`;
                    this.dom.expenseListContainer.appendChild(expenseDiv);
                });
                if (!this.state.showAllExpenses && expenses.length > 3) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                    seeMoreButton.textContent = 'Ver más';
                    seeMoreButton.onclick = () => { this.state.showAllExpenses = true; this.renderExpenses(); };
                    this.dom.expenseListContainer.appendChild(seeMoreButton);
                }
            },
            
            async handleExpenseFormSubmit() {
                const formData = new FormData(this.dom.expenseForm);
                const amountValue = formData.get('expenseAmount');
                const expenseData = {
                    date: formData.get('expenseDate'),
                    description: formData.get('expenseDescription'),
                    amount: this.getNumericValue(amountValue),
                    type: formData.get('expenseType'),
                    deleted: false
                };
                this.showLoading(true);
                try {
                    if (this.state.expenseToEditId) {
                        await updateDoc(doc(this.state.db, "expenses", this.state.expenseToEditId), expenseData);
                        this.showToast('Egreso modificado.');
                    } else {
                        await addDoc(collection(this.state.db, "expenses"), expenseData);
                        this.showToast('Egreso guardado.');
                    }
                    this.showExpenseScreen();
                } catch (error) {
                    console.error("Error al guardar el egreso:", error);
                    this.showToast('Error al guardar el egreso.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            editExpense(expenseId) {
                const expense = this.state.expenses.find(e => e.id === expenseId);
                if (!expense) return;
                this.state.expenseToEditId = expenseId;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount.toLocaleString('es-ES');
                document.getElementById('expenseType').value = expense.type;
                this.dom.expenseFormTitle.textContent = 'Modificar Egreso';
                this.dom.expenseFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button><button type="button" onclick="App.showExpenseScreen()" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>`;
                window.scrollTo(0, 0);
            },
            
            loadDeletedItemsFromFirestore() {
                if (this.state.unsubscribeDeleted) this.state.unsubscribeDeleted();
                
                const collectionsToWatch = {
                    'sessions': 'session',
                    'expenses': 'expense',
                };
                let allDeletedItems = [];

                const listeners = Object.keys(collectionsToWatch).map(colName => {
                    const q = query(collection(this.state.db, colName), where("deleted", "==", true));
                    return onSnapshot(q, (snapshot) => {
                        const type = collectionsToWatch[colName];
                        const itemsFromCol = snapshot.docs.map(doc => ({
                            id: doc.id,
                            type: type,
                            data: doc.data()
                        }));

                        allDeletedItems = allDeletedItems.filter(item => item.type !== type);
                        allDeletedItems.push(...itemsFromCol);
                        
                        this.state.deletedItems = allDeletedItems.sort((a,b) => b.data.deletedAt.toMillis() - a.data.deletedAt.toMillis());
                        
                        if (this.dom.recycleBinScreen.classList.contains('active-screen')) {
                            this.renderRecycleBin();
                        }
                    });
                });
                
                this.state.unsubscribeDeleted = () => listeners.forEach(unsub => unsub());
            },

             // --- NUEVA PANTALLA DE REPORTE Y CONFIGURACIÓN ---
            async loadAppConfig() {
                const configDocRef = doc(this.state.db, "config", "app_settings");
                try {
                    const docSnap = await getDoc(configDocRef);
                    if (docSnap.exists()) {
                        const dbConfig = docSnap.data();
                        this.state.config = { ...this.state.config, ...dbConfig };
                    } else {
                        console.log("No se encontró configuración en DB, usando defaults.");
                    }
                } catch (error) {
                    console.error("Error al cargar la configuración:", error);
                    this.showToast('No se pudo cargar la configuración.', 'error');
                }
            },

            async saveBalanceConfig() {
                this.showLoading(true);
                const configToSave = {
                    bancoDepositado: this.getNumericValue(this.dom.depositoBancoInput.value)
                };
                const configDocRef = doc(this.state.db, "config", "app_settings");
                try {
                    await setDoc(configDocRef, configToSave, { merge: true });
                    this.state.config.bancoDepositado = configToSave.bancoDepositado;
                    this.showToast('Monto del depósito guardado.');
                } catch (error) {
                    console.error("Error al guardar la configuración:", error);
                    this.showToast('Error al guardar el monto.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            showSimpleBalanceScreen() {
                const allRecordsRaw = this.state.allSessions.flatMap(session => session.records);
                
                const consolidatedRecords = this._consolidateBonoRecords(allRecordsRaw);
                let totalIngresos = 0;
                
                consolidatedRecords.forEach(record => {
                    const monto = record.cuotas === '2' ? this.state.config.BONO_PRICE_TWO_INSTALLMENTS : this.state.config.BONO_PRICE_ONE_INSTALLMENT;
                    totalIngresos += monto;
                });

                const totalSold = consolidatedRecords.length;
                const totalPrinted = this.state.config.totalPrinted;
                const remainingToSell = totalPrinted - totalSold;

                let totalEgresos = 0;
                this.state.expenses.forEach(expense => {
                    totalEgresos += parseFloat(expense.amount || 0);
                });

                // Cache values for live calculation
                this.state.simpleBalanceCache.totalIngresos = totalIngresos;
                this.state.simpleBalanceCache.totalEgresos = totalEgresos;

                // Populate UI
                this.dom.balanceBonosVendidos.textContent = totalSold;
                this.dom.balanceBonosFaltantes.textContent = remainingToSell;
                this.dom.totalIngresosBonos.textContent = this.formatCurrency(totalIngresos);
                this.dom.totalEgresosGeneral.textContent = `-${this.formatCurrency(totalEgresos)}`;
                
                this.dom.depositoBancoInput.value = this.state.config.bancoDepositado.toLocaleString('es-ES');
                
                this.recalculateSimpleBalance(); // Initial calculation

                this.showScreen('simpleBalanceScreen');
            },

            recalculateSimpleBalance() {
                const totalIngresos = this.state.simpleBalanceCache.totalIngresos;
                const totalEgresos = this.state.simpleBalanceCache.totalEgresos;
                const depositoBanco = this.getNumericValue(this.dom.depositoBancoInput.value);

                const depositosPorTransferencia = totalIngresos - totalEgresos - depositoBanco;

                this.dom.depositosPorTransferencia.textContent = this.formatCurrency(depositosPorTransferencia);
            },

            _getRecordMonto(record) {
                if (record.cuotas == '2') { // A full payment record
                    return this.state.config.BONO_PRICE_TWO_INSTALLMENTS;
                }
                // An installment payment record
                return this.state.config.BONO_PRICE_ONE_INSTALLMENT;
            },
    
            _consolidateBonoRecords(rawRecords) {
                const bonosGrouped = new Map();

                for (const record of rawRecords) {
                    const bonoNro1 = String(record.bonoNro1 || '').trim();
                    const bonoNro2 = String(record.bonoNro2 || '').trim();

                    if (bonoNro1.length < 1 || bonoNro2.length < 1) continue;

                    const key = `${bonoNro1}-${bonoNro2}`;
                    if (!bonosGrouped.has(key)) {
                        bonosGrouped.set(key, []);
                    }
                    bonosGrouped.get(key).push(record);
                }

                const definitiveBonos = [];

                for (const [key, records] of bonosGrouped.entries()) {
                    records.sort((a, b) => a.fecha.localeCompare(b.fecha));
                    
                    const firstRecord = { ...records[0] }; 

                    const hasCuota2 = records.some(r => String(r.cuotas) === '2');
                    const cuota1Count = records.filter(r => String(r.cuotas) === '1').length;

                    if (hasCuota2 || cuota1Count >= 2) {
                        firstRecord.cuotas = '2'; 
                    } else {
                        firstRecord.cuotas = '1';
                    }
                    
                    firstRecord.tipoPago = records[records.length - 1].tipoPago;

                    definitiveBonos.push(firstRecord);
                }

                return definitiveBonos;
            },

            downloadAllLoadsPDF() {
                const doc = new jsPDF();
                this.addPdfHeader(doc, "Reporte Completo de Bonos");
                
                let allRecordsRaw = [];
                this.state.allSessions.forEach(session => {
                    allRecordsRaw = allRecordsRaw.concat(session.records);
                });

                const consolidatedRecords = this._consolidateBonoRecords(allRecordsRaw);

                const sortedRecords = consolidatedRecords.sort((a, b) => {
                    const numA1 = parseInt(a.bonoNro1, 10);
                    const numB1 = parseInt(b.bonoNro1, 10);
                    if (numA1 !== numB1) {
                        return numA1 - numB1;
                    }
                    const numA2 = parseInt(a.bonoNro2, 10);
                    const numB2 = parseInt(b.bonoNro2, 10);
                    return numA2 - numB2;
                });

                const head = [['Nro Bono', 'Nombre', 'Teléfono', 'Vendedor', 'Último Pago', 'Estado', 'Monto Total']];
                const body = sortedRecords.map(record => {
                    const monto = record.cuotas === '2' ? this.state.config.BONO_PRICE_TWO_INSTALLMENTS : this.state.config.BONO_PRICE_ONE_INSTALLMENT;
                    const estado = record.cuotas === '2' ? 'Pago Total' : '1ra Cuota';
                    return [
                        `${record.bonoNro1}-${record.bonoNro2}`,
                        record.nombre,
                        record.telefono,
                        record.vendedor,
                        record.tipoPago,
                        estado,
                        this.formatCurrency(monto)
                    ];
                });
                
                doc.autoTable({
                    head: head,
                    body: body,
                    startY: 45,
                    theme: 'grid',
                    headStyles: { fillColor: [46, 64, 83] }
                });
                
                const currentDate = this.getCurrentDateFormatted();
                doc.save(`reporte_completo_bonos_${currentDate}.pdf`);
            },

            downloadSessionPDF(sessionId) {
                const session = sessionId ? this.state.allSessions.find(s => s.id === sessionId) : { records: this.state.currentSessionRecords, id: this.formatDateForId(this.state.currentSessionRecords[0].fecha) };
                if (!session || session.records.length === 0) {
                    this.showToast('No hay datos para generar el PDF.', 'error');
                    return;
                }

                const doc = new jsPDF();
                const displayId = session.id.replace(/-/g, '/');
                this.addPdfHeader(doc, `Detalle de Carga - ${displayId}`);
                
                const head = [['Nro Bono', 'Nombre', 'Teléfono', 'Vendedor', 'Pago', 'Cuotas', 'Monto']];
                
                const sortedRecords = session.records.sort((a, b) => {
                    const numA1 = parseInt(a.bonoNro1, 10);
                    const numB1 = parseInt(b.bonoNro1, 10);
                    if (numA1 !== numB1) {
                        return numA1 - numB1;
                    }
                    const numA2 = parseInt(a.bonoNro2, 10);
                    const numB2 = parseInt(b.bonoNro2, 10);
                    return numA2 - numB2;
                });

                const body = sortedRecords.map(record => {
                    const monto = this._getRecordMonto(record);
                    return [
                        `${record.bonoNro1}-${record.bonoNro2}`,
                        record.nombre,
                        record.telefono,
                        record.vendedor,
                        record.tipoPago,
                        record.cuotas,
                        this.formatCurrency(monto)
                    ];
                });
                
                doc.autoTable({
                    head: head,
                    body: body,
                    startY: 45,
                    theme: 'grid'
                });

                const currentDate = this.getCurrentDateFormatted();
                doc.save(`detalle_carga_${displayId.replace(/\//g, '-')}_${currentDate}.pdf`);
            },

            downloadDetailedBalancePDF() {
                const doc = new jsPDF();
                this.addPdfHeader(doc, "Balance Detallado");

                let allRecordsRaw = this.state.allSessions.flatMap(session => session.records);
                const consolidatedRecords = this._consolidateBonoRecords(allRecordsRaw);

                // Sales by vendor
                const salesByVendor = {};
                consolidatedRecords.forEach(record => {
                    const vendorKey = (record.vendedor || 'Desconocido').trim().toLowerCase();
                    if (!salesByVendor[vendorKey]) {
                        salesByVendor[vendorKey] = { count: 0, total: 0, originalName: record.vendedor || 'Desconocido' };
                    }
                    salesByVendor[vendorKey].count++;
                    salesByVendor[vendorKey].total += record.cuotas === '2' ? this.state.config.BONO_PRICE_TWO_INSTALLMENTS : this.state.config.BONO_PRICE_ONE_INSTALLMENT;
                });

                const vendorBody = Object.values(salesByVendor).map(data => [
                    data.originalName, data.count, this.formatCurrency(data.total)
                ]);

                doc.setFontSize(14);
                doc.text("Resumen de Ventas por Vendedor", 14, 50);
                doc.autoTable({
                    head: [['Vendedor', 'Bonos Vendidos', 'Monto Total']],
                    body: vendorBody,
                    startY: 55,
                    theme: 'grid'
                });

                let lastY = doc.autoTable.previous.finalY + 15;

                // General Summary
                const totalSold = consolidatedRecords.length;
                const totalPrinted = this.state.config.totalPrinted;
                const remainingToSell = totalPrinted - totalSold;
                
                doc.setFontSize(14);
                doc.text("Resumen General", 14, lastY);

                const summaryBody = [
                    ['Bonos Vendidos', totalSold.toString()],
                    ['Bonos Faltantes', remainingToSell.toString()],
                    ['Total Ingresos (Bonos)', this.formatCurrency(this.state.simpleBalanceCache.totalIngresos)],
                    ['Total Egresos', `-${this.formatCurrency(this.state.simpleBalanceCache.totalEgresos)}`],
                    ['Depósito en Banco', this.formatCurrency(this.getNumericValue(this.dom.depositoBancoInput.value))]
                ];

                doc.autoTable({
                    body: summaryBody,
                    startY: lastY + 5,
                    theme: 'grid',
                    styles: { fontStyle: 'bold' },
                     columnStyles: {
                        0: { fillColor: [230, 230, 230] },
                    },
                    didDrawCell: (data) => {
                        if (data.row.index === 1) { // Bonos Faltantes
                             doc.setTextColor(255, 0, 0);
                        }
                    },
                    willDrawCell: (data) => {
                         doc.setTextColor(0, 0, 0);
                    }
                });

                lastY = doc.autoTable.previous.finalY + 15;

                // Chapel notes
                doc.setFontSize(12);
                doc.text("Distribución a Capillas:", 14, lastY);
                doc.setFontSize(10);
                doc.text("- Capilla Itatí: $1,000,000", 14, lastY + 7);
                doc.text("- Capilla La Merced: $1,000,000", 14, lastY + 14);
                doc.text("- Capilla Cruz de los Milagros: $1,000,000", 14, lastY + 21);

                const currentDate = this.getCurrentDateFormatted();
                doc.save(`balance_detallado_${currentDate}.pdf`);
            },
            
            addPdfHeader(doc, title) {
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text("Parroquia San José Bono", 15, 20);

                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(title, 15, 30);

                doc.setFontSize(10);
                doc.text(this.getCurrentDateFormatted(), doc.internal.pageSize.getWidth() - 15, 20, { align: 'right' });

                doc.setDrawColor(180, 180, 180);
                doc.line(15, 35, doc.internal.pageSize.getWidth() - 15, 35);

                return 45;
            },

            showToast(message, type = 'success') {
                const toastContainer = this.dom.toastContainer;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                try {
                    const synth = new Tone.Synth().toDestination();
                    if (type === 'success') {
                        synth.triggerAttackRelease("C5", "8n", Tone.now());
                    } else if (type === 'error') {
                        synth.triggerAttackRelease("A3", "8n", Tone.now());
                    }
                } catch (e) {
                    console.warn("No se pudo reproducir el sonido, puede requerir interacción del usuario primero.");
                }

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            updateVendedoresList() {
                const vendedores = new Set();
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        if (record.vendedor) {
                            vendedores.add(record.vendedor);
                        }
                    });
                });

                this.dom.vendedoresList.innerHTML = '';
                [...vendedores].sort().forEach(vendedor => {
                    const option = document.createElement('option');
                    option.value = vendedor;
                    this.dom.vendedoresList.appendChild(option);
                });
            },

            formatCurrencyInput(event) {
                const input = event.target;
                let value = input.value.replace(/\./g, '');
                if (isNaN(value) || value === '') {
                    input.value = '';
                    return;
                }
                if (/[^0-9]/.test(value)) {
                    value = value.replace(/[^0-9]/g, '');
                }
                const number = parseInt(value, 10);
                input.value = number.toLocaleString('es-ES');
            },

            getNumericValue(formattedValue) {
                if (!formattedValue || typeof formattedValue !== 'string') return 0;
                const cleanValue = formattedValue.replace(/\./g, '').replace(/,/g, '.'); // Handle decimals if needed in future
                return parseInt(cleanValue, 10) || 0;
            },

            formatCurrency(amount) {
                return amount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            },

            getCurrentDateFormatted() {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                return `${day}-${month}-${year}`;
            },

            formatDateForId(dateString, useSafeFormat = false) {
                if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
                const [year, month, day] = dateString.split('-');
                const separator = useSafeFormat ? '-' : '/';
                return `${day}${separator}${month}${separator}${year}`;
            },

            formatTimestamp(timestamp) {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                const date = timestamp.toDate();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            parseIdToDate(idString) {
                if (!idString || !/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(idString)) return idString;
                const parts = idString.split(/[-\/]/);
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            },
        };

        window.onload = function() {
            window.App.init();
        };

    </script>
</body>
</html>

