<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parroquia San José Bono - Carga de Datos</title>
    <!-- Favicon con el logo de la parroquia -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/vTQjffhK/NUEVO-LOGO.png">
    <!-- Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF para la generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Tone.js para efectos de sonido -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        /* Ocultar flechas en inputs numéricos */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .screen { display: none; } /* Clase de ayuda para gestionar las vistas */
        #loginScreen.active-screen { display: flex; } /* Regla específica para usar flexbox en la pantalla de inicio de sesión */
        .active-screen { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para notificaciones "Toast" */
        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateX(100%);
            animation: slideInAndOut 3s forwards;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .toast-success { background-color: #16a34a; }
        .toast-error { background-color: #dc2626; }
        @keyframes slideInAndOut {
            0% { opacity: 0; transform: translateX(100%); }
            15% { opacity: 1; transform: translateX(0); }
            85% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen p-4">

    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <div class="w-full max-w-lg relative">
        <datalist id="vendedoresList"></datalist>
        <!-- Indicador de Carga -->
        <div id="loadingIndicator" class="hidden">
            <div class="loader"></div>
        </div>

        <!-- 0. Pantalla de Inicio de Sesión -->
        <div id="loginScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in flex-col items-center justify-center active-screen">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Bono "Sembradores de Esperanza"</h2>
            <h1 class="text-3xl font-bold text-gray-800 mb-1 text-center">Bienvenido</h1>
            <p class="text-gray-600 mb-6 text-center">Ingrese sus credenciales para continuar.</p>
            <div class="w-full max-w-xs">
                <form id="loginForm" class="space-y-4">
                    <input type="email" id="emailInput" class="w-full text-center px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Correo Electrónico" required>
                    <div class="relative">
                        <input type="password" id="passwordInput" class="w-full text-center px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Contraseña" required>
                        <button type="button" id="passwordToggle" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500 hover:text-gray-700">
                            <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 1.274-4.057 5.064 7 9.542 7 .847 0 1.673.126 2.463.362m-7.916 5.242a3 3 0 014.242-4.242m-4.242 4.242L6 18m12-6h.008M18 6l-6 6" />
                            </svg>
                        </button>
                    </div>
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Ingresar</button>
                </form>
            </div>
        </div>


        <!-- 1. Pantalla Inicial -->
        <div id="initialScreen" class="screen p-8 space-y-4 bg-gray-50 rounded-xl shadow-lg text-center fade-in">
            <!-- Título actualizado con el logo -->
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-3">
                <img src="https://i.postimg.cc/vTQjffhK/NUEVO-LOGO.png" alt="Logo Parroquia" class="h-10">
                <span>Parroquia San José Bono</span>
            </h1>
            <p class="text-xl text-gray-600">"Sembradores de Esperanza"</p>
            <p id="welcomeMessage" class="text-lg text-gray-700"></p>
            
            <!-- Panel de Administrador (visible solo para admins) -->
            <div id="adminDashboard" class="hidden my-4 p-4 border rounded-lg bg-white text-left space-y-3">
                <h3 class="text-xl font-bold text-gray-800 text-center mb-2">Panel de Administrador</h3>
                <div>
                    <div class="flex justify-between items-center text-green-600">
                        <span class="font-semibold">Ingresos del Mes:</span>
                        <span id="monthlyIncome" class="font-bold text-lg"></span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center text-red-600">
                        <span class="font-semibold">Egresos del Mes:</span>
                        <span id="monthlyExpenses" class="font-bold text-lg"></span>
                    </div>
                </div>
                <hr>
                <div>
                    <div class="flex justify-between items-center text-gray-800">
                        <span class="font-semibold text-lg">Balance General:</span>
                        <span id="totalBalance" class="font-extrabold text-xl"></span>
                    </div>
                </div>
            </div>

            <div id="authError" class="hidden p-4 my-4 text-sm text-red-700 bg-red-100 rounded-lg text-left"></div>
            <div id="mainButtons" class="space-y-4">
                <button id="goToFormButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">
                    Nueva Carga
                </button>
                <button id="goToHistoryButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">
                    Historial de Carga
                </button>
                <button id="goToVendedorBonoButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800 rounded-lg">
                    Bonos por Vendedor
                </button>
                <button id="goToBankButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-cyan-500 to-cyan-700 hover:from-cyan-600 hover:to-cyan-800 rounded-lg">
                    Banco
                </button>
                <button id="goToExpenseButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">
                    Egresos
                </button>
                <button id="goToBalanceButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-orange-500 to-orange-700 hover:from-orange-600 hover:to-orange-800 rounded-lg">
                    Balance
                </button>
                 <button id="goToWinnerButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-purple-500 to-purple-700 hover:from-purple-600 hover:to-purple-800 rounded-lg">
                    Gestionar Sorteo
                </button>
                 <button id="goToRecycleBinButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-yellow-500 to-yellow-700 hover:from-yellow-600 hover:to-yellow-800 rounded-lg">
                    Papelera
                </button>
                <button id="logoutButton" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cerrar Sesión</button>
            </div>
        </div>

        <!-- 2. Pantalla de Formulario de Entrada de Datos -->
        <div id="formScreen" class="screen p-6 sm:p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 id="formTitle" class="text-2xl font-bold text-gray-800 mb-6 text-center">Cargar Datos del Bono</h2>
            
            <!-- Formulario de Carga -->
            <form id="dataForm" class="space-y-4">
                <div>
                    <label for="fecha" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="fecha" name="fecha" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" readonly>
                </div>
                <div>
                    <label for="vendedor" class="block text-sm font-medium text-gray-700">Vendedor</label>
                    <input type="text" id="vendedor" name="vendedor" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Nombre del Vendedor" list="vendedoresList">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Números de Bonos</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-1/2">
                            <label for="bonoNro1" class="text-xs text-gray-500">Nro. 1</label>
                            <input type="number" id="bonoNro1" name="bonoNro1" required placeholder="000" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="w-1/2">
                            <label for="bonoNro2" class="text-xs text-gray-500">Nro. 2</label>
                            <input type="number" id="bonoNro2" name="bonoNro2" required placeholder="999" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <div>
                    <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre y Apellido</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Juan Pérez" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="tel" id="telefono" name="telefono" required placeholder="3772..." class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="tipoPago" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                    <select id="tipoPago" name="tipoPago" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div>
                    <label for="cuotas" class="block text-sm font-medium text-gray-700">Cuotas Abonadas</label>
                    <select id="cuotas" name="cuotas" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>

                <!-- Botones de Acción del Formulario -->
                <div id="formActions" class="pt-4 grid grid-cols-2 gap-4">
                    <!-- Estos botones se actualizarán dinámicamente con JS -->
                </div>
            </form>

            <!-- Línea divisoria -->
            <hr class="my-6 border-gray-200">

            <!-- Sección de Resumen en Vivo -->
            <div>
                <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Resumen de Carga Actual</h3>
                <div id="liveSummaryContainer" class="space-y-3 p-3 bg-white rounded-lg border min-h-[210px]">
                    <!-- Los bonos cargados aparecerán aquí -->
                </div>
                <div id="liveSummaryPagination" class="mt-4 flex justify-center items-center gap-4">
                    <!-- La paginación se renderizará aquí -->
                </div>
                <div id="liveSummaryTotals" class="mt-4 text-right font-semibold text-gray-800">
                    <!-- Los totales se mostrarán aquí -->
                </div>
            </div>

            <!-- Línea divisoria -->
            <hr class="my-6 border-gray-200">

            <!-- Acciones Finales de la Sesión -->
            <div id="sessionActions" class="space-y-3">
                <button id="confirmAllButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Confirmar carga de bonos</button>
                <button id="clearAllButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Borrar Todo</button>
                <button id="goBackToInitialScreenButton" class="w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver</button>
            </div>
        </div>


        <!-- 3. Pantalla de Detalles Finales -->
        <div id="detailsScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 id="detailsTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center">Detalle de Carga</h2>
            <div id="detailsListContainer" class="mb-6 max-h-80 overflow-y-auto p-3 bg-white rounded-lg border"></div>
            <div id="summaryContainer" class="mb-6 p-4 bg-gray-100 rounded-lg space-y-2 text-lg"></div>
            <div id="detailsActions" class="space-y-3"></div>
        </div>
        
        <!-- 4. Pantalla de Historial -->
        <div id="historyScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Historial de Cargas</h2>
            <div id="historyListContainer" class="mb-6 max-h-96 overflow-y-auto space-y-3"></div>
            <button id="downloadAllLoadsPdfButton" class="w-full mb-2 px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Descargar PDF de todas las cargas</button>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>
        </div>

        <!-- 7. Pantalla de Balance -->
        <div id="balanceScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Balance General</h2>
            <div id="balanceListContainer" class="mb-6 max-h-80 overflow-y-auto p-3 bg-white rounded-lg border"></div>
            <div id="balanceSummaryContainer" class="mb-6 p-4 bg-gray-100 rounded-lg space-y-2 text-base"></div>
            <div class="space-y-3 mt-4">
                <button id="downloadBalanceSummaryPdfButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Descargar Resumen (PDF)</button>
                <button id="downloadBalancePdfButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">Descargar Detalle Completo (PDF)</button>
                <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
            </div>
        </div>
        
        <!-- 8. Pantalla de Banco -->
        <div id="bankScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Banco</h2>
            <form id="bankForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700" id="bankFormTitle">Nuevo Depósito</h3>
                <div>
                    <label for="bankDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="bankDate" name="bankDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" readonly>
                </div>
                <div>
                    <label for="bankAmount" class="block text-sm font-medium text-gray-700">Importe</label>
                    <input type="text" inputmode="numeric" id="bankAmount" name="bankAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="bankType" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="bankType" name="bankType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="bankFormActions">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-cyan-500 to-cyan-700 hover:from-cyan-600 hover:to-cyan-800 rounded-lg">Confirmar</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Depósitos Registrados</h3>
            <div id="bankDepositsListContainer" class="mb-6 space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

        <!-- 9. Pantalla de Egresos -->
        <div id="expenseScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Egresos</h2>
            <form id="expenseForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700" id="expenseFormTitle">Nuevo Egreso</h3>
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="expenseDate" name="expenseDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="expenseDescription" name="expenseDescription" required placeholder="Ej: Compra de insumos" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-gray-700">Importe</label>
                    <input type="text" inputmode="numeric" id="expenseAmount" name="expenseAmount" required placeholder="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div>
                    <label for="expenseType" class="block text-sm font-medium text-gray-700">Tipo de Pago</label>
                    <select id="expenseType" name="expenseType" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                <div id="expenseFormActions">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Confirmar Egreso</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Egresos Registrados</h3>
            <div id="expenseListContainer" class="mb-6 space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

        <!-- 10. Pantalla de Bonos por Vendedor -->
        <div id="vendedorBonoScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Asignar Bonos a Vendedor</h2>
            <form id="vendedorBonoForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700" id="vendedorBonoFormTitle">Nueva Asignación</h3>
                <div>
                    <label for="vendedorBonoNombre" class="block text-sm font-medium text-gray-700">Nombre del Vendedor</label>
                    <input type="text" id="vendedorBonoNombre" name="vendedorBonoNombre" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Nombre del Vendedor" list="vendedoresList">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Rango de Bonos Asignados</label>
                    <div class="flex items-center gap-4 mt-1">
                        <div class="w-1/2">
                            <label for="vendedorBonoNro1" class="text-xs text-gray-500">Desde Nro.</label>
                            <input type="number" id="vendedorBonoNro1" name="vendedorBonoNro1" required placeholder="000" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                        <div class="w-1/2">
                            <label for="vendedorBonoNro2" class="text-xs text-gray-500">Hasta Nro.</label>
                            <input type="number" id="vendedorBonoNro2" name="vendedorBonoNro2" required placeholder="999" oninput="this.value = this.value.slice(0, 3);" class="block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <div id="vendedorBonoFormActions">
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800 rounded-lg">Confirmar Asignación</button>
                </div>
            </form>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Historial de Asignaciones</h3>
            <div id="vendedorBonoHistoryContainer" class="mb-6 max-h-80 overflow-y-auto space-y-4"></div>
            
            <!-- SECCIÓN DE CONSULTA MODIFICADA -->
            <hr class="my-8 border-gray-300">
            <div id="vendedorReportSection">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Consulta y Reportes</h2>
                <div class="space-y-4 mb-6 p-4 border rounded-lg">
                    <div>
                        <label for="reportType" class="block text-sm font-medium text-gray-700">Consultar por:</label>
                        <select id="reportType" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                            <option value="vendedor">Nombre de Vendedor</option>
                            <option value="numero">Rango de Números de Bono</option>
                        </select>
                    </div>
                    <div id="reportInputContainer">
                        <!-- El input cambiará dinámicamente -->
                    </div>
                    <button id="runReportButton" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Consultar</button>
                </div>
                <div id="vendedorReportResultContainer" class="p-4 bg-white rounded-lg border min-h-[100px]">
                    <!-- Los resultados de la consulta aparecerán aquí -->
                </div>
                <button id="downloadVendedorReportPdfButton" class="hidden w-full mt-4 px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Descargar PDF del Reporte</button>
            </div>
            <!-- FIN SECCIÓN MODIFICADA -->

            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-8 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>

        <!-- 11. Pantalla de Papelera de Reciclaje -->
        <div id="recycleBinScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Papelera de Reciclaje</h2>
            <div id="recycleBinListContainer" class="mb-6 max-h-96 overflow-y-auto space-y-3"></div>
            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>
        </div>
        
        <!-- 12. Pantalla de Gestión de Ganadores (NUEVA) -->
        <div id="winnerScreen" class="screen p-8 bg-gray-50 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Gestión de Sorteo</h2>
            <form id="winnerForm" class="space-y-4 mb-6 p-4 border rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700">Buscar Ganador</h3>
                <div>
                    <label for="winnerNumberInput" class="block text-sm font-medium text-gray-700">Número de Bono Ganador</label>
                    <input type="number" id="winnerNumberInput" placeholder="000" oninput="this.value = this.value.slice(0, 3);" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                 <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-purple-500 to-purple-700 hover:from-purple-600 hover:to-purple-800 rounded-lg">Buscar</button>
            </form>
            
            <div id="winnerResultContainer" class="mb-6 p-4 bg-white rounded-lg border min-h-[100px]">
                 <!-- Resultado de la búsqueda del ganador -->
            </div>

            <hr class="my-6 border-gray-300">

            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Historial de Ganadores</h3>
             <div id="pastWinnersContainer" class="mb-6 max-h-80 overflow-y-auto space-y-3">
                 <!-- Lista de ganadores anteriores -->
            </div>

            <button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-2 mt-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Volver al Inicio</button>
        </div>


    </div>

    <!-- Modales de la aplicación -->
    <div id="dateConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-gray-50 fade-in">
            <div class="text-center">
                <h3 id="dateConfirmTitle" class="text-2xl font-bold text-gray-900">Confirmar Fecha</h3>
                <div class="mt-4">
                    <label for="modalDateInput" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="modalDateInput" name="modalDateInput" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500">
                </div>
                <div class="mt-6 space-y-3">
                    <button id="confirmDateButton" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Confirmar</button>
                    <button id="cancelDateButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmAllModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative mx-auto p-8 border w-full max-w-md shadow-lg rounded-xl bg-gray-50 fade-in">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900">Confirmar Carga Final</h3>
                <div id="finalConfirmationData" class="mt-4 text-center space-y-2 text-gray-700"></div>
                <div class="mt-6 space-y-3">
                    <button id="saveAndFinishButton" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar y Guardar</button>
                    <button id="goBackToFormButton" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Volver</button>
                </div>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-50 p-6 rounded-lg shadow-xl text-center fade-in">
            <h3 id="deleteConfirmTitle" class="text-lg font-bold text-gray-900">Confirmar Acción</h3>
            <p id="deleteConfirmMessage" class="text-sm text-gray-600 my-4">Esta operación no puede revertirse.</p>
            <div class="flex justify-center gap-4">
                <button id="cancelDeleteButton" class="px-5 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Volver</button>
                <button id="confirmDeleteButton" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Importar módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDocs, deleteDoc, onSnapshot, query, writeBatch, updateDoc, enableIndexedDbPersistence, serverTimestamp, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Inicialización de la Aplicación ---
        const { jsPDF } = window.jspdf;
        
        window.App = {
            // --- ESTADO GLOBAL ---
            state: {
                currentUser: null,
                isAdmin: false,
                currentSessionRecords: [],
                allSessions: [],
                bankDeposits: [],
                expenses: [],
                vendedorBonos: [],
                deletedItems: [], // Para la papelera
                vendedorReportData: null,
                balanceData: null, // <-- OPTIMIZATION: Store calculated balance data
                recordToEditIndex: null,
                depositToEditId: null,
                expenseToEditId: null,
                vendedorBonoToEditId: null,
                editOrigin: null,
                itemToDelete: { id: null, type: null, index: null, permanent: false },
                sessionToEditId: null,
                sessionToEditRawDate: null, 
                winnersData: [],
                searchResult: null, 
                db: null,
                auth: null,
                userId: null,
                unsubscribeHistory: null,
                unsubscribeBank: null,
                unsubscribeExpenses: null,
                unsubscribeVendedorBonos: null,
                unsubscribeDeleted: null,
                unsubscribeWinners: null, // NUEVO
                showAllDeposits: false,
                showAllExpenses: false,
                showAllVendedorBonos: false,
                datePromptType: null,
                liveSummaryPage: 1,
                recordsPerPage: 3,
            },

            // --- INICIALIZACIÓN ---
            async init() {
                this.cacheDOMElements();
                this.bindEvents();
                this.showLoading(true);
                await this.initializeFirebase();
                this.updateReportInput(); // Inicializar el input de reporte
            },

            cacheDOMElements() {
                this.dom = {
                    html: document.documentElement,
                    screens: document.querySelectorAll('.screen'),
                    loginScreen: document.getElementById('loginScreen'),
                    loginForm: document.getElementById('loginForm'),
                    emailInput: document.getElementById('emailInput'),
                    passwordInput: document.getElementById('passwordInput'),
                    passwordToggle: document.getElementById('passwordToggle'),
                    eyeIcon: document.getElementById('eyeIcon'),
                    eyeOffIcon: document.getElementById('eyeOffIcon'),
                    dataForm: document.getElementById('dataForm'),
                    formTitle: document.getElementById('formTitle'),
                    formActions: document.getElementById('formActions'),
                    confirmAllModal: document.getElementById('confirmAllModal'),
                    finalConfirmationData: document.getElementById('finalConfirmationData'),
                    saveAndFinishButton: document.getElementById('saveAndFinishButton'),
                    goBackToFormButton: document.getElementById('goBackToFormButton'),
                    deleteConfirmModal: document.getElementById('deleteConfirmModal'),
                    deleteConfirmTitle: document.getElementById('deleteConfirmTitle'),
                    deleteConfirmMessage: document.getElementById('deleteConfirmMessage'),
                    dateConfirmModal: document.getElementById('dateConfirmModal'),
                    dateConfirmTitle: document.getElementById('dateConfirmTitle'),
                    modalDateInput: document.getElementById('modalDateInput'),
                    confirmDateButton: document.getElementById('confirmDateButton'),
                    cancelDateButton: document.getElementById('cancelDateButton'),
                    historyListContainer: document.getElementById('historyListContainer'),
                    detailsScreen: document.getElementById('detailsScreen'),
                    detailsListContainer: document.getElementById('detailsListContainer'),
                    summaryContainer: document.getElementById('summaryContainer'),
                    detailsActions: document.getElementById('detailsActions'),
                    detailsTitle: document.getElementById('detailsTitle'),
                    loadingIndicator: document.getElementById('loadingIndicator'),
                    authError: document.getElementById('authError'),
                    mainButtons: document.getElementById('mainButtons'),
                    welcomeMessage: document.getElementById('welcomeMessage'),
                    balanceScreen: document.getElementById('balanceScreen'),
                    balanceListContainer: document.getElementById('balanceListContainer'),
                    balanceSummaryContainer: document.getElementById('balanceSummaryContainer'),
                    downloadBalancePdfButton: document.getElementById('downloadBalancePdfButton'),
                    downloadBalanceSummaryPdfButton: document.getElementById('downloadBalanceSummaryPdfButton'), // NUEVO
                    goToBalanceButton: document.getElementById('goToBalanceButton'),
                    goToBankButton: document.getElementById('goToBankButton'),
                    logoutButton: document.getElementById('logoutButton'),
                    bankScreen: document.getElementById('bankScreen'),
                    bankForm: document.getElementById('bankForm'),
                    bankFormTitle: document.getElementById('bankFormTitle'),
                    bankFormActions: document.getElementById('bankFormActions'),
                    bankDepositsListContainer: document.getElementById('bankDepositsListContainer'),
                    expenseScreen: document.getElementById('expenseScreen'),
                    expenseForm: document.getElementById('expenseForm'),
                    expenseFormTitle: document.getElementById('expenseFormTitle'),
                    expenseFormActions: document.getElementById('expenseFormActions'),
                    expenseListContainer: document.getElementById('expenseListContainer'),
                    toastContainer: document.getElementById('toastContainer'),
                    goToExpenseButton: document.getElementById('goToExpenseButton'),
                    adminDashboard: document.getElementById('adminDashboard'),
                    monthlyIncome: document.getElementById('monthlyIncome'),
                    monthlyExpenses: document.getElementById('monthlyExpenses'),
                    totalBalance: document.getElementById('totalBalance'),
                    vendedoresList: document.getElementById('vendedoresList'),
                    liveSummaryContainer: document.getElementById('liveSummaryContainer'),
                    liveSummaryPagination: document.getElementById('liveSummaryPagination'),
                    liveSummaryTotals: document.getElementById('liveSummaryTotals'),
                    confirmAllButton: document.getElementById('confirmAllButton'),
                    clearAllButton: document.getElementById('clearAllButton'),
                    goBackToInitialScreenButton: document.getElementById('goBackToInitialScreenButton'),
                    bankAmountInput: document.getElementById('bankAmount'),
                    expenseAmountInput: document.getElementById('expenseAmount'),
                    goToVendedorBonoButton: document.getElementById('goToVendedorBonoButton'),
                    vendedorBonoScreen: document.getElementById('vendedorBonoScreen'),
                    vendedorBonoForm: document.getElementById('vendedorBonoForm'),
                    vendedorBonoFormTitle: document.getElementById('vendedorBonoFormTitle'),
                    vendedorBonoFormActions: document.getElementById('vendedorBonoFormActions'),
                    vendedorBonoHistoryContainer: document.getElementById('vendedorBonoHistoryContainer'),
                    vendedorReportSection: document.getElementById('vendedorReportSection'),
                    reportType: document.getElementById('reportType'),
                    reportInputContainer: document.getElementById('reportInputContainer'),
                    runReportButton: document.getElementById('runReportButton'),
                    vendedorReportResultContainer: document.getElementById('vendedorReportResultContainer'),
                    downloadVendedorReportPdfButton: document.getElementById('downloadVendedorReportPdfButton'),
                    recycleBinScreen: document.getElementById('recycleBinScreen'),
                    recycleBinListContainer: document.getElementById('recycleBinListContainer'),
                    goToRecycleBinButton: document.getElementById('goToRecycleBinButton'),
                    downloadAllLoadsPdfButton: document.getElementById('downloadAllLoadsPdfButton'),
                    // NUEVOS ELEMENTOS PARA GANADORES
                    goToWinnerButton: document.getElementById('goToWinnerButton'),
                    winnerScreen: document.getElementById('winnerScreen'),
                    winnerForm: document.getElementById('winnerForm'),
                    winnerNumberInput: document.getElementById('winnerNumberInput'),
                    winnerResultContainer: document.getElementById('winnerResultContainer'),
                    pastWinnersContainer: document.getElementById('pastWinnersContainer'),
                };
            },

            async initializeFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyAhV7Ri-DfYSQA_tgbDeSSGtpG74UNC10g",
                    authDomain: "bonosparroquia-30762.firebaseapp.com",
                    projectId: "bonosparroquia-30762",
                    storageBucket: "bonosparroquia-30762.appspot.com",
                    messagingSenderId: "24790926044",
                    appId: "1:24790926044:web:a4ee95475ba61c133baa19"
                };
                const app = initializeApp(firebaseConfig);
                this.state.db = getFirestore(app);
                this.state.auth = getAuth(app);

                try {
                    await enableIndexedDbPersistence(this.state.db);
                    console.log("Persistencia offline habilitada.");
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Múltiples pestañas abiertas, la persistencia offline solo se puede habilitar en una.");
                    } else if (err.code == 'unimplemented') {
                        console.warn("El navegador actual no soporta la persistencia offline.");
                    }
                }

                onAuthStateChanged(this.state.auth, (user) => {
                    this.showLoading(false);
                    if (user) {
                        this.login(user);
                        this.loadAllDataFromFirestore();
                    } else {
                        this.logoutCleanup();
                    }
                });
            },

            bindEvents() {
                this.dom.loginForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleLogin(); });
                this.dom.passwordToggle.addEventListener('click', () => this.togglePasswordVisibility());
                document.getElementById('goToFormButton').addEventListener('click', () => this.promptForDate('bono'));
                document.getElementById('goToHistoryButton').addEventListener('click', () => this.showHistoryScreen());
                this.dom.goToVendedorBonoButton.addEventListener('click', () => this.showScreen('vendedorBonoScreen'));
                document.getElementById('goToBankButton').addEventListener('click', () => this.promptForDate('banco'));
                this.dom.goToExpenseButton.addEventListener('click', () => this.showExpenseScreen());
                this.dom.goToBalanceButton.addEventListener('click', () => this.showBalanceScreen());
                this.dom.goToRecycleBinButton.addEventListener('click', () => this.showRecycleBinScreen());
                this.dom.logoutButton.addEventListener('click', () => this.logout());
                this.dom.dataForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleAddOrUpdateRecord(); });
                this.dom.saveAndFinishButton.addEventListener('click', () => this.handleSaveAndFinish());
                this.dom.goBackToFormButton.addEventListener('click', () => this.dom.confirmAllModal.classList.add('hidden'));
                document.getElementById('cancelDeleteButton').addEventListener('click', () => this.dom.deleteConfirmModal.classList.add('hidden'));
                document.getElementById('confirmDeleteButton').addEventListener('click', () => this.handleConfirmDelete());
                this.dom.downloadBalancePdfButton.addEventListener('click', () => this.downloadBalancePDF());
                this.dom.downloadBalanceSummaryPdfButton.addEventListener('click', () => this.downloadBalanceSummaryPDF()); // NUEVO
                this.dom.bankForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleBankFormSubmit(); });
                this.dom.expenseForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleExpenseFormSubmit(); });
                this.dom.vendedorBonoForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleVendedorBonoSubmit(); });
                this.dom.confirmDateButton.addEventListener('click', () => this.handleDateConfirm());
                this.dom.cancelDateButton.addEventListener('click', () => this.dom.dateConfirmModal.classList.add('hidden'));
                this.dom.confirmAllButton.addEventListener('click', () => this.handleConfirmAll());
                this.dom.clearAllButton.addEventListener('click', () => this.handleClearAll());
                this.dom.goBackToInitialScreenButton.addEventListener('click', () => this.showScreen('initialScreen'));
                this.dom.bankAmountInput.addEventListener('input', (e) => this.formatCurrencyInput(e));
                this.dom.expenseAmountInput.addEventListener('input', (e) => this.formatCurrencyInput(e));
                this.dom.reportType.addEventListener('change', () => this.updateReportInput());
                this.dom.runReportButton.addEventListener('click', () => this.handleReportQuery());
                this.dom.downloadVendedorReportPdfButton.addEventListener('click', () => this.downloadVendedorReportPDF());
                this.dom.downloadAllLoadsPdfButton.addEventListener('click', () => this.downloadAllLoadsPDF());
                // NUEVOS EVENTOS PARA GANADORES
                this.dom.goToWinnerButton.addEventListener('click', () => this.showWinnerScreen());
                this.dom.winnerForm.addEventListener('submit', (e) => { e.preventDefault(); this.handleFindWinner(); });
            },

            // --- AUTENTICACIÓN Y NAVEGÁCIÓn ---
            async handleLogin() {
                const email = this.dom.emailInput.value;
                const password = this.dom.passwordInput.value;
                this.showLoading(true);
                try {
                    await signInWithEmailAndPassword(this.state.auth, email, password);
                } catch (error) {
                    this.showLoading(false);
                    console.error("Error de inicio de sesión:", error.code);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        this.showToast('Correo o contraseña incorrectos.', 'error');
                    } else {
                        this.showToast('Error al intentar ingresar.', 'error');
                    }
                }
            },

            login(user) {
                this.state.currentUser = user;
                const adminEmails = ['adanrdmato@gmail.com', 'jose@example.com']; 
                this.state.isAdmin = adminEmails.includes(user.email);

                if (user.email === 'daianavirginiafroy@gmail.com') {
                    this.dom.welcomeMessage.textContent = 'Bienvenido Javier';
                } else {
                    const displayName = user.email.split('@')[0];
                    this.dom.welcomeMessage.textContent = `Bienvenido ${displayName}`;
                }

                this.showScreen('initialScreen');
            },

            async logout() {
                try {
                    await signOut(this.state.auth);
                    this.showToast('Sesión cerrada.');
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    this.showToast('Error al cerrar sesión.', 'error');
                }
            },
            
            logoutCleanup() {
                this.state.currentUser = null;
                this.state.isAdmin = false;
                
                if (this.state.unsubscribeHistory) this.state.unsubscribeHistory();
                if (this.state.unsubscribeBank) this.state.unsubscribeBank();
                if (this.state.unsubscribeExpenses) this.state.unsubscribeExpenses();
                if (this.state.unsubscribeVendedorBonos) this.state.unsubscribeVendedorBonos();
                if (this.state.unsubscribeDeleted) this.state.unsubscribeDeleted();
                if (this.state.unsubscribeWinners) this.state.unsubscribeWinners(); // NUEVO

                this.state.allSessions = [];
                this.state.bankDeposits = [];
                this.state.expenses = [];
                this.state.vendedorBonos = [];
                this.state.deletedItems = [];
                this.state.winnersData = []; // NUEVO

                this.showScreen('loginScreen');
            },

            showScreen(screenId) {
                this.dom.screens.forEach(s => {
                    s.classList.remove('active-screen');
                    s.style.display = 'none';
                });
                const screenToShow = document.getElementById(screenId);
                screenToShow.classList.add('active-screen');
                screenToShow.style.display = screenId === 'loginScreen' ? 'flex' : 'block';

                if (screenId === 'initialScreen') {
                    this.updateUIForUser();
                }
                if (screenId === 'vendedorBonoScreen') {
                    this.state.showAllVendedorBonos = false; // Reset pagination
                    this.resetVendedorBonoForm();
                    this.renderVendedorBonoHistory();
                    this.updateReportInput();
                }
                 if(screenId === 'recycleBinScreen'){
                      this.renderRecycleBin();
                 }
            },

            updateUIForUser() {
                const isAdmin = this.state.isAdmin;
                this.dom.goToBalanceButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToExpenseButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToBankButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.adminDashboard.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToVendedorBonoButton.style.display = 'block';
                this.dom.goToRecycleBinButton.style.display = isAdmin ? 'block' : 'none';
                this.dom.goToWinnerButton.style.display = isAdmin ? 'block' : 'none'; // NUEVO

                if (isAdmin) {
                    this.updateDashboard();
                }
            },

            togglePasswordVisibility() {
                const input = this.dom.passwordInput;
                if (input.type === 'password') {
                    input.type = 'text';
                    this.dom.eyeIcon.classList.add('hidden');
                    this.dom.eyeOffIcon.classList.remove('hidden');
                } else {
                    input.type = 'password';
                    this.dom.eyeIcon.classList.remove('hidden');
                    this.dom.eyeOffIcon.classList.add('hidden');
                }
            },

            // --- FLUJO DE ENTRADA DE NUEVOS DATOS ---

            startNewSession(date) {
                this.state.currentSessionRecords = [];
                this.state.recordToEditIndex = null;
                this.state.liveSummaryPage = 1;
                this.dom.dataForm.reset();
                document.getElementById('fecha').value = date;
                this.renderLiveSummary();
                this.setFormMode('add');
                this.showScreen('formScreen');
            },

            setFormMode(mode) {
                if (mode === 'add') {
                    this.dom.formTitle.textContent = 'Cargar Datos del Bono';
                    this.dom.formActions.innerHTML = `
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 rounded-lg">Cargar Otro</button>
                        <button type="button" onclick="App.clearForm()" class="w-full px-4 py-3 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Borrar Campos</button>
                    `;
                } else if (mode === 'edit') {
                    this.dom.formTitle.textContent = 'Modificando Registro';
                    this.dom.formActions.innerHTML = `
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Guardar Cambios</button>
                        <button type="button" onclick="App.cancelEdit()" class="w-full px-4 py-3 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                    `;
                }
            },
            
            handleAddOrUpdateRecord() {
                const formData = new FormData(this.dom.dataForm);
                const record = Object.fromEntries(formData.entries());

                if (!record.bonoNro1 || !record.bonoNro2 || !record.nombre || !record.telefono) {
                    this.showToast('Por favor, complete todos los campos requeridos.', 'error');
                    return;
                }
                const phoneRegex = /^\d{6,12}$/;
                if (!phoneRegex.test(record.telefono)) {
                    this.showToast('Teléfono inválido (6-12 dígitos).', 'error');
                    return;
                }
                
                if (this.state.recordToEditIndex !== null) {
                    this.state.currentSessionRecords[this.state.recordToEditIndex] = record;
                    this.showToast('Registro modificado con éxito.');
                    
                    const origin = this.state.editOrigin;
                    this.state.recordToEditIndex = null;
                    this.state.editOrigin = null;
                    this.dom.dataForm.reset();
                    this.setFormMode('add');

                    if (origin === 'detailsScreen') {
                        this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                    } else {
                        this.renderLiveSummary();
                        this.clearForm(false);
                    }
                } else {
                    this.state.currentSessionRecords.push(record);
                    this.state.liveSummaryPage = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                    this.showToast('Bono añadido al resumen.');
                    this.renderLiveSummary();
                    this.clearForm(false);
                }
            },

            clearForm(clearAll = true) {
                const currentDate = document.getElementById('fecha').value;
                const currentVendedor = document.getElementById('vendedor').value;
                this.dom.dataForm.reset();
                document.getElementById('fecha').value = currentDate;
                if (!clearAll) {
                    document.getElementById('vendedor').value = currentVendedor;
                }
                document.getElementById('bonoNro1').focus();
            },

            renderLiveSummary() {
                this.dom.liveSummaryContainer.innerHTML = '';
                this.dom.liveSummaryPagination.innerHTML = '';
                let subtotal = 0;
                let totalEfectivo = 0;

                if (this.state.currentSessionRecords.length === 0) {
                    this.dom.liveSummaryContainer.innerHTML = '<p class="text-center text-gray-500">Aún no hay bonos en esta carga.</p>';
                    this.dom.liveSummaryTotals.innerHTML = '';
                    return;
                }

                const page = this.state.liveSummaryPage;
                const recordsPerPage = this.state.recordsPerPage;
                const startIndex = (page - 1) * recordsPerPage;
                const endIndex = startIndex + recordsPerPage;
                const paginatedRecords = this.state.currentSessionRecords.slice(startIndex, endIndex);

                paginatedRecords.forEach((record, index) => {
                    const originalIndex = startIndex + index;
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'p-3 border rounded-md bg-white grid grid-cols-[1fr_auto] gap-2 items-center';
                    recordDiv.innerHTML = `
                        <div>
                            <p class="font-bold text-indigo-700">${record.nombre}</p>
                            <p class="text-sm text-gray-600">Bonos: ${record.bonoNro1}-${record.bonoNro2} | ${this.formatCurrency(monto)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.editRecordFromSummary(${originalIndex})" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button>
                            <button onclick="App.promptDeleteItem(null, 'summaryRecord', ${originalIndex})" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Eliminar</button>
                        </div>
                    `;
                    this.dom.liveSummaryContainer.appendChild(recordDiv);
                });

                this.state.currentSessionRecords.forEach(record => {
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    subtotal += monto;
                    if (record.tipoPago === 'Efectivo') totalEfectivo += monto;
                });

                this.dom.liveSummaryTotals.innerHTML = `
                    <p>Subtotal: <span class="font-bold">${this.formatCurrency(subtotal)}</span></p>
                    <p class="text-green-700">Total Efectivo: <span class="font-bold">${this.formatCurrency(totalEfectivo)}</span></p>
                `;

                const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                if (totalPages > 1) {
                    this.dom.liveSummaryPagination.innerHTML = `
                        <button onclick="App.prevPage()" class="px-3 py-1 rounded-md bg-gray-200" ${page === 1 ? 'disabled' : ''}>&lt;</button>
                        <span class="font-semibold text-gray-700">Página ${page} de ${totalPages}</span>
                        <button onclick="App.nextPage()" class="px-3 py-1 rounded-md bg-gray-200" ${page === totalPages ? 'disabled' : ''}>&gt;</button>
                    `;
                }
            },
            
            nextPage() {
                const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                if (this.state.liveSummaryPage < totalPages) {
                    this.state.liveSummaryPage++;
                    this.renderLiveSummary();
                }
            },

            prevPage() {
                if (this.state.liveSummaryPage > 1) {
                    this.state.liveSummaryPage--;
                    this.renderLiveSummary();
                }
            },

            editRecordFromSummary(index) {
                this.state.editOrigin = 'formScreen';
                const record = this.state.currentSessionRecords[index];
                if (!record) return;

                this.state.recordToEditIndex = index;
                
                document.getElementById('vendedor').value = record.vendedor;
                document.getElementById('bonoNro1').value = record.bonoNro1;
                document.getElementById('bonoNro2').value = record.bonoNro2;
                document.getElementById('nombre').value = record.nombre;
                document.getElementById('telefono').value = record.telefono;
                document.getElementById('tipoPago').value = record.tipoPago;
                document.getElementById('cuotas').value = record.cuotas;

                this.setFormMode('edit');
                window.scrollTo(0, 0);
            },

            editRecordFromSession(index) {
                const record = this.state.currentSessionRecords[index];
                if (!record) return;

                this.state.recordToEditIndex = index;
                this.state.editOrigin = 'detailsScreen';

                document.getElementById('fecha').value = record.fecha;
                document.getElementById('vendedor').value = record.vendedor;
                document.getElementById('bonoNro1').value = record.bonoNro1;
                document.getElementById('bonoNro2').value = record.bonoNro2;
                document.getElementById('nombre').value = record.nombre;
                document.getElementById('telefono').value = record.telefono;
                document.getElementById('tipoPago').value = record.tipoPago;
                document.getElementById('cuotas').value = record.cuotas;

                this.setFormMode('edit');
                this.showScreen('formScreen');
            },

            cancelEdit() {
                const origin = this.state.editOrigin;
                this.state.recordToEditIndex = null;
                this.state.editOrigin = null;
                this.clearForm();
                this.setFormMode('add');

                if (origin === 'detailsScreen') {
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                }
            },

            handleConfirmAll() {
                if (this.state.currentSessionRecords.length === 0) {
                    this.showToast('No hay bonos en el resumen para guardar.', 'error');
                    return;
                }
                
                let subtotal = 0;
                this.state.currentSessionRecords.forEach(r => subtotal += (r.cuotas == 1 ? 15000 : 30000));

                this.dom.finalConfirmationData.innerHTML = `
                    <p>Vas a guardar una sesión con <strong>${this.state.currentSessionRecords.length} registros</strong>.</p>
                    <p>El monto total es de <strong>${this.formatCurrency(subtotal)}</strong>.</p>
                    <p class="mt-4">¿Estás seguro de que quieres continuar?</p>
                `;
                this.dom.confirmAllModal.classList.remove('hidden');
            },

            handleClearAll() {
                if (this.state.currentSessionRecords.length > 0) {
                    this.promptDeleteItem(null, 'clearAllSummary');
                } else {
                    this.showToast('El resumen ya está vacío.', 'error');
                }
            },

            handleSaveAndFinish() {
                this.dom.confirmAllModal.classList.add('hidden');
                this.saveSessionToFirestore();
            },

            // --- GESTIÓN DE DATOS EN FIRESTORE ---
             loadAllDataFromFirestore() {
                  this.loadHistoryFromFirestore();
                  this.loadBankDepositsFromFirestore();
                  this.loadExpensesFromFirestore();
                  this.loadVendedorBonosFromFirestore();
                  this.loadDeletedItemsFromFirestore();
                  this.loadWinnersFromFirestore();
             },

            loadHistoryFromFirestore() {
                if (this.state.unsubscribeHistory) this.state.unsubscribeHistory();
                const sessionsColRef = collection(this.state.db, "sessions");
                this.showLoading(true);
                this.state.unsubscribeHistory = onSnapshot(query(sessionsColRef), async (snapshot) => {
                    const activeDocs = snapshot.docs.filter(doc => doc.data().deleted !== true);
                    const sessionsPromises = activeDocs.map(async (docSnap) => {
                        const sessionDocData = docSnap.data();
                        const sessionData = { 
                            id: docSnap.id, 
                            records: [], 
                            rawDate: sessionDocData.rawDate 
                        };
                        const recordsColRef = collection(docSnap.ref, 'records');
                        const recordsSnapshot = await getDocs(query(recordsColRef)); // Query all
                        const activeRecords = recordsSnapshot.docs.filter(doc => doc.data().deleted !== true); // Filter in JS
                        sessionData.records = activeRecords.map(d => Object.assign({recordId: d.id}, d.data()));
                        return sessionData;
                    });
                    this.state.allSessions = await Promise.all(sessionsPromises);
                    this.updateVendedoresList();
                    this.showLoading(false);
                    if (document.getElementById('historyScreen').classList.contains('active-screen')) {
                        this.showHistoryScreen();
                    }
                    this.updateDashboard();
                }, (error) => {
                    console.error("Error al escuchar los cambios del historial:", error);
                    this.showLoading(false);
                });
            },

            async saveSessionToFirestore() {
                if (this.state.currentSessionRecords.length === 0) return;
                this.showLoading(true);
                const rawDate = this.state.currentSessionRecords[0].fecha;
                const sessionId = this.formatDateForId(rawDate, true);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                const recordsColRef = collection(sessionDocRef, 'records');
                try {
                    const batch = writeBatch(this.state.db);
                    batch.set(sessionDocRef, { id: this.formatDateForId(rawDate), rawDate: rawDate, lastUpdated: serverTimestamp(), deleted: false }, { merge: true });
                    this.state.currentSessionRecords.forEach(record => {
                        const newRecordRef = doc(recordsColRef);
                         batch.set(newRecordRef, { ...record, deleted: false });
                    });
                    await batch.commit();
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'new');
                    this.showToast('Carga finalizada y guardada con éxito.');
                } catch (error) {
                    console.error("Error al guardar la sesión en Firestore: ", error);
                    this.showToast('Error al guardar la carga.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            showLoading(isLoading) {
                this.dom.loadingIndicator.classList.toggle('hidden', !isLoading);
            },
            
            showHistoryScreen() {
                this.dom.historyListContainer.innerHTML = '';
                if (this.state.allSessions.length === 0) {
                    this.dom.historyListContainer.innerHTML = '<p class="text-center text-gray-500">No hay cargas guardadas.</p>';
                } else {
                    const sortedSessions = [...this.state.allSessions].sort((a, b) => (a.rawDate || this.parseIdToDate(a.id)).localeCompare(b.rawDate || this.parseIdToDate(b.id))).reverse();
                    sortedSessions.forEach(session => {
                        const displayId = session.id.replace(/-/g, '/');
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg border';
                        sessionDiv.innerHTML = `<span class="font-semibold text-gray-800">Carga del ${displayId}</span><div class="flex gap-2"><button onclick="App.editSession('${session.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${session.id}', 'session')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button><button onclick="App.downloadSessionPDF('${session.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">PDF</button></div>`;
                        this.dom.historyListContainer.appendChild(sessionDiv);
                    });
                }
                this.showScreen('historyScreen');
            },

            displayDetailsScreen(records, mode = 'new') {
                this.dom.detailsListContainer.innerHTML = '';
                this.dom.summaryContainer.innerHTML = '';
                if (!records || records.length === 0) {
                    this.dom.detailsListContainer.innerHTML = '<p class="text-center text-gray-500">No hay registros.</p>';
                    return;
                }
                let subtotal = 0, totalEfectivo = 0;
                records.forEach((data, index) => {
                    const monto = data.cuotas == 1 ? 15000 : 30000;
                    subtotal += monto;
                    if (data.tipoPago === 'Efectivo') totalEfectivo += monto;
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'p-3 mb-2 border rounded-md bg-white grid grid-cols-1 gap-2 items-center';
                    detailDiv.innerHTML = `<div><p class="font-bold text-indigo-700">${data.nombre}</p><p class="text-sm text-gray-600">Bonos: ${data.bonoNro1}-${data.bonoNro2} | ${data.tipoPago}</p></div><p class="text-right font-semibold text-gray-800">${this.formatCurrency(monto)}</p>${mode === 'edit' ? `<div class="text-right flex gap-2 justify-end"><button onclick="App.editRecordFromSession(${index})" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.deleteRecordFromSession(${index})" class="text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Eliminar</button></div>` : ''}`;
                    this.dom.detailsListContainer.appendChild(detailDiv);
                });
                this.dom.summaryContainer.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium text-gray-600">Subtotal:</span><span class="font-bold text-gray-900">${this.formatCurrency(subtotal)}</span></div><div class="flex justify-between items-center text-green-700"><span class="font-medium">Total (Efectivo):</span><span class="font-bold">${this.formatCurrency(totalEfectivo)}</span></div>`;
                if (mode === 'new') {
                    const rawDate = this.state.currentSessionRecords[0].fecha;
                    this.dom.detailsTitle.textContent = `Detalle de Carga - ${this.formatDateForId(rawDate)}`;
                    this.dom.detailsActions.innerHTML = `<button onclick="App.downloadSessionPDF(null)" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-red-500 to-red-700 hover:from-red-600 hover:to-red-800 rounded-lg">Descargar PDF</button><button onclick="App.promptForDate('bono')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 rounded-lg">Nueva Carga</button><button onclick="App.showScreen('initialScreen')" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Volver al Inicio</button>`;
                } else if (mode === 'edit') {
                    this.dom.detailsTitle.textContent = `Modificando Carga del ${this.state.sessionToEditId.replace(/-/g, '/')}`;
                    this.dom.detailsActions.innerHTML = `<button onclick="App.saveModifiedSession()" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Guardar Cambios</button><button onclick="App.showHistoryScreen()" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 rounded-lg">Cancelar</button>`;
                }
                this.showScreen('detailsScreen');
            },
            
            editSession(sessionId) {
                this.state.sessionToEditId = sessionId;
                const session = this.state.allSessions.find(s => s.id === sessionId);
                if (session) {
                    this.state.sessionToEditRawDate = session.rawDate; 
                    this.state.currentSessionRecords = JSON.parse(JSON.stringify(session.records)); 
                    this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
                }
            },

            deleteRecordFromSession(index) {
                this.state.currentSessionRecords.splice(index, 1);
                this.displayDetailsScreen(this.state.currentSessionRecords, 'edit');
            },

            async saveModifiedSession() {
                this.showLoading(true);
                const sessionId = this.state.sessionToEditId;
                const rawDate = this.state.sessionToEditRawDate || this.parseIdToDate(sessionId);
                const sessionDocRef = doc(this.state.db, "sessions", sessionId);
                try {
                    const recordsColRef = collection(sessionDocRef, 'records');
                    const recordsSnapshot = await getDocs(recordsColRef);
                    const deleteBatch = writeBatch(this.state.db);
                    recordsSnapshot.forEach(doc => deleteBatch.delete(doc.ref));
                    await deleteBatch.commit();
                    if (this.state.currentSessionRecords.length > 0) {
                        const addBatch = writeBatch(this.state.db);
                        addBatch.set(sessionDocRef, { id: this.formatDateForId(rawDate), rawDate: rawDate, lastUpdated: serverTimestamp(), deleted: false }, { merge: true });
                        this.state.currentSessionRecords.forEach(record => {
                            const newRecordRef = doc(recordsColRef);
                            const recordData = Object.assign({}, record);
                            delete recordData.recordId;
                             addBatch.set(newRecordRef, { ...recordData, deleted: false });
                        });
                        await addBatch.commit();
                    } else {
                        await updateDoc(sessionDocRef, { deleted: true, deletedAt: serverTimestamp() });
                    }
                    this.showToast('Cambios guardados con éxito.');
                } catch (error) {
                    console.error("Error al modificar la sesión: ", error);
                    this.showToast('Error al guardar los cambios.', 'error');
                } finally {
                    this.showLoading(false);
                    this.showHistoryScreen();
                }
            },

            promptDeleteItem(id, type, index = null, permanent = false) {
                this.state.itemToDelete = { id, type, index, permanent };
                let message, title;

                if (permanent) {
                    title = 'Eliminar Permanentemente';
                    message = '¿Estás seguro? Esta acción no se puede deshacer.';
                } else {
                    title = 'Confirmar Eliminación';
                    message = `¿Seguro que quieres mover este elemento a la papelera?`;
                     if (type === 'summaryRecord') {
                        message = '¿Seguro que quieres eliminar este registro del resumen?';
                    } else if (type === 'clearAllSummary') {
                        message = '¿Seguro que quieres borrar todos los registros del resumen actual? Esta acción no se puede deshacer.';
                    }
                }
                
                this.dom.deleteConfirmTitle.textContent = title;
                this.dom.deleteConfirmMessage.textContent = message;
                this.dom.deleteConfirmModal.classList.remove('hidden');
            },
            
            async handleConfirmDelete() {
                const { id, type, index, permanent } = this.state.itemToDelete;
                this.dom.deleteConfirmModal.classList.add('hidden');

                if (type === 'summaryRecord' && index !== null) {
                    this.state.currentSessionRecords.splice(index, 1);
                    const totalPages = Math.ceil(this.state.currentSessionRecords.length / this.state.recordsPerPage);
                    if (this.state.liveSummaryPage > totalPages) {
                        this.state.liveSummaryPage = totalPages > 0 ? totalPages : 1;
                    }
                    this.renderLiveSummary();
                    this.showToast('Registro eliminado del resumen.');
                } else if (type === 'clearAllSummary') {
                    this.state.currentSessionRecords = [];
                    this.state.liveSummaryPage = 1;
                    this.renderLiveSummary();
                    this.showToast('Resumen de carga borrado.');
                } else if (id && type) {
                    await this.moveItemToRecycleBin(id, type, permanent);
                }
                
                this.state.itemToDelete = { id: null, type: null, index: null, permanent: false };
            },

            async moveItemToRecycleBin(id, type, permanent) {
                this.showLoading(true);
                let docRef;
                const collectionName = {
                    'session': 'sessions',
                    'deposit': 'bank_deposits',
                    'expense': 'expenses',
                    'vendedorBono': 'vendedor_bonos'
                }[type];

                if (!collectionName) {
                    this.showLoading(false);
                    return;
                }

                docRef = doc(this.state.db, collectionName, id);

                try {
                    if (permanent) {
                        await deleteDoc(docRef);
                         if (type === 'session') {
                             const recordsSnapshot = await getDocs(collection(docRef, 'records'));
                             const batch = writeBatch(this.state.db);
                             recordsSnapshot.forEach(doc => batch.delete(doc.ref));
                             await batch.commit();
                         }
                        this.showToast('Elemento eliminado permanentemente.');
                    } else {
                        await updateDoc(docRef, {
                            deleted: true,
                            deletedAt: serverTimestamp()
                        });
                        this.showToast('Elemento movido a la papelera.');
                    }
                } catch (error) {
                    console.error(`Error al procesar el elemento:`, error);
                    this.showToast('Error al procesar el elemento.', 'error');
                } finally {
                    this.showLoading(false);
                    if(this.dom.recycleBinScreen.classList.contains('active-screen')){
                          this.renderRecycleBin(); // Refresh recycle bin view
                    }
                }
            },
            
            // --- CÓDIGO ACTUALIZADO PARA BALANCE ---
            showBalanceScreen() {
                this.dom.balanceListContainer.innerHTML = '';
                this.dom.balanceSummaryContainer.innerHTML = '';
                
                let totalBonosEfectivo = 0, totalBonosTransferencia = 0;
                const salesByVendedor = {};

                const allRecords = []; // Para la lista detallada
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        allRecords.push(Object.assign({ sessionDate: session.id.replace(/-/g, '/') }, record));
                        const monto = record.cuotas == 1 ? 15000 : 30000;
                        if (record.tipoPago === 'Efectivo') {
                            totalBonosEfectivo += monto;
                        } else {
                            totalBonosTransferencia += monto;
                        }

                        if (record.vendedor && record.vendedor.trim() !== '') {
                            const normalizedVendedor = record.vendedor.trim().toLowerCase();
                            if (!salesByVendedor[normalizedVendedor]) {
                                salesByVendedor[normalizedVendedor] = {
                                    originalName: record.vendedor.trim(),
                                    total: 0
                                };
                            }
                            salesByVendedor[normalizedVendedor].total += monto;
                        }
                    });
                });

                let totalExpensesEfectivo = 0, totalExpensesTransferencia = 0;
                this.state.expenses.forEach(expense => {
                    const monto = parseFloat(expense.amount);
                    if (expense.type === 'Efectivo') {
                        totalExpensesEfectivo += monto;
                    } else {
                        totalExpensesTransferencia += monto;
                    }
                });

                const totalBonos = totalBonosEfectivo + totalBonosTransferencia;
                const totalExpenses = totalExpensesEfectivo + totalExpensesTransferencia;
                const calculoA = totalBonosEfectivo - totalBonosTransferencia - totalExpenses;
                const balanceGeneral = totalBonos - totalExpenses;

                // <-- OPTIMIZATION: Store calculated data for reuse in PDFs
                this.state.balanceData = {
                    totalBonosEfectivo, totalBonosTransferencia, totalBonos,
                    salesByVendedor,
                    totalExpensesEfectivo, totalExpensesTransferencia, totalExpenses,
                    calculoA, balanceGeneral,
                    allRecords,
                    expenses: this.state.expenses
                };

                // Renderizar la lista detallada de ingresos y egresos
                let balanceHTML = '<div><h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-2">Ingresos por Bonos</h3>';
                if (allRecords.length === 0) {
                    balanceHTML += '<p class="text-center text-gray-500">No hay registros de bonos.</p>';
                } else {
                    allRecords.sort((a, b) => (this.parseIdToDate(a.sessionDate)).localeCompare(this.parseIdToDate(b.sessionDate))).reverse();
                    allRecords.forEach(record => {
                        const monto = record.cuotas == 1 ? 15000 : 30000;
                        balanceHTML += `<div class="p-3 mb-2 border rounded-md bg-white grid grid-cols-3 gap-2 items-center text-sm"><div><p class="font-semibold">${record.nombre}</p><p class="text-xs text-gray-500">${record.sessionDate}</p></div><p class="text-center">${record.tipoPago}</p><p class="text-right font-semibold">${this.formatCurrency(monto)}</p></div>`;
                    });
                }
                balanceHTML += '</div>';

                balanceHTML += '<div class="mt-6"><h3 class="text-lg font-semibold text-red-700 mb-2 border-b border-red-200 pb-2">Egresos</h3>';
                if (this.state.expenses.length === 0) {
                    balanceHTML += '<p class="text-center text-gray-500">No hay egresos registrados.</p>';
                } else {
                    this.state.expenses.forEach(expense => {
                        const monto = parseFloat(expense.amount);
                        balanceHTML += `<div class="p-3 mb-2 border rounded-md bg-white grid grid-cols-3 gap-2 items-center text-sm"><div><p class="font-semibold">${expense.description}</p><p class="text-xs text-gray-500">${this.formatDateForId(expense.date)}</p></div><p class="text-center">${expense.type}</p><p class="text-right font-semibold text-red-600">-${this.formatCurrency(monto)}</p></div>`;
                    });
                }
                balanceHTML += '</div>';
                this.dom.balanceListContainer.innerHTML = balanceHTML;


                let salesSummaryHTML = '';
                if (Object.keys(salesByVendedor).length > 0) {
                     salesSummaryHTML += '<div class="p-4 border rounded-lg bg-white mb-4"><h4 class="font-bold text-lg mb-2 text-gray-800">Resumen de Ventas por Vendedor</h4>';
                     const sortedVendedores = Object.keys(salesByVendedor).sort();
                     for (const normalizedVendedor of sortedVendedores) {
                         const data = salesByVendedor[normalizedVendedor];
                         salesSummaryHTML += `<div class="flex justify-between items-center"><span class="font-medium text-gray-600">${data.originalName}:</span><span class="font-bold text-gray-800">${this.formatCurrency(data.total)}</span></div>`;
                     }
                     salesSummaryHTML += '</div>';
                }

                this.dom.balanceSummaryContainer.innerHTML = `
                    <div class="p-4 border rounded-lg bg-white mb-4">
                        <h4 class="font-bold text-lg mb-2 text-gray-800">Resumen de Ingresos (Bonos)</h4>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">Total Efectivo:</span><span class="font-bold text-green-700">${this.formatCurrency(totalBonosEfectivo)}</span></div>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">Total Transferencia:</span><span class="font-bold text-blue-700">${this.formatCurrency(totalBonosTransferencia)}</span></div>
                        <hr class="my-2 border-gray-200">
                        <div class="flex justify-between items-center text-lg"><span class="font-bold text-gray-800">Total Ingresos Bonos:</span><span class="font-extrabold text-gray-900">${this.formatCurrency(totalBonos)}</span></div>
                    </div>
                    ${salesSummaryHTML}
                    <div class="p-4 border rounded-lg bg-white mb-4">
                        <h4 class="font-bold text-lg mb-2 text-gray-800">Resumen de Egresos</h4>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">Total Egresos Efectivo:</span><span class="font-bold text-red-600">-${this.formatCurrency(totalExpensesEfectivo)}</span></div>
                        <div class="flex justify-between items-center"><span class="font-medium text-gray-600">Total Egresos Transferencia:</span><span class="font-bold text-red-600">-${this.formatCurrency(totalExpensesTransferencia)}</span></div>
                        <hr class="my-2 border-gray-200">
                        <div class="flex justify-between items-center text-lg"><span class="font-bold text-gray-800">Total Egresos:</span><span class="font-extrabold text-red-700">-${this.formatCurrency(totalExpenses)}</span></div>
                    </div>
                    <div class="p-4 border rounded-lg bg-gray-800 text-white space-y-3">
                        <h4 class="font-bold text-xl mb-2">Balances Finales</h4>
                        <div class="flex justify-between items-center text-base border-b border-gray-600 pb-2">
                            <span class="font-semibold">Total Ventas de Bonos:</span>
                            <span class="font-extrabold">${this.formatCurrency(totalBonos)}</span>
                        </div>
                        <div class="flex justify-between items-center text-base border-b border-gray-600 pb-2">
                            <span class="font-semibold">Cálculo (Efectivo - Transf. - Egresos):</span>
                            <span class="font-extrabold">${this.formatCurrency(calculoA)}</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl pt-2">
                            <span class="font-bold">BALANCE GENERAL:</span>
                            <span class="font-extrabold">${this.formatCurrency(balanceGeneral)}</span>
                        </div>
                    </div>
                `;

                this.showScreen('balanceScreen');
            },
            
            downloadBalanceSummaryPDF() {
                // <-- OPTIMIZATION: Use pre-calculated data from state
                if (!this.state.balanceData) {
                    this.showToast('Por favor, genere el balance en pantalla primero.', 'error');
                    return;
                }
                const {
                    salesByVendedor,
                    expenses,
                    totalBonos,
                    calculoA,
                    balanceGeneral
                } = this.state.balanceData;

                const doc = new jsPDF();
                // Custom title for this specific PDF
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text("Parroquia San José", 105, 15, { align: 'center' });
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text("Balance de Ventas y Egresos de Bonos", 105, 25, { align: 'center' });

                doc.setFontSize(10);
                doc.text(this.getCurrentDateFormatted(), doc.internal.pageSize.getWidth() - 15, 20, { align: 'right' });

                doc.setDrawColor(180, 180, 180);
                doc.line(15, 32, doc.internal.pageSize.getWidth() - 15, 32);

                let startY = 40;
                
                // --- Section 1: Ventas por Vendedor ---
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Detalle de Ventas por Vendedor', 14, startY);
                startY += 7;
                const salesSummaryRows = Object.keys(salesByVendedor).sort().map(vendedor => [salesByVendedor[vendedor].originalName, this.formatCurrency(salesByVendedor[vendedor].total)]);
                doc.autoTable({
                    head: [["Vendedor", "Total Vendido"]],
                    body: salesSummaryRows,
                    startY: startY,
                    theme: 'grid',
                    headStyles: { fillColor: [22, 163, 74] } // Green
                });
                startY = doc.autoTable.previous.finalY + 15;

                // --- Section 2: Detalle de Egresos ---
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Detalle de Egresos', 14, startY);
                startY += 7;
                const expenseTableRows = expenses.map(expense => {
                    const monto = parseFloat(expense.amount);
                    return [this.formatDateForId(expense.date), expense.description, expense.type, `-${this.formatCurrency(monto)}`];
                });
                 doc.autoTable({
                    head: [["Fecha", "Descripción", "Tipo de Pago", "Monto"]],
                    body: expenseTableRows,
                    startY: startY,
                    theme: 'grid',
                    headStyles: { fillColor: [220, 38, 38] } // Red
                });
                startY = doc.autoTable.previous.finalY + 15;

                // --- Section 3: Balances Finales ---
                if (startY > 250) { 
                    doc.addPage();
                    startY = 20; 
                }

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Balances Finales', 14, startY);
                startY += 7;
                doc.autoTable({
                    startY: startY,
                    theme: 'plain',
                    body: [
                        ['Total Ventas de Bonos:', this.formatCurrency(totalBonos)],
                        ['Cálculo (Efectivo - Transf. - Egresos):', this.formatCurrency(calculoA)],
                        [{content: 'BALANCE GENERAL:', styles: {fontStyle: 'bold'}}, {content: this.formatCurrency(balanceGeneral), styles: {fontStyle: 'bold'}}],
                    ],
                    columnStyles: { 
                        0: { halign: 'right', fontStyle: 'bold' },
                        1: { halign: 'right' }
                    }
                });

                const currentDate = this.getCurrentDateFormatted();
                doc.save(`resumen_balance_bonos_${currentDate}.pdf`);
            },

            downloadBalancePDF() {
                // <-- OPTIMIZATION: Use pre-calculated data from state
                if (!this.state.balanceData) {
                    this.showToast('Por favor, genere el balance en pantalla primero.', 'error');
                    return;
                }

                const {
                    allRecords: bonoRecords,
                    expenses,
                    salesByVendedor,
                    totalBonosEfectivo,
                    totalBonosTransferencia,
                    totalBonos,
                    totalExpensesEfectivo,
                    totalExpensesTransferencia,
                    totalExpenses,
                    calculoA,
                    balanceGeneral
                } = this.state.balanceData;

                const doc = new jsPDF();
                let startY = this.addPdfHeader(doc, "Balance Detallado");
                
                // Tablas de detalle
                doc.setFontSize(14);
                doc.text('Ingresos por Bonos', 14, startY);
                const bonoTableRows = bonoRecords.sort((a,b) => (this.parseIdToDate(a.sessionDate)).localeCompare(this.parseIdToDate(b.sessionDate))).reverse().map(record => {
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    return [record.sessionDate, record.nombre, record.tipoPago, this.formatCurrency(monto)];
                });
                doc.autoTable({
                    head: [["Fecha", "Nombre", "Tipo de Pago", "Monto"]],
                    body: bonoTableRows,
                    startY: startY + 7, theme: 'grid', headStyles: { fillColor: [67, 56, 202] }
                });
                
                let finalY = doc.autoTable.previous.finalY + 15;
                doc.setFontSize(14);
                doc.text('Egresos', 14, finalY);
                const expenseTableRows = expenses.map(expense => {
                    const monto = parseFloat(expense.amount);
                    return [this.formatDateForId(expense.date), expense.description, expense.type, `-${this.formatCurrency(monto)}`];
                });
                 doc.autoTable({
                    head: [["Fecha", "Descripción", "Tipo de Pago", "Monto"]],
                    body: expenseTableRows,
                    startY: finalY + 7, theme: 'grid', headStyles: { fillColor: [220, 38, 38] }
                });


                const salesSummaryRows = Object.keys(salesByVendedor).sort().map(vendedor => [salesByVendedor[vendedor].originalName, this.formatCurrency(salesByVendedor[vendedor].total)]);
                
                let finalY_summary = doc.autoTable.previous.finalY + 10;
                if (finalY_summary > 220) {
                    doc.addPage();
                    finalY_summary = 20;
                }

                doc.autoTable({
                    startY: finalY_summary,
                    theme: 'plain',
                    body: [
                        [{content: 'Resumen de Ingresos (Bonos)', colSpan: 2, styles: {fontStyle: 'bold'}}],
                        ['Total Efectivo (Bonos):', this.formatCurrency(totalBonosEfectivo)],
                        ['Total Transferencia (Bonos):', this.formatCurrency(totalBonosTransferencia)],
                        [{content: 'Total Ingresos Bonos:', styles: {fontStyle: 'bold'}}, {content: this.formatCurrency(totalBonos), styles: {fontStyle: 'bold'}}],
                        ['', ''],
                        [{content: 'Resumen de Ventas por Vendedor', colSpan: 2, styles: {fontStyle: 'bold'}}],
                        ...salesSummaryRows,
                        ['', ''],
                        [{content: 'Resumen de Egresos', colSpan: 2, styles: {fontStyle: 'bold'}}],
                        ['Total Egresos Efectivo:', `-${this.formatCurrency(totalExpensesEfectivo)}`],
                        ['Total Egresos Transferencia:', `-${this.formatCurrency(totalExpensesTransferencia)}`],
                        [{content: 'Total Egresos:', styles: {fontStyle: 'bold'}}, {content: `-${this.formatCurrency(totalExpenses)}`, styles: {fontStyle: 'bold'}}],
                        ['', ''],
                        [{content: 'Balances Finales', colSpan: 2, styles: {fontStyle: 'bold', fontSize: 12}}],
                        ['Total Ventas de Bonos:', this.formatCurrency(totalBonos)],
                        ['Cálculo (Efectivo - Transf. - Egresos):', this.formatCurrency(calculoA)],
                        [{content: 'BALANCE GENERAL:', styles: {fontStyle: 'bold', fontSize: 12}}, {content: this.formatCurrency(balanceGeneral), styles: {fontStyle: 'bold', fontSize: 12}}],
                    ],
                    columnStyles: { 0: { halign: 'right' }, 1: { halign: 'right' } },
                    didParseCell: (data) => {
                        if (data.cell.raw.colSpan === 2) {
                            data.cell.styles.halign = 'left';
                        }
                    }
                });
                
                const currentDate = this.getCurrentDateFormatted();
                doc.save(`balance_detallado_${currentDate}.pdf`);
            },
            
            // --- LÓGICA DE BANCO Y EGRESOS ---
            showBankScreen(date = null) {
                this.state.showAllDeposits = false;
                this.dom.bankForm.reset();
                const dateInput = document.getElementById('bankDate');
                if (date) dateInput.value = date;
                else dateInput.valueAsDate = new Date();
                this.dom.bankFormTitle.textContent = 'Nuevo Depósito';
                this.dom.bankFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-cyan-600 rounded-lg hover:bg-cyan-700">Confirmar</button>`;
                this.state.depositToEditId = null;
                this.renderBankDeposits();
                this.showScreen('bankScreen');
            },

            loadBankDepositsFromFirestore() {
                if (this.state.unsubscribeBank) this.state.unsubscribeBank();
                const bankColRef = collection(this.state.db, "bank_deposits");
                this.state.unsubscribeBank = onSnapshot(query(bankColRef), (snapshot) => {
                    const allDeposits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.bankDeposits = allDeposits.filter(deposit => deposit.deleted !== true);
                    this.state.bankDeposits.sort((a, b) => b.date.localeCompare(a.date));
                    if (document.getElementById('bankScreen').classList.contains('active-screen')) {
                        this.renderBankDeposits();
                    }
                });
            },

            renderBankDeposits() {
                this.dom.bankDepositsListContainer.innerHTML = '';
                const deposits = this.state.bankDeposits;
                if (deposits.length === 0) {
                    this.dom.bankDepositsListContainer.innerHTML = '<p class="text-center text-gray-500">No hay depósitos registrados.</p>';
                    return;
                }
                const depositsToShow = this.state.showAllDeposits ? deposits : deposits.slice(0, 3);
                depositsToShow.forEach(deposit => {
                    const depositDiv = document.createElement('div');
                    depositDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    depositDiv.innerHTML = `<div><p class="font-semibold text-gray-800">${'Depósito'} - ${this.formatDateForId(deposit.date)}</p><p class="text-sm text-gray-600">${this.formatCurrency(parseFloat(deposit.amount))} (${deposit.type})</p></div><div class="flex gap-2"><button onclick="App.editBankDeposit('${deposit.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${deposit.id}', 'deposit')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button><button onclick="App.downloadDepositPDF('${deposit.id}')" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">PDF</button></div>`;
                    this.dom.bankDepositsListContainer.appendChild(depositDiv);
                });
                if (!this.state.showAllDeposits && deposits.length > 3) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                    seeMoreButton.textContent = 'Ver más';
                    seeMoreButton.onclick = () => { this.state.showAllDeposits = true; this.renderBankDeposits(); };
                    this.dom.bankDepositsListContainer.appendChild(seeMoreButton);
                }
            },

            async handleBankFormSubmit() {
                const formData = new FormData(this.dom.bankForm);
                const amountValue = formData.get('bankAmount');
                const depositData = { 
                    date: formData.get('bankDate'), 
                    amount: this.getNumericValue(amountValue), 
                    type: formData.get('bankType'),
                    deleted: false
                };
                this.showLoading(true);
                try {
                    if (this.state.depositToEditId) {
                        await updateDoc(doc(this.state.db, "bank_deposits", this.state.depositToEditId), depositData);
                        this.showToast('Depósito modificado.');
                    } else {
                        await addDoc(collection(this.state.db, "bank_deposits"), depositData);
                        this.showToast('Depósito guardado.');
                    }
                    this.showBankScreen();
                } catch (error) {
                    console.error("Error al guardar depósito:", error);
                    this.showToast('Error al guardar depósito.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            editBankDeposit(depositId) {
                const deposit = this.state.bankDeposits.find(d => d.id === depositId);
                if (!deposit) return;
                this.state.depositToEditId = depositId;
                document.getElementById('bankDate').value = deposit.date;
                document.getElementById('bankAmount').value = deposit.amount.toLocaleString('es-ES');
                document.getElementById('bankType').value = deposit.type;
                this.dom.bankFormTitle.textContent = 'Modificar Depósito';
                this.dom.bankFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button><button type="button" onclick="App.showBankScreen()" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>`;
                window.scrollTo(0, 0);
            },

            downloadDepositPDF(depositId) {
                const deposit = this.state.bankDeposits.find(d => d.id === depositId);
                if (!deposit) return;
                const doc = new jsPDF();
                const startY = this.addPdfHeader(doc, "Detalle de Depósito");
                doc.autoTable({
                    head: [["Campo", "Valor"]],
                    body: [["Fecha", this.formatDateForId(deposit.date)], ["Importe", this.formatCurrency(parseFloat(deposit.amount))], ["Tipo", deposit.type]],
                    startY: startY, theme: 'grid', headStyles: { fillColor: [8, 145, 178] }
                });
                doc.save(`deposito_${deposit.id}.pdf`);
            },

            promptForDate(type) {
                this.state.datePromptType = type;
                this.dom.modalDateInput.valueAsDate = new Date();
                if (type === 'bono') this.dom.dateConfirmTitle.textContent = 'Confirmar Fecha de Carga';
                else if (type === 'banco') this.dom.dateConfirmTitle.textContent = 'Confirmar Fecha de Depósito';
                this.dom.dateConfirmModal.classList.remove('hidden');
            },

            handleDateConfirm() {
                const selectedDate = this.dom.modalDateInput.value;
                if (!selectedDate) {
                    this.showToast('Por favor, seleccione una fecha.', 'error');
                    return;
                }
                if (this.state.datePromptType === 'bono') this.startNewSession(selectedDate);
                else if (this.state.datePromptType === 'banco') this.showBankScreen(selectedDate);
                this.dom.dateConfirmModal.classList.add('hidden');
                this.state.datePromptType = null;
            },

            showExpenseScreen() {
                this.state.showAllExpenses = false;
                this.dom.expenseForm.reset();
                document.getElementById('expenseDate').valueAsDate = new Date();
                this.dom.expenseFormTitle.textContent = 'Nuevo Egreso';
                this.dom.expenseFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Confirmar Egreso</button>`;
                this.state.expenseToEditId = null;
                this.renderExpenses();
                this.showScreen('expenseScreen');
            },

            loadExpensesFromFirestore() {
                if (this.state.unsubscribeExpenses) this.state.unsubscribeExpenses();
                const expensesColRef = collection(this.state.db, "expenses");
                this.state.unsubscribeExpenses = onSnapshot(query(expensesColRef), (snapshot) => {
                    const allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.expenses = allExpenses.filter(expense => expense.deleted !== true);
                    this.state.expenses.sort((a, b) => b.date.localeCompare(a.date));
                    if (document.getElementById('expenseScreen').classList.contains('active-screen')) {
                        this.renderExpenses();
                    }
                    this.updateDashboard();
                });
            },

            renderExpenses() {
                this.dom.expenseListContainer.innerHTML = '';
                const expenses = this.state.expenses;
                if (expenses.length === 0) {
                    this.dom.expenseListContainer.innerHTML = '<p class="text-center text-gray-500">No hay egresos registrados.</p>';
                    return;
                }
                const expensesToShow = this.state.showAllExpenses ? expenses : expenses.slice(0, 3);
                expensesToShow.forEach(expense => {
                    const expenseDiv = document.createElement('div');
                    expenseDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    expenseDiv.innerHTML = `<div><p class="font-semibold text-gray-800">${expense.description}</p><p class="text-sm text-gray-600">${this.formatDateForId(expense.date)} - ${this.formatCurrency(parseFloat(expense.amount))} (${expense.type})</p></div><div class="flex gap-2"><button onclick="App.editExpense('${expense.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button><button onclick="App.promptDeleteItem('${expense.id}', 'expense')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button></div>`;
                    this.dom.expenseListContainer.appendChild(expenseDiv);
                });
                if (!this.state.showAllExpenses && expenses.length > 3) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                    seeMoreButton.textContent = 'Ver más';
                    seeMoreButton.onclick = () => { this.state.showAllExpenses = true; this.renderExpenses(); };
                    this.dom.expenseListContainer.appendChild(seeMoreButton);
                }
            },
            
            async handleExpenseFormSubmit() {
                const formData = new FormData(this.dom.expenseForm);
                const amountValue = formData.get('expenseAmount');
                const expenseData = {
                    date: formData.get('expenseDate'),
                    description: formData.get('expenseDescription'),
                    amount: this.getNumericValue(amountValue),
                    type: formData.get('expenseType'),
                    deleted: false
                };
                this.showLoading(true);
                try {
                    if (this.state.expenseToEditId) {
                        await updateDoc(doc(this.state.db, "expenses", this.state.expenseToEditId), expenseData);
                        this.showToast('Egreso modificado.');
                    } else {
                        await addDoc(collection(this.state.db, "expenses"), expenseData);
                        this.showToast('Egreso guardado.');
                    }
                    this.showExpenseScreen();
                } catch (error) {
                    console.error("Error al guardar el egreso:", error);
                    this.showToast('Error al guardar el egreso.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            editExpense(expenseId) {
                const expense = this.state.expenses.find(e => e.id === expenseId);
                if (!expense) return;
                this.state.expenseToEditId = expenseId;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount.toLocaleString('es-ES');
                document.getElementById('expenseType').value = expense.type;
                this.dom.expenseFormTitle.textContent = 'Modificar Egreso';
                this.dom.expenseFormActions.innerHTML = `<button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button><button type="button" onclick="App.showExpenseScreen()" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>`;
                window.scrollTo(0, 0);
            },
            
            // --- BONOS POR VENDEDOR Y REPORTES ---
            loadVendedorBonosFromFirestore() {
                if (this.state.unsubscribeVendedorBonos) this.state.unsubscribeVendedorBonos();
                const vendedorBonosColRef = collection(this.state.db, "vendedor_bonos");
                this.state.unsubscribeVendedorBonos = onSnapshot(query(vendedorBonosColRef), (snapshot) => {
                    const allVendedorBonos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.vendedorBonos = allVendedorBonos.filter(bono => bono.deleted !== true);
                    this.state.vendedorBonos.sort((a, b) => {
                        const dateA = a.fechaAsignacion?.toDate() || 0;
                        const dateB = b.fechaAsignacion?.toDate() || 0;
                        return dateB - dateA;
                    });
                    if (document.getElementById('vendedorBonoScreen').classList.contains('active-screen')) {
                        this.renderVendedorBonoHistory();
                    }
                });
            },

            renderVendedorBonoHistory() {
                this.dom.vendedorBonoHistoryContainer.innerHTML = '';
                if (this.state.vendedorBonos.length === 0) {
                    this.dom.vendedorBonoHistoryContainer.innerHTML = '<p class="text-center text-gray-500">No hay bonos asignados a vendedores.</p>';
                    return;
                }

                const bonosByVendedor = this.state.vendedorBonos.reduce((acc, bono) => {
                    const vendedor = bono.vendedor;
                    if (!acc[vendedor]) {
                        acc[vendedor] = [];
                    }
                    acc[vendedor].push(bono);
                    return acc;
                }, {});
                
                const allVendors = Object.keys(bonosByVendedor).sort();
                const vendorsToShow = this.state.showAllVendedorBonos ? allVendors : allVendors.slice(0, 3);

                vendorsToShow.forEach(vendedor => {
                    const vendedorSection = document.createElement('div');
                    vendedorSection.className = 'p-4 border rounded-lg bg-white';
                    let recordsHTML = `<h4 class="text-lg font-bold text-gray-800 mb-2">${vendedor}</h4><div class="space-y-2">`;
                    
                    const vendorAssignments = bonosByVendedor[vendedor];

                    vendorAssignments.forEach(bono => {
                        const fecha = bono.fechaAsignacion ? this.formatTimestamp(bono.fechaAsignacion) : 'Sin fecha';
                        recordsHTML += `
                            <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md border">
                                <div>
                                    <p class="font-semibold text-gray-700">Rango: ${bono.bonoNro1} - ${bono.bonoNro2}</p>
                                    <p class="text-xs text-gray-500">Asignado: ${fecha}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="App.editVendedorBono('${bono.id}')" class="text-xs px-2 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">Modificar</button>
                                    <button onclick="App.promptDeleteItem('${bono.id}', 'vendedorBono')" class="text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Eliminar</button>
                                </div>
                            </div>
                        `;
                    });
                    recordsHTML += '</div>';
                    vendedorSection.innerHTML = recordsHTML;
                    this.dom.vendedorBonoHistoryContainer.appendChild(vendedorSection);
                });

                if (!this.state.showAllVendedorBonos && allVendors.length > 3) {
                    const seeMoreButton = document.createElement('button');
                    seeMoreButton.className = 'w-full mt-4 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                    seeMoreButton.textContent = 'Ver más';
                    seeMoreButton.onclick = () => { 
                        this.state.showAllVendedorBonos = true; 
                        this.renderVendedorBonoHistory(); 
                    };
                    this.dom.vendedorBonoHistoryContainer.appendChild(seeMoreButton);
                }
            },

            async handleVendedorBonoSubmit() {
                const formData = new FormData(this.dom.vendedorBonoForm);
                const bonoData = {
                    vendedor: formData.get('vendedorBonoNombre'),
                    bonoNro1: formData.get('vendedorBonoNro1'),
                    bonoNro2: formData.get('vendedorBonoNro2'),
                };

                if (!bonoData.vendedor || !bonoData.bonoNro1 || !bonoData.bonoNro2) {
                    this.showToast('Por favor, complete todos los campos.', 'error');
                    return;
                }
                
                this.showLoading(true);
                try {
                    if (this.state.vendedorBonoToEditId) {
                        await updateDoc(doc(this.state.db, "vendedor_bonos", this.state.vendedorBonoToEditId), bonoData);
                        this.showToast('Asignación modificada con éxito.');
                    } else {
                        bonoData.fechaAsignacion = serverTimestamp();
                        bonoData.deleted = false;
                        await addDoc(collection(this.state.db, "vendedor_bonos"), bonoData);
                        this.showToast('Bonos asignados con éxito.');
                    }
                    this.resetVendedorBonoForm();
                } catch (error) {
                    console.error("Error al guardar asignación:", error);
                    this.showToast('Error al guardar la asignación.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },

            editVendedorBono(bonoId) {
                const bono = this.state.vendedorBonos.find(b => b.id === bonoId);
                if (!bono) return;
                this.state.vendedorBonoToEditId = bonoId;
                document.getElementById('vendedorBonoNombre').value = bono.vendedor;
                document.getElementById('vendedorBonoNro1').value = bono.bonoNro1;
                document.getElementById('vendedorBonoNro2').value = bono.bonoNro2;
                
                this.dom.vendedorBonoFormTitle.textContent = 'Modificar Asignación';
                this.dom.vendedorBonoFormActions.innerHTML = `
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Guardar Cambios</button>
                    <button type="button" onclick="App.resetVendedorBonoForm()" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                `;
                window.scrollTo(0, 0);
            },

            resetVendedorBonoForm() {
                this.dom.vendedorBonoForm.reset();
                this.state.vendedorBonoToEditId = null;
                this.dom.vendedorBonoFormTitle.textContent = 'Nueva Asignación';
                this.dom.vendedorBonoFormActions.innerHTML = `
                    <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-gradient-to-r from-teal-500 to-teal-700 hover:from-teal-600 hover:to-teal-800 rounded-lg">Confirmar Asignación</button>
                `;
            },
            
            updateReportInput() {
                const reportType = this.dom.reportType.value;
                const container = this.dom.reportInputContainer;
                container.innerHTML = '';
                if (reportType === 'vendedor') {
                    container.innerHTML = `
                        <label for="reportVendedorInput" class="block text-sm font-medium text-gray-700">Nombre del Vendedor</label>
                        <input type="text" id="reportVendedorInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Seleccione un vendedor" list="vendedoresList">
                    `;
                } else if (reportType === 'numero') {
                    container.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700">Rango de Números de Bono</label>
                        <div class="flex items-center gap-4 mt-1">
                            <div class="w-1/2">
                                <input type="number" id="reportNumeroInput1" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Desde Nro." oninput="this.value = this.value.slice(0, 3);">
                            </div>
                            <div class="w-1/2">
                                <input type="number" id="reportNumeroInput2" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500" placeholder="Hasta Nro." oninput="this.value = this.value.slice(0, 3);">
                            </div>
                        </div>
                    `;
                }
            },

            handleReportQuery() {
                const reportType = this.dom.reportType.value;
                this.dom.vendedorReportResultContainer.innerHTML = '';
                this.dom.downloadVendedorReportPdfButton.classList.add('hidden');
                this.state.vendedorReportData = null;

                if (reportType === 'vendedor') {
                    const vendedorNombre = document.getElementById('reportVendedorInput').value;
                    if (!vendedorNombre) {
                        this.showToast('Por favor, ingrese un nombre de vendedor.', 'error');
                        return;
                    }
                    this.generateVendedorReport(vendedorNombre);
                } else if (reportType === 'numero') {
                    const numeroDesde = parseInt(document.getElementById('reportNumeroInput1').value, 10);
                    const numeroHasta = parseInt(document.getElementById('reportNumeroInput2').value, 10) || numeroDesde;
                    if (isNaN(numeroDesde)) {
                        this.showToast('Por favor, ingrese al menos el primer número del rango.', 'error');
                        return;
                    }
                    this.findBonoStatusByRange(numeroDesde, numeroHasta);
                }
            },

            generateVendedorReport(vendedorNombre) {
                // 1. Calcular bonos asignados
                const asignaciones = this.state.vendedorBonos.filter(b => b.vendedor === vendedorNombre);
                let totalAsignados = 0;
                asignaciones.forEach(asig => {
                    totalAsignados += (parseInt(asig.bonoNro2) - parseInt(asig.bonoNro1) + 1);
                });

                // 2. Calcular bonos vendidos
                const ventas = [];
                let totalVendidos = 0;
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        if (record.vendedor === vendedorNombre) {
                            const cantidadVendida = (parseInt(record.bonoNro2) - parseInt(record.bonoNro1) + 1);
                            totalVendidos += cantidadVendida;
                            ventas.push({
                                ...record,
                                cantidad: cantidadVendida,
                                fechaVenta: this.formatDateForId(record.fecha)
                            });
                        }
                    });
                });
                
                // Guardar datos para el PDF
                this.state.vendedorReportData = {
                    vendedor: vendedorNombre,
                    totalAsignados,
                    totalVendidos,
                    asignaciones,
                    ventas
                };

                // 3. Mostrar resultados en HTML
                const resultHTML = `
                    <h4 class="text-lg font-bold text-gray-800 mb-3">Reporte para: ${vendedorNombre}</h4>
                    <div class="space-y-2 text-gray-700">
                        <div class="flex justify-between p-2 bg-gray-100 rounded">
                            <span class="font-semibold">Total de Bonos Asignados:</span>
                            <span class="font-bold text-blue-600 text-lg">${totalAsignados}</span>
                        </div>
                        <div class="flex justify-between p-2 bg-gray-100 rounded">
                            <span class="font-semibold">Total de Bonos Vendidos:</span>
                            <span class="font-bold text-green-600 text-lg">${totalVendidos}</span>
                        </div>
                    </div>
                `;
                this.dom.vendedorReportResultContainer.innerHTML = resultHTML;
                this.dom.downloadVendedorReportPdfButton.classList.remove('hidden');
            },

            findBonoStatusByRange(numeroDesde, numeroHasta) {
                let resultHTML = `<h4 class="text-lg font-bold text-gray-800 mb-3">Estado de Bonos N° ${numeroDesde} - ${numeroHasta}</h4>`;
                
                // 1. Find assigned ranges that overlap
                const overlappingAssignments = this.state.vendedorBonos.filter(asig => {
                    const asigDesde = parseInt(asig.bonoNro1, 10);
                    const asigHasta = parseInt(asig.bonoNro2, 10);
                    return Math.max(numeroDesde, asigDesde) <= Math.min(numeroHasta, asigHasta);
                });

                // 2. Find sold ranges that overlap
                const overlappingSales = [];
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        const recDesde = parseInt(record.bonoNro1, 10);
                        const recHasta = parseInt(record.bonoNro2, 10);
                        if (Math.max(numeroDesde, recDesde) <= Math.min(numeroHasta, recHasta)) {
                            overlappingSales.push(record);
                        }
                    });
                });

                if (overlappingAssignments.length === 0 && overlappingSales.length === 0) {
                    resultHTML += '<p class="text-center text-gray-500">No se encontraron asignaciones ni ventas para este rango de bonos.</p>';
                } else {
                    if (overlappingAssignments.length > 0) {
                        resultHTML += '<div class="mb-4"><h5 class="font-semibold text-gray-700">Asignaciones Encontradas:</h5><ul class="list-disc list-inside space-y-1 mt-1">';
                        overlappingAssignments.forEach(asig => {
                            resultHTML += `<li class="text-sm">Rango ${asig.bonoNro1}-${asig.bonoNro2} asignado a <strong>${asig.vendedor}</strong>.</li>`;
                        });
                        resultHTML += '</ul></div>';
                    } else {
                         resultHTML += '<div class="mb-4"><h5 class="font-semibold text-gray-700">Asignaciones Encontradas:</h5><p class="text-sm text-gray-500">Ninguna.</p></div>';
                    }

                    if (overlappingSales.length > 0) {
                        resultHTML += '<div><h5 class="font-semibold text-gray-700">Ventas Encontradas:</h5><ul class="list-disc list-inside space-y-1 mt-1">';
                        overlappingSales.forEach(rec => {
                            resultHTML += `<li class="text-sm">Rango ${rec.bonoNro1}-${rec.bonoNro2} vendido a <strong>${rec.nombre}</strong> por ${rec.vendedor}.</li>`;
                        });
                        resultHTML += '</ul></div>';
                    } else {
                        resultHTML += '<div><h5 class="font-semibold text-gray-700">Ventas Encontradas:</h5><p class="text-sm text-gray-500">Ninguna.</p></div>';
                    }
                }

                this.dom.vendedorReportResultContainer.innerHTML = resultHTML;
                this.dom.downloadVendedorReportPdfButton.classList.add('hidden'); // PDF for range query is not implemented.
            },

            downloadVendedorReportPDF() {
                const data = this.state.vendedorReportData;
                if (!data) {
                    this.showToast('No hay datos de reporte para descargar.', 'error');
                    return;
                }

                const doc = new jsPDF();
                let startY = this.addPdfHeader(doc, `Reporte de Bonos - ${data.vendedor}`);

                // Resumen
                doc.setFontSize(12);
                doc.text('Resumen General', 14, startY);
                doc.autoTable({
                    startY: startY + 5,
                    theme: 'plain',
                    body: [
                        ['Total de Bonos Asignados:', data.totalAsignados.toString()],
                        ['Total de Bonos Vendidos:', data.totalVendidos.toString()],
                    ],
                    columnStyles: { 0: { fontStyle: 'bold' } }
                });
                let finalY = doc.autoTable.previous.finalY;

                // Detalle de Asignaciones
                if (data.asignaciones.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Detalle de Bonos Asignados', 14, finalY + 15);
                    const asignacionesRows = data.asignaciones.map(a => [
                        a.bonoNro1,
                        a.bonoNro2,
                        (parseInt(a.bonoNro2) - parseInt(a.bonoNro1) + 1).toString()
                    ]);
                    doc.autoTable({
                        head: [['Desde Nro.', 'Hasta Nro.', 'Cantidad']],
                        body: asignacionesRows,
                        startY: finalY + 20,
                        theme: 'grid',
                        headStyles: { fillColor: [13, 148, 136] } // Teal color
                    });
                    finalY = doc.autoTable.previous.finalY;
                }

                // Detalle de Ventas
                if (data.ventas.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Detalle de Bonos Vendidos', 14, finalY + 15);
                    const ventasRows = data.ventas.map(v => [
                        v.fechaVenta,
                        v.nombre,
                        `${v.bonoNro1} - ${v.bonoNro2}`,
                        v.cantidad.toString()
                    ]);
                    doc.autoTable({
                        head: [['Fecha Venta', 'Comprador', 'Bonos', 'Cantidad']],
                        body: ventasRows,
                        startY: finalY + 20,
                        theme: 'grid',
                        headStyles: { fillColor: [34, 197, 94] } // Green color
                    });
                }
                
                const currentDate = this.getCurrentDateFormatted();
                doc.save(`reporte_${data.vendedor.replace(/\s/g, '_')}_${currentDate}.pdf`);
            },

            showToast(message, type = 'success') {
                const toastContainer = this.dom.toastContainer;
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);

                try {
                    const synth = new Tone.Synth().toDestination();
                    if (type === 'success') {
                        synth.triggerAttackRelease("C5", "8n", Tone.now());
                    } else if (type === 'error') {
                        synth.triggerAttackRelease("A3", "8n", Tone.now());
                    }
                } catch (e) {
                    console.warn("No se pudo reproducir el sonido, puede requerir interacción del usuario primero.");
                }

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            },

            addPdfHeader(doc, title) {
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text("Parroquia San José Bono", 15, 20);

                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(title, 15, 30);

                doc.setFontSize(10);
                doc.text(this.getCurrentDateFormatted(), doc.internal.pageSize.getWidth() - 15, 20, { align: 'right' });

                doc.setDrawColor(180, 180, 180);
                doc.line(15, 35, doc.internal.pageSize.getWidth() - 15, 35);

                return 45;
            },

            updateDashboard() {
                if (!this.state.isAdmin) {
                    return;
                }

                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                let monthlyIncome = 0;
                this.state.allSessions.forEach(session => {
                    const sessionDate = new Date(session.rawDate);
                    if (sessionDate.getFullYear() === currentYear && sessionDate.getMonth() === currentMonth) {
                        session.records.forEach(record => {
                            monthlyIncome += record.cuotas == 1 ? 15000 : 30000;
                        });
                    }
                });

                let monthlyExpenses = 0;
                this.state.expenses.forEach(expense => {
                    const expenseDate = new Date(expense.date);
                    if (expenseDate.getFullYear() === currentYear && expenseDate.getMonth() === currentMonth) {
                        monthlyExpenses += parseFloat(expense.amount);
                    }
                });

                let totalIncome = 0;
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        totalIncome += record.cuotas == 1 ? 15000 : 30000;
                    });
                }
                );

                let totalExpenses = 0;
                this.state.expenses.forEach(expense => {
                    totalExpenses += parseFloat(expense.amount);
                });

                this.dom.monthlyIncome.textContent = this.formatCurrency(monthlyIncome);
                this.dom.monthlyExpenses.textContent = `-${this.formatCurrency(monthlyExpenses)}`;
                this.dom.totalBalance.textContent = this.formatCurrency(totalIncome - totalExpenses);
            },
            
            updateVendedoresList() {
                const vendedores = new Set();
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        if (record.vendedor) {
                            vendedores.add(record.vendedor);
                        }
                    });
                });
                this.state.vendedorBonos.forEach(bono => {
                    if(bono.vendedor) {
                        vendedores.add(bono.vendedor);
                    }
                });


                this.dom.vendedoresList.innerHTML = '';
                [...vendedores].sort().forEach(vendedor => {
                    const option = document.createElement('option');
                    option.value = vendedor;
                    this.dom.vendedoresList.appendChild(option);
                });
            },

            // --- FUNCIONES DE LA PAPELERA ---

            showRecycleBinScreen() {
                this.renderRecycleBin();
                this.showScreen('recycleBinScreen');
            },

            loadDeletedItemsFromFirestore() {
                if (this.state.unsubscribeDeleted) this.state.unsubscribeDeleted();
                
                const collectionsToWatch = {
                    'sessions': 'session',
                    'bank_deposits': 'deposit',
                    'expenses': 'expense',
                    'vendedor_bonos': 'vendedorBono'
                };
                let allDeletedItems = [];

                const listeners = Object.keys(collectionsToWatch).map(colName => {
                    const q = query(collection(this.state.db, colName), where("deleted", "==", true));
                    return onSnapshot(q, (snapshot) => {
                        const type = collectionsToWatch[colName];
                        const itemsFromCol = snapshot.docs.map(doc => ({
                            id: doc.id,
                            type: type,
                            data: doc.data()
                        }));

                        // Remove old items from this collection and add new ones
                        allDeletedItems = allDeletedItems.filter(item => item.type !== type);
                        allDeletedItems.push(...itemsFromCol);
                        
                        this.state.deletedItems = allDeletedItems.sort((a,b) => b.data.deletedAt.toMillis() - a.data.deletedAt.toMillis());
                        
                        if (this.dom.recycleBinScreen.classList.contains('active-screen')) {
                            this.renderRecycleBin();
                        }
                    });
                });
                
                this.state.unsubscribeDeleted = () => listeners.forEach(unsub => unsub());
            },

            renderRecycleBin() {
                const container = this.dom.recycleBinListContainer;
                container.innerHTML = '';
                if (this.state.deletedItems.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">La papelera está vacía.</p>';
                    return;
                }

                this.state.deletedItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg border';
                    let description = `Elemento borrado`;
                    
                    switch(item.type) {
                        case 'session':
                            description = `Carga del ${item.id.replace(/-/g, '/')}`;
                            break;
                        case 'deposit':
                            description = `Depósito de ${this.formatCurrency(item.data.amount || 0)} del ${this.formatDateForId(item.data.date)}`;
                            break;
                        case 'expense':
                             description = `Egreso: ${item.data.description} por ${this.formatCurrency(item.data.amount || 0)}`;
                            break;
                        case 'vendedorBono':
                             description = `Asignación de bonos ${item.data.bonoNro1}-${item.data.bonoNro2} a ${item.data.vendedor}`;
                            break;
                    }

                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${description}</p>
                            <p class="text-sm text-gray-500">Eliminado: ${this.formatTimestamp(item.data.deletedAt)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.restoreItem('${item.id}', '${item.type}')" class="text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600">Restaurar</button>
                            <button onclick="App.promptDeleteItem('${item.id}', '${item.type}', null, true)" class="text-xs px-2 py-1 bg-red-700 text-white rounded hover:bg-red-800">Eliminar Definitivamente</button>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
            },

            async restoreItem(id, type) {
                this.showLoading(true);
                const collectionName = {
                    'session': 'sessions',
                    'deposit': 'bank_deposits',
                    'expense': 'expenses',
                    'vendedorBono': 'vendedor_bonos'
                }[type];

                if (!collectionName) {
                    this.showToast('Tipo de elemento desconocido.', 'error');
                    this.showLoading(false);
                    return;
                }

                const docRef = doc(this.state.db, collectionName, id);
                try {
                    await updateDoc(docRef, {
                        deleted: false,
                        deletedAt: null
                    });
                    this.showToast('Elemento restaurado con éxito.');
                } catch (error) {
                    console.error("Error al restaurar:", error);
                    this.showToast('Error al restaurar el elemento.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },
             // --- NUEVAS FUNCIONES DE GESTIÓN DE GANADORES ---

            showWinnerScreen() {
                this.dom.winnerResultContainer.innerHTML = '<p class="text-center text-gray-500">Ingrese un número de bono para buscar al ganador.</p>';
                this.dom.winnerForm.reset();
                this.renderPastWinners();
                this.showScreen('winnerScreen');
            },

            loadWinnersFromFirestore() {
                if (this.state.unsubscribeWinners) this.state.unsubscribeWinners();
                const winnersColRef = collection(this.state.db, "winners");
                this.state.unsubscribeWinners = onSnapshot(query(winnersColRef), (snapshot) => {
                    this.state.winnersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.winnersData.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                    if (this.dom.winnerScreen.classList.contains('active-screen')) {
                        this.renderPastWinners();
                    }
                });
            },

            renderPastWinners() {
                const container = this.dom.pastWinnersContainer;
                container.innerHTML = '';
                if (this.state.winnersData.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">Aún no hay ganadores confirmados.</p>';
                    return;
                }
                this.state.winnersData.forEach(winner => {
                    const winnerDiv = document.createElement('div');
                    winnerDiv.className = 'p-3 bg-white rounded-lg border';
                    winnerDiv.innerHTML = `
                        <div>
                            <p class="font-bold text-indigo-700">Ganador: ${winner.nombre}</p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Nº Bono:</span> ${winner.winnerNumber} | <span class="font-semibold">Tel:</span> ${winner.telefono}</p>
                             <p class="text-xs text-gray-500">Confirmado: ${this.formatTimestamp(winner.timestamp)}</p>
                        </div>
                    `;
                    container.appendChild(winnerDiv);
                });
            },
            
            handleFindWinner() {
                const winnerNumberInput = this.dom.winnerNumberInput.value;
                if (!winnerNumberInput) {
                    this.showToast('Por favor, ingrese un número de bono.', 'error');
                    return;
                }
                const winnerNumber = parseInt(winnerNumberInput, 10);
                let foundWinner = null;

                for (const session of this.state.allSessions) {
                    for (const record of session.records) {
                        const bonoNro1 = parseInt(record.bonoNro1, 10);
                        const bonoNro2 = parseInt(record.bonoNro2, 10);
                        if (winnerNumber >= bonoNro1 && winnerNumber <= bonoNro2) {
                            foundWinner = { ...record, winnerNumber: winnerNumber, sessionDate: this.formatDateForId(record.fecha) };
                            break;
                        }
                    }
                    if (foundWinner) break;
                }
                
                this.state.searchResult = foundWinner; // Guardar el resultado para la confirmación
                this.renderWinnerResult(foundWinner);
            },
            
            renderWinnerResult(winnerData) {
                const container = this.dom.winnerResultContainer;
                if (winnerData) {
                    const isAlreadyWinner = this.state.winnersData.some(w => w.winnerNumber === winnerData.winnerNumber);
                    container.innerHTML = `
                        <h4 class="font-bold text-lg text-green-700 mb-2">¡Bono Encontrado!</h4>
                        <p><span class="font-semibold">Número Ganador:</span> ${winnerData.winnerNumber}</p>
                        <p><span class="font-semibold">Comprador:</span> ${winnerData.nombre}</p>
                        <p><span class="font-semibold">Teléfono:</span> ${winnerData.telefono}</p>
                        <p><span class="font-semibold">Vendedor:</span> ${winnerData.vendedor}</p>
                        <p><span class="font-semibold">Fecha de Carga:</span> ${winnerData.sessionDate}</p>
                        ${isAlreadyWinner ?
                            '<p class="mt-4 p-2 bg-yellow-100 text-yellow-800 rounded-md">Este número ya fue registrado como ganador.</p>' :
                            '<button onclick="App.confirmWinner()" class="w-full mt-4 px-4 py-3 font-semibold text-white bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 rounded-lg">Confirmar Ganador</button>'
                        }
                    `;
                } else {
                    container.innerHTML = '<p class="text-center text-red-600 font-semibold">No se encontró ningún comprador para el número de bono ingresado.</p>';
                }
            },

            async confirmWinner() {
                const winnerData = this.state.searchResult;
                if (!winnerData) {
                    this.showToast('No hay un ganador para confirmar.', 'error');
                    return;
                }
                
                const dataToSave = {
                    ...winnerData,
                    timestamp: serverTimestamp()
                };

                this.showLoading(true);
                try {
                    await addDoc(collection(this.state.db, "winners"), dataToSave);
                    this.showToast('Ganador confirmado y guardado.');
                    this.dom.winnerResultContainer.innerHTML = '<p class="text-center text-gray-500">El ganador fue confirmado. Ingrese otro número para buscar.</p>';
                    this.dom.winnerForm.reset();
                } catch(error) {
                    console.error("Error al confirmar el ganador:", error);
                    this.showToast('Error al guardar el ganador.', 'error');
                } finally {
                    this.showLoading(false);
                }
            },
            
             // --- FUNCIONES PARA PDFS ---

            downloadSessionPDF(sessionId) {
                const sessionToDownload = sessionId 
                    ? this.state.allSessions.find(s => s.id === sessionId)
                    : { id: this.formatDateForId(this.state.currentSessionRecords[0].fecha, true), records: this.state.currentSessionRecords };
                
                if (!sessionToDownload || sessionToDownload.records.length === 0) {
                    this.showToast('No hay datos para generar el PDF.', 'error');
                    return;
                }

                const doc = new jsPDF();
                const displayId = sessionToDownload.id.replace(/-/g, '/');
                let startY = this.addPdfHeader(doc, `Detalle de Carga - ${displayId}`);

                let subtotal = 0, totalEfectivo = 0, totalTransferencia = 0;
                const tableRows = sessionToDownload.records.map(record => {
                    const monto = record.cuotas == 1 ? 15000 : 30000;
                    subtotal += monto;
                    if (record.tipoPago === 'Efectivo') totalEfectivo += monto;
                    else totalTransferencia += monto;
                    return [
                        record.nombre,
                        record.telefono,
                        `${record.bonoNro1}-${record.bonoNro2}`,
                        record.vendedor,
                        record.tipoPago,
                        this.formatCurrency(monto)
                    ];
                });

                doc.autoTable({
                    head: [["Nombre", "Teléfono", "Bonos", "Vendedor", "Pago", "Monto"]],
                    body: tableRows,
                    startY: startY,
                    theme: 'grid',
                    headStyles: { fillColor: [67, 56, 202] }
                });

                doc.autoTable({
                    startY: doc.autoTable.previous.finalY + 10,
                    theme: 'plain',
                    body: [
                        ['Subtotal:', this.formatCurrency(subtotal)],
                        ['Total Efectivo:', this.formatCurrency(totalEfectivo)],
                        ['Total Transferencia:', this.formatCurrency(totalTransferencia)]
                    ],
                    columnStyles: { 
                        0: { halign: 'right', fontStyle: 'bold' },
                        1: { halign: 'right' }
                    }
                });

                doc.save(`carga_${sessionToDownload.id}.pdf`);
            },
            
            downloadAllLoadsPDF() {
                const doc = new jsPDF();
                let startY = this.addPdfHeader(doc, "Reporte General de Bonos Vendidos");

                let allRecords = [];
                this.state.allSessions.forEach(session => {
                    session.records.forEach(record => {
                        allRecords.push({
                            ...record,
                            fechaCarga: session.id.replace(/-/g, '/')
                        });
                    });
                });

                if (allRecords.length === 0) {
                    this.showToast('No hay cargas para generar el PDF.', 'error');
                    return;
                }

                const paidTwoInstallments = allRecords.filter(r => r.cuotas === '2');
                const paidOneInstallment = allRecords.filter(r => r.cuotas === '1');

                paidTwoInstallments.sort((a, b) => parseInt(a.bonoNro1, 10) - parseInt(b.bonoNro1, 10));
                paidOneInstallment.sort((a, b) => parseInt(a.bonoNro1, 10) - parseInt(b.bonoNro1, 10));

                const head = [["Bonos", "Nombre", "Teléfono", "Vendedor", "Pago", "Monto", "Fecha de Carga"]];

                if (paidTwoInstallments.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text("Bonos Pagados (2 Cuotas)", 14, startY);
                    startY += 7;

                    const tableRowsTwo = paidTwoInstallments.map(record => {
                        const monto = 30000;
                        return [
                            `${record.bonoNro1}-${record.bonoNro2}`,
                            record.nombre,
                            record.telefono,
                            record.vendedor,
                            record.tipoPago,
                            this.formatCurrency(monto),
                            record.fechaCarga
                        ];
                    });

                    doc.autoTable({
                        head: head,
                        body: tableRowsTwo,
                        startY: startY,
                        theme: 'grid',
                        headStyles: { fillColor: [22, 163, 74] }, // Green color
                        didDrawPage: (data) => {
                            startY = 20;
                        }
                    });
                    startY = doc.autoTable.previous.finalY + 15;
                }

                if (startY > 250) {
                    doc.addPage();
                    startY = 20;
                }

                if (paidOneInstallment.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text("Bonos Pagados (1 Cuota)", 14, startY);
                    startY += 7;

                    const tableRowsOne = paidOneInstallment.map(record => {
                        const monto = 15000;
                        return [
                            `${record.bonoNro1}-${record.bonoNro2}`,
                            record.nombre,
                            record.telefono,
                            record.vendedor,
                            record.tipoPago,
                            this.formatCurrency(monto),
                            record.fechaCarga
                        ];
                    });

                    doc.autoTable({
                        head: head,
                        body: tableRowsOne,
                        startY: startY,
                        theme: 'grid',
                        headStyles: { fillColor: [234, 179, 8] }, // Yellow/Amber color
                        didDrawPage: (data) => {
                            startY = 20;
                        }
                    });
                }

                const currentDate = this.getCurrentDateFormatted();
                doc.save(`reporte_general_bonos_${currentDate}.pdf`);
            },


            // --- FUNCIONES AUXILIARES ---
            formatCurrencyInput(event) {
                const input = event.target;
                let value = input.value.replace(/\./g, '');
                if (isNaN(value) || value === '') {
                    input.value = '';
                    return;
                }
                if (/[^0-9]/.test(value)) {
                    value = value.replace(/[^0-9]/g, '');
                }
                const number = parseInt(value, 10);
                input.value = number.toLocaleString('es-ES');
            },

            getNumericValue(formattedValue) {
                if (!formattedValue || typeof formattedValue !== 'string') return 0;
                const cleanValue = formattedValue.replace(/\./g, '');
                return parseInt(cleanValue, 10) || 0;
            },

            formatCurrency(amount) {
                return amount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            },

            getCurrentDateFormatted() {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                return `${day}-${month}-${year}`;
            },

            formatDateForId(dateString, useSafeFormat = false) {
                if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return dateString;
                const [year, month, day] = dateString.split('-');
                const separator = useSafeFormat ? '-' : '/';
                return `${day}${separator}${month}${separator}${year}`;
            },

            formatTimestamp(timestamp) {
                if (!timestamp || !timestamp.toDate) return 'N/A';
                const date = timestamp.toDate();
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            },

            parseIdToDate(idString) {
                if (!idString || !/^\d{2}[-\/]\d{2}[-\/]\d{4}$/.test(idString)) return idString;
                const parts = idString.split(/[-\/]/);
                return `${parts[2]}-${parts[1]}-${parts[0]}`;
            },
        };

        // Iniciar la aplicación al cargar la ventana
        window.onload = function() {
            window.App.init();
        };

    </script>
</body>
</html>

